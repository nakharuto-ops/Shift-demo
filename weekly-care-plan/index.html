<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    <style>
        :root {
            --primary-white: #ffffff;
            --bg-white: #fcfcfc;
            --light-orange: #fff9f0;
            --soft-orange: #ffedd5;
            --medium-orange: #fed7aa;
            --accent-orange: #fb923c;
            --dark-orange: #ea580c;
            --border-gray: #efefef;
            --text-dark: #4a4a4a;
            --text-gray: #888888;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-white);
            padding: 10px;
            font-size: 14px;
            color: var(--text-dark);
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--primary-white);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: var(--dark-orange);
            text-align: center;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid var(--border-gray);
            padding: 8px;
            vertical-align: top;
        }

        thead th {
            background-color: var(--medium-orange);
            color: var(--text-dark);
            text-align: center;
            font-weight: 600;
        }

        .service-info-cell {
            background-color: var(--light-orange);
            position: relative;
            width: 22%;
        }

        .service-row {
            border: 2px solid var(--accent-orange);
        }

        .service-row td {
            border-color: var(--border-gray);
        }

        .schedule-item input,
        .schedule-item textarea {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 8px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: 6px;
            font-size: 13px;
        }

        .time-range-picker {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
        }

        .time-range-picker input[type="time"] {
            flex-grow: 1;
            padding: 5px;
        }

        /* Laptop Responsive Fix */
        /* Laptop Responsive Fix */
        @media (max-width: 1440px) {

            .schedule-item input,
            .schedule-item textarea {
                font-size: 10px;
                padding: 2px;
                line-height: 1.2;
            }

            .time-range-picker {
                gap: 2px;
            }

            .time-range-picker input[type="time"] {
                padding: 1px;
                font-size: 10px;
                height: 24px;
            }
        }

        .staff-name-display {
            font-weight: bold;
            color: var(--text-dark);
            background-color: var(--soft-orange);
        }

        .service-details .category {
            font-weight: bold;
            color: var(--dark-orange);
            font-size: 1.1em;
        }

        /* ã‚µãƒ¼ãƒ“ã‚¹IDè¡¨ç¤º */
        .service-details .service-id {
            font-size: 0.8em;
            color: var(--text-gray);
            display: block;
            margin-top: 4px;
        }

        /* ã‚µãƒ¼ãƒ“ã‚¹é¸æŠãƒªã‚¹ãƒˆï¼ˆç·¨é›†ãƒ»å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼‰ */
        .service-select-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .service-select-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #fff;
        }

        .service-select-item:hover {
            background-color: var(--soft-orange);
        }

        .service-select-info {
            flex: 1;
        }

        .service-select-name {
            font-weight: bold;
            color: var(--dark-orange);
            font-size: 1em;
        }

        .service-select-id {
            font-size: 0.8em;
            color: var(--text-gray);
            margin-top: 2px;
        }

        .service-select-actions {
            display: flex;
            gap: 8px;
        }

        .service-select-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
        }

        .service-select-actions .edit-btn {
            color: var(--dark-orange);
            border-color: var(--accent-orange);
        }

        .service-select-actions .edit-btn:hover {
            background-color: var(--accent-orange);
            color: white;
        }

        .service-select-actions .delete-btn {
            color: #dc3545;
            border-color: #dc3545;
        }

        .service-select-actions .delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }

        .memo-area {
            margin-top: 15px;
        }

        .memo-area label {
            font-weight: bold;
        }

        .memo-area textarea {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: 5px;
        }

        .staff-icon {
            position: absolute;
            top: 8px;
            right: 50px;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--text-gray);
            user-select: none;
        }

        .instruction-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.85em;
            cursor: pointer;
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            user-select: none;
        }

        .instruction-icon:hover {
            background-color: var(--dark-orange);
        }

        .staff-list {
            display: none;
            position: absolute;
            right: 8px;
            top: 45px;
            background: var(--primary-white);
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            padding: 10px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .staff-list.visible {
            display: block;
        }

        .staff-list .staff {
            background: var(--soft-orange);
            padding: 4px 8px;
            border-radius: 12px;
            margin: 2px;
            display: inline-block;
        }

        .transfer-week-btn {
            background-color: var(--accent-orange);
            color: white;
            width: 100%;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .transfer-week-btn:hover {
            background-color: var(--dark-orange);
        }

        #saveCarePlanBtn {
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        #saveCarePlanBtn:hover {
            background-color: var(--dark-orange);
        }

        #syncShiftsBtn {
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        #syncShiftsBtn:hover {
            background-color: var(--dark-orange);
        }


        .modal-form-group input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-gray);
        }

        #addServiceBtn {
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        #addServiceBtn:hover {
            background-color: var(--dark-orange);
        }

        #addServiceBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #editDeleteServiceBtn {
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        #editDeleteServiceBtn:hover {
            background-color: var(--dark-orange);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            background: var(--primary-white);
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            color: var(--dark-orange);
            margin-top: 0;
        }

        .modal-form-group {
            margin-bottom: 15px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-dark);
            font-weight: 500;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        #modalCancelBtn {
            background-color: var(--border-gray);
            color: var(--text-dark);
        }

        #modalCancelBtn:hover {
            background-color: #ddd;
        }

        #modalSaveBtn {
            background-color: var(--accent-orange);
            color: white;
        }

        #modalSaveBtn:hover {
            background-color: var(--dark-orange);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆé–“ã‚·ãƒ•ãƒˆé¢¨ï¼‰ */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 18px;
            margin: 0;
            color: var(--dark-orange);
        }

        .modal-close-btn {
            font-size: 24px;
            border: none;
            background: none;
            cursor: pointer;
            color: #666;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆæœˆé–“ã‚·ãƒ•ãƒˆé¢¨ï¼‰ */
        .modal-form-group {
            margin-bottom: 15px;
        }

        .modal-form-group>label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .modal-form-group input,
        .modal-form-group textarea,
        .modal-form-group select {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            background-color: #fff;
        }

        .modal-form-group input:focus,
        .modal-form-group select:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.2);
        }

        /* ã‚µãƒ¼ãƒ“ã‚¹é¸æŠãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ©ãƒ™ãƒ«+å¤œæœãƒã‚§ãƒƒã‚¯ã‚’æ¨ªä¸¦ã³ï¼‰ */
        .service-select-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .service-select-header>label:first-child {
            display: block;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .night-check-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none;
        }

        .night-check-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆæœˆé–“ã‚·ãƒ•ãƒˆé¢¨ï¼‰ */
        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .modal-footer button {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .modal-footer button:hover {
            background-color: #f8f9fa;
        }

        .modal-footer .primary-btn {
            background-color: var(--accent-orange);
            color: white;
            border-color: var(--accent-orange);
        }

        .modal-footer .primary-btn:hover {
            background-color: var(--dark-orange);
            border-color: var(--dark-orange);
        }

        .check-items-section {
            margin: 10px 0;
            padding: 10px;
            background-color: var(--bg-white);
            border: 1px solid var(--border-gray);
            border-radius: 6px;
        }

        .check-items-toggle {
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 8px;
        }

        .check-items-toggle:hover {
            background-color: var(--dark-orange);
        }

        .check-items-content {
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .check-items-content.visible {
            display: block;
        }

        .check-category {
            margin-bottom: 12px;
        }

        .check-category-title {
            font-weight: bold;
            color: var(--dark-orange);
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .check-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            padding: 3px;
        }

        .check-item input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }

        .check-item label {
            cursor: pointer;
            font-size: 0.9em;
            user-select: none;
        }

        /* ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰é¸æŠã‚³ãƒ³ãƒ†ãƒŠ - æ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .cascade-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .cascade-select {
            flex: 1;
            min-width: 120px;
            max-width: 200px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-gray);
            font-size: 14px;
            background-color: #fff;
        }

        .cascade-select:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.2);
        }

        /* ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°è¡¨ç¤ºã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºçµ±ä¸€ */
        .service-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .service-details .category {
            font-weight: bold;
            color: var(--dark-orange);
            font-size: 1.1em;
            /* çµ±ä¸€ */
        }

        .service-details .service-name-custom {
            font-weight: bold;
            color: var(--text-dark);
            font-size: 1.1em;
            /* çµ±ä¸€ */
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 id="pageTitle">é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³</h1>
        <div class="controls">
            <div>
                <button id="saveCarePlanBtn">ğŸ’¾ ä¿å­˜</button>
                <button id="syncShiftsBtn">ã‚·ãƒ•ãƒˆã®æ‹…å½“è€…ã‚’åæ˜ </button>
                <button id="addServiceBtn">ï¼‹ ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ </button>
                <button id="editDeleteServiceBtn">âœï¸ ã‚µãƒ¼ãƒ“ã‚¹ã®ç·¨é›†ãƒ»å‰Šé™¤</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th class="service-info-cell">ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</th>
                    <th>æœˆ</th>
                    <th>ç«</th>
                    <th>æ°´</th>
                    <th>æœ¨</th>
                    <th>é‡‘</th>
                    <th>åœŸ</th>
                    <th>æ—¥</th>
                </tr>
            </thead>
            <tbody id="plan-body"></tbody>
        </table>
    </div>

    <div id="addServiceModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ </h2>
                <button type="button" class="modal-close-btn" id="modalCloseBtn">&times;</button>
            </div>
            <form id="addServiceForm">
                <!-- 1æ®µç›®ï¼šã‚µãƒ¼ãƒ“ã‚¹åï¼ˆæ‰‹å…¥åŠ›ï¼‰ -->
                <div class="modal-form-group">
                    <label for="newServiceName">ã‚µãƒ¼ãƒ“ã‚¹å</label>
                    <input type="text" id="newServiceName" placeholder="è‡ªç”±ã«ã‚µãƒ¼ãƒ“ã‚¹åã‚’å…¥åŠ›">
                </div>

                <!-- 2æ®µç›®ï¼šã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ï¼ˆã‚«ã‚¹ã‚±ãƒ¼ãƒ‰é¸æŠï¼‰ -->
                <div class="modal-form-group">
                    <div class="service-select-header">
                        <label>ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</label>
                        <label class="night-check-label" id="nightCheckGroup" style="display:none;">
                            <input type="checkbox" id="nightModeCheckbox">
                            å¤œæœ
                        </label>
                    </div>

                    <!-- ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰é¸æŠã‚’æ¨ªä¸¦ã³ã§ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«é…ç½® -->
                    <div class="cascade-selector-container">
                        <select id="systemSelect" class="cascade-select">
                            <option value="">åˆ¶åº¦</option>
                            <option value="nursing">ä»‹ä¿</option>
                            <option value="disability">éšœæ”¯</option>
                        </select>

                        <select id="nursingTypeSelect" class="cascade-select" style="display:none;">
                            <option value="">ç¨®é¡</option>
                            <option value="care">ä»‹è­·</option>
                            <option value="twoPersonAssist">äºŒäººä»‹åŠ©</option>
                        </select>

                        <select id="timeRangeSelect" class="cascade-select" style="display:none;">
                            <option value="">æ™‚é–“å¸¯</option>
                            <option value="0ã€œ30åˆ†">0ã€œ30åˆ†</option>
                            <option value="30ã€œ60åˆ†">30ã€œ60åˆ†</option>
                            <option value="60ã€œ90åˆ†">60ã€œ90åˆ†</option>
                            <option value="90ã€œ120åˆ†">90ã€œ120åˆ†</option>
                            <option value="120ã€œ150åˆ†">120ã€œ150åˆ†</option>
                            <option value="150ã€œ180åˆ†">150ã€œ180åˆ†</option>
                            <option value="180ã€œ210åˆ†">180ã€œ210åˆ†</option>
                            <option value="210ã€œ240åˆ†">210ã€œ240åˆ†</option>
                            <option value="240ã€œ270åˆ†">240ã€œ270åˆ†</option>
                            <option value="270ã€œ300åˆ†">270ã€œ300åˆ†</option>
                            <option value="300ã€œ330åˆ†">300ã€œ330åˆ†</option>
                            <option value="330ã€œ360åˆ†">330ã€œ360åˆ†</option>
                            <option value="360åˆ†ä»¥ä¸Š">360åˆ†ä»¥ä¸Š</option>
                        </select>

                        <select id="disabilityMainSelect" class="cascade-select" style="display:none;">
                            <option value="">å¤§æ </option>
                            <option value="å±…å®…ä»‹è­·">å±…å®…ä»‹è­·</option>
                            <option value="é‡åº¦è¨ªä»‹">é‡åº¦è¨ªä»‹</option>
                            <option value="åŒè¡Œæ´è­·">åŒè¡Œæ´è­·</option>
                            <option value="äºŒäººä»‹åŠ©ï¼ˆ2äººç›®ï¼‰">äºŒäººä»‹åŠ©ï¼ˆ2äººç›®ï¼‰</option>
                            <option value="ç§»å‹•æ”¯æ´1">ç§»å‹•æ”¯æ´1</option>
                        </select>

                        <select id="finalServiceSelect" class="cascade-select" style="display:none;">
                            <option value="">è©³ç´°</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" id="modalCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" id="modalSaveBtn" class="primary-btn">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="instructionModal" class="modal-overlay">
        <div class="modal-content">
            <h2>ã‚µãƒ¼ãƒ“ã‚¹æä¾›è²¬ä»»è€…ã‹ã‚‰ã®æŒ‡ç¤º</h2>
            <div class="modal-form-group">
                <label for="instructionText">æŒ‡ç¤ºå†…å®¹</label>
                <textarea id="instructionText" rows="8"
                    style="width:100%; box-sizing:border-box; padding:8px; border:1px solid var(--border-gray); border-radius:4px; font-size:0.95rem; font-family:inherit;"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" id="instructionCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="instructionSaveBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ã‚µãƒ¼ãƒ“ã‚¹é¸æŠãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="serviceSelectModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ã‚µãƒ¼ãƒ“ã‚¹ã®ç·¨é›†ãƒ»å‰Šé™¤</h2>
                <button type="button" class="modal-close-btn" id="serviceSelectCloseBtn">&times;</button>
            </div>
            <div class="service-select-list" id="serviceSelectList">
                <!-- ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
            <div class="modal-footer">
                <button type="button" id="serviceSelectCancelBtn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <template id="serviceRowTemplate">
        <tr class="service-row">
            <td class="service-info-cell">
                <div class="service-details">
                    <span class="category">ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥</span>
                    <span class="service-id">ID: </span>
                </div>
                <div class="check-items-section">
                    <button class="check-items-toggle">ãƒã‚§ãƒƒã‚¯é …ç›®è¨­å®š</button>
                    <div class="check-items-content"></div>
                </div>
                <div class="staff-icon">ğŸ‘¤</div>
                <button class="instruction-icon">æŒ‡ç¤º</button>
                <div class="staff-list"><span class="staff">æ‹…å½“A</span><span class="staff">æ‹…å½“B</span></div>
                <div class="memo-area"><label>å‚™è€ƒ</label><textarea rows="3"></textarea></div>
                <button class="transfer-week-btn">é€±é–“ã‚·ãƒ•ãƒˆã¸è»¢è¨˜</button>
            </td>
            <td>
                <div class="schedule-item">
                    <div class="time-range-picker"><input type="time" class="start-time"><span
                            class="time-separator">-</span><input type="time" class="end-time"></div><textarea
                        placeholder="å†…å®¹" rows="2"></textarea><input type="text" class="staff-name-display"
                        placeholder="æ‹…å½“è€…ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ" list="staff-list">
                </div>
            </td>
            <td>
                <div class="schedule-item">
                    <div class="time-range-picker"><input type="time" class="start-time"><span
                            class="time-separator">-</span><input type="time" class="end-time"></div><textarea
                        placeholder="å†…å®¹" rows="2"></textarea><input type="text" class="staff-name-display"
                        placeholder="æ‹…å½“è€…ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ" list="staff-list">
                </div>
            </td>
            <td>
                <div class="schedule-item">
                    <div class="time-range-picker"><input type="time" class="start-time"><span
                            class="time-separator">-</span><input type="time" class="end-time"></div><textarea
                        placeholder="å†…å®¹" rows="2"></textarea><input type="text" class="staff-name-display"
                        placeholder="æ‹…å½“è€…ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ" list="staff-list">
                </div>
            </td>
            <td>
                <div class="schedule-item">
                    <div class="time-range-picker"><input type="time" class="start-time"><span
                            class="time-separator">-</span><input type="time" class="end-time"></div><textarea
                        placeholder="å†…å®¹" rows="2"></textarea><input type="text" class="staff-name-display"
                        placeholder="æ‹…å½“è€…ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ" list="staff-list">
                </div>
            </td>
            <td>
                <div class="schedule-item">
                    <div class="time-range-picker"><input type="time" class="start-time"><span
                            class="time-separator">-</span><input type="time" class="end-time"></div><textarea
                        placeholder="å†…å®¹" rows="2"></textarea><input type="text" class="staff-name-display"
                        placeholder="æ‹…å½“è€…ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ" list="staff-list">
                </div>
            </td>
            <td>
                <div class="schedule-item">
                    <div class="time-range-picker"><input type="time" class="start-time"><span
                            class="time-separator">-</span><input type="time" class="end-time"></div><textarea
                        placeholder="å†…å®¹" rows="2"></textarea><input type="text" class="staff-name-display"
                        placeholder="æ‹…å½“è€…ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ" list="staff-list">
                </div>
            </td>
            <td>
                <div class="schedule-item">
                    <div class="time-range-picker"><input type="time" class="start-time"><span
                            class="time-separator">-</span><input type="time" class="end-time"></div><textarea
                        placeholder="å†…å®¹" rows="2"></textarea><input type="text" class="staff-name-display"
                        placeholder="æ‹…å½“è€…ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ" list="staff-list">
                </div>
            </td>
        </tr>
    </template>

    <!-- æ‹…å½“è€…ãƒªã‚¹ãƒˆç”¨ã®datalist -->
    <datalist id="staff-list"></datalist>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, serverTimestamp, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCs4muRh2x5_vH3Z85rpfYqtMkdHhzdn3g",
            authDomain: "asahi-database.firebaseapp.com",
            projectId: "asahi-database",
            storageBucket: "asahi-database.firebasestorage.app",
            messagingSenderId: "969443002519",
            appId: "1:969443002519:web:357ec84d7b14477b8381d2",
            measurementId: "G-W9HQ8CLH10"
        };

        let db = null;
        try {
            db = getFirestore(initializeApp(firebaseConfig));
            console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ');
        } catch (e) {
            console.warn('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', e);
        }

        // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchStaffList() {
            if (!db) {
                console.warn('Firebaseæœªè¨­å®š');
                return [];
            }

            try {
                console.log('Fetching staff from uses collection...');
                const usesRef = collection(db, 'uses');
                const snap = await getDocs(usesRef);

                console.log(`Found ${snap.docs.length} staff members`);

                const staffList = [];
                snap.docs.forEach(d => {
                    const data = d.data();
                    if (data.name) {
                        staffList.push({
                            id: d.id,
                            name: data.name
                        });
                    }
                });

                console.log('Staff list:', staffList);
                return staffList.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
            } catch (e) {
                console.error('Error fetching staff:', e);
                return [];
            }
        }

        // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’datalistã«è¨­å®š
        function renderStaffDatalist(staffList) {
            const datalist = document.getElementById('staff-list');
            datalist.innerHTML = '';
            staffList.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.name;
                datalist.appendChild(option);
            });
            console.log(`æ‹…å½“è€…ãƒªã‚¹ãƒˆã«${staffList.length}åã‚’è¨­å®šã—ã¾ã—ãŸ`);
        }

        // é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        async function saveCarePlan(userId, carePlanData) {
            if (!db) {
                throw new Error('Firebaseæœªè¨­å®š');
            }

            try {
                console.log('=== é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ä¿å­˜é–‹å§‹ ===');
                console.log('åˆ©ç”¨è€…ID:', userId);
                console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', carePlanData);

                // riyousya/{userId} ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® carePlan ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜
                const userDocRef = doc(db, 'riyousya', userId);

                // carePlan ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                const carePlanToSave = {
                    services: carePlanData.services || [],
                    instructions: carePlanData.instructions || '',
                    lastUpdated: serverTimestamp(),
                    updatedBy: 'system'
                };

                console.log('ä¿å­˜ã™ã‚‹carePlan:', carePlanToSave);

                // Firestoreã«ä¿å­˜ï¼ˆãƒãƒ¼ã‚¸ï¼‰
                await setDoc(userDocRef, {
                    carePlan: carePlanToSave
                }, { merge: true });

                console.log('âœ… é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã‚’ riyousya/' + userId + '/carePlan ã«ä¿å­˜ã—ã¾ã—ãŸ');

                // é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆï¼ˆweeklyShiftMagnetsï¼‰ã«ã‚‚ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                await saveToWeeklyShiftMagnets(userId, carePlanData);

                console.log('=== é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ä¿å­˜å®Œäº† ===');
                return true;
            } catch (e) {
                console.error('âŒ é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                throw e;
            }
        }

        // é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã«ã‚‚ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        async function saveToWeeklyShiftMagnets(userId, carePlanData) {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
                const userDocRef = doc(db, 'riyousya', userId);
                const userDoc = await getDoc(userDocRef);
                const userName = userDoc.exists() ? (userDoc.data().name || userId) : userId;
                console.log('weeklyShiftMagnetsä¿å­˜ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', userName);

                // æ›œæ—¥ãƒãƒƒãƒ”ãƒ³ã‚°
                const dayMapping = {
                    'mon': 'Monday',
                    'tue': 'Tuesday',
                    'wed': 'Wednesday',
                    'thu': 'Thursday',
                    'fri': 'Friday',
                    'sat': 'Saturday',
                    'sun': 'Sunday'
                };

                const dayJPMapping = {
                    'Monday': 'æœˆ',
                    'Tuesday': 'ç«',
                    'Wednesday': 'æ°´',
                    'Thursday': 'æœ¨',
                    'Friday': 'é‡‘',
                    'Saturday': 'åœŸ',
                    'Sunday': 'æ—¥'
                };

                const magnetsRef = collection(db, 'weeklyShiftMagnets');

                // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒãƒ¼ã‚¸ã™ã‚‹ãŸã‚ï¼‰
                const existingDataPromises = Object.keys(dayMapping).map(async (dayKey) => {
                    const dayEN = dayMapping[dayKey];
                    const dayDocRef = doc(magnetsRef, dayEN);
                    const dayDoc = await getDoc(dayDocRef);
                    return {
                        dayEN: dayEN,
                        dayJP: dayJPMapping[dayEN],
                        data: dayDoc.exists() ? dayDoc.data() : { day: dayJPMapping[dayEN], magnets: [], cellStates: {} }
                    };
                });

                const existingData = await Promise.all(existingDataPromises);

                // ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æ›œæ—¥ã”ã¨ã®ãƒã‚°ãƒãƒƒãƒˆã«å¤‰æ›
                const services = carePlanData.services || [];

                // æ—¢å­˜ã®ãƒã‚°ãƒãƒƒãƒˆã‚’ä¿æŒã—ã€userId ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã¯å‰Šé™¤ï¼ˆä¸Šæ›¸ãç”¨ï¼‰
                existingData.forEach(dayData => {
                    dayData.data.magnets = (dayData.data.magnets || []).filter(m => m.userId !== userId);
                });

                services.forEach(service => {
                    const schedule = service.schedule || {};

                    Object.keys(schedule).forEach(dayKey => {
                        const dayEN = dayMapping[dayKey];
                        if (!dayEN) return;

                        const daySchedule = schedule[dayKey];
                        if (!daySchedule.startTime || !daySchedule.endTime) return;

                        const magnetData = {
                            id: 'magnet-' + userId + '-' + service.id + '-' + dayKey,
                            userId: userId,
                            userName: userName,
                            serviceType: service.type || '',
                            startTime: daySchedule.startTime,
                            endTime: daySchedule.endTime,
                            time: daySchedule.startTime + '-' + daySchedule.endTime,
                            staff: daySchedule.staff || ''
                        };

                        // å¯¾å¿œã™ã‚‹æ›œæ—¥ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã¤ã‘ã¦è¿½åŠ 
                        const targetDay = existingData.find(d => d.dayEN === dayEN);
                        if (targetDay) {
                            targetDay.data.magnets.push(magnetData);
                        }
                    });
                });

                // å„æ›œæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const savePromises = existingData.map(dayData => {
                    const dayDocRef = doc(magnetsRef, dayData.dayEN);
                    return setDoc(dayDocRef, dayData.data);
                });

                await Promise.all(savePromises);

                console.log('é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã‚’ weeklyShiftMagnets ã«ã‚‚ä¿å­˜ã—ã¾ã—ãŸï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰');
            } catch (e) {
                console.error('weeklyShiftMagnetsã¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶šè¡Œ
            }
        }

        // é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadCarePlan(userId) {
            if (!db) {
                throw new Error('Firebaseæœªè¨­å®š');
            }

            try {
                console.log('=== é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³èª­ã¿è¾¼ã¿é–‹å§‹ ===');
                console.log('åˆ©ç”¨è€…ID:', userId);

                // riyousya/{userId} ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ carePlan ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
                const userDocRef = doc(db, 'riyousya', userId);
                console.log('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¹:', 'riyousya/' + userId);

                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    console.log('âŒ åˆ©ç”¨è€…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚');
                    return null;
                }

                console.log('âœ… åˆ©ç”¨è€…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸ');
                const userData = userDoc.data();
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼:', Object.keys(userData));

                // carePlan ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚€
                const carePlanData = userData.carePlan || null;
                console.log('carePlanãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', carePlanData);

                if (!carePlanData || !carePlanData.services || carePlanData.services.length === 0) {
                    console.log('âŒ carePlan.servicesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚');
                    return null;
                }

                // carePlan ã‹ã‚‰ services ã¨ instructions ã‚’å–å¾—
                const services = carePlanData.services || [];
                const instructions = carePlanData.instructions || '';

                console.log('=== carePlan.services ã®å†…å®¹ ===');
                console.log('ã‚µãƒ¼ãƒ“ã‚¹æ•°:', services.length);
                services.forEach((service, index) => {
                    console.log(`ã‚µãƒ¼ãƒ“ã‚¹ ${index + 1}:`, service);
                    console.log(`  - ID: ${service.id}`);
                    console.log(`  - ã‚¿ã‚¤ãƒ—: ${service.type}`);
                    console.log(`  - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:`, service.schedule);
                    console.log(`  - ãƒã‚§ãƒƒã‚¯é …ç›®æ•°: ${(service.checkItems || []).length}`);
                    console.log(`  - ãƒ¡ãƒ¢: ${service.memo || '(ãªã—)'}`);
                });

                console.log('instructionsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', instructions);
                console.log('=== é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³èª­ã¿è¾¼ã¿å®Œäº† ===');

                return {
                    services: services,
                    instructions: instructions
                };
            } catch (e) {
                console.error('âŒ é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                throw e;
            }
        }

        // é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        async function saveWeeklyShiftMagnets(magnets) {
            if (!db) {
                throw new Error('Firebaseæœªè¨­å®š');
            }

            try {
                console.log('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã‚’ä¿å­˜ä¸­...', magnets);
                const magnetsRef = collection(db, 'weeklyShiftMagnets');

                // æ—¢å­˜ã®ãƒã‚°ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ã€é‡è¤‡ã‚’é¿ã‘ã‚‹
                const promises = magnets.map(async (magnet) => {
                    const magnetDocRef = doc(magnetsRef, magnet.id);
                    const existingDoc = await getDoc(magnetDocRef);

                    if (!existingDoc.exists()) {
                        await setDoc(magnetDocRef, {
                            ...magnet,
                            createdAt: serverTimestamp()
                        });
                        return true;
                    }
                    return false;
                });

                const results = await Promise.all(promises);
                const savedCount = results.filter(r => r).length;
                console.log(`${savedCount}ä»¶ã®é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                return savedCount;
            } catch (e) {
                console.error('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                throw e;
            }
        }

        // é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadWeeklyShiftMagnets(userId = null) {
            if (!db) {
                throw new Error('Firebaseæœªè¨­å®š');
            }

            try {
                console.log('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const magnetsRef = collection(db, 'weeklyShiftMagnets');

                let magnetsQuery;
                if (userId) {
                    magnetsQuery = query(magnetsRef, where('userId', '==', userId));
                } else {
                    magnetsQuery = magnetsRef;
                }

                const snap = await getDocs(magnetsQuery);
                const magnets = [];
                snap.forEach(doc => {
                    magnets.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`${magnets.length}ä»¶ã®é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                return magnets;
            } catch (e) {
                console.error('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                throw e;
            }
        }

        // é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        async function saveWeeklyShiftMagnetMap(userId, magnetMap) {
            if (!db) {
                throw new Error('Firebaseæœªè¨­å®š');
            }

            try {
                console.log('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¿å­˜ä¸­...', userId);
                const dataDocRef = doc(db, 'riyousya', 'data');
                const userDocRef = doc(collection(dataDocRef, 'users'), userId);

                await setDoc(userDocRef, {
                    weeklyMagnetMap: magnetMap,
                    weeklyMagnetMapUpdated: serverTimestamp()
                }, { merge: true });

                console.log('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                return true;
            } catch (e) {
                console.error('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                throw e;
            }
        }

        // é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadWeeklyShiftMagnetMap(userId) {
            if (!db) {
                throw new Error('Firebaseæœªè¨­å®š');
            }

            try {
                console.log('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...', userId);
                const dataDocRef = doc(db, 'riyousya', 'data');
                const userDocRef = doc(collection(dataDocRef, 'users'), userId);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().weeklyMagnetMap) {
                    console.log('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    return userDoc.data().weeklyMagnetMap;
                } else {
                    console.log('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return {};
                }
            } catch (e) {
                console.error('é€±é–“ã‚·ãƒ•ãƒˆãƒã‚°ãƒãƒƒãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                throw e;
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.firebaseStaff = { fetchStaffList, renderStaffDatalist };
        window.firebaseCarePlan = { saveCarePlan, loadCarePlan };
        window.firebaseWeeklyShift = {
            saveWeeklyShiftMagnets,
            loadWeeklyShiftMagnets,
            saveWeeklyShiftMagnetMap,
            loadWeeklyShiftMagnetMap
        };

        // Expose Firebase modules for handleWeeklyTransfer
        window.firebaseDB = db;
        window.firebaseModules = {
            collection,
            doc,
            getDoc,
            setDoc,
            serverTimestamp
        };
    </script>

    <!-- ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰é¸æŠãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // ===== ä»‹ä¿ãƒ»ä»‹è­·ã®æ™‚é–“å¸¯åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ãƒ¼ã‚¿ =====
        const NURSING_CARE_SERVICES_BY_TIME = {
            '0ã€œ30åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©2', code: '117211' },
                { name: 'èº«ä½“01ç”Ÿæ´»1', code: '114145' },
                { name: 'èº«ä½“02ç”Ÿæ´»1', code: '114601' },
                { name: 'èº«ä½“ä»‹è­·01', code: '114845' },
                { name: 'èº«ä½“ä»‹è­·02', code: '114551' },
                { name: 'èº«ä½“ä»‹è­·1', code: '111111' }
            ],
            '30ã€œ60åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©2', code: '117211' },
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“01ç”Ÿæ´»1', code: '114145' },
                { name: 'èº«ä½“01ç”Ÿæ´»2', code: '114169' },
                { name: 'èº«ä½“02ç”Ÿæ´»1', code: '114601' },
                { name: 'èº«ä½“02ç”Ÿæ´»2', code: '114646' },
                { name: 'èº«ä½“ä»‹è­·1', code: '111111' },
                { name: 'èº«ä½“ä»‹è­·2', code: '111211' }
            ],
            '60ã€œ90åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©2', code: '117211' },
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“01ç”Ÿæ´»1', code: '114145' },
                { name: 'èº«ä½“01ç”Ÿæ´»2', code: '114169' },
                { name: 'èº«ä½“01ç”Ÿæ´»3', code: '114193' },
                { name: 'èº«ä½“02ç”Ÿæ´»1', code: '114601' },
                { name: 'èº«ä½“02ç”Ÿæ´»2', code: '114646' },
                { name: 'èº«ä½“02ç”Ÿæ´»3', code: '114658' },
                { name: 'èº«ä½“1ç”Ÿæ´»1', code: '114111' },
                { name: 'èº«ä½“1ç”Ÿæ´»2', code: '114211' },
                { name: 'èº«ä½“ä»‹è­·2', code: '111211' },
                { name: 'èº«ä½“ä»‹è­·3', code: '111311' }
            ],
            '90ã€œ120åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“01ç”Ÿæ´»2', code: '114169' },
                { name: 'èº«ä½“01ç”Ÿæ´»3', code: '114193' },
                { name: 'èº«ä½“02ç”Ÿæ´»2', code: '114646' },
                { name: 'èº«ä½“02ç”Ÿæ´»3', code: '114658' },
                { name: 'èº«ä½“1ç”Ÿæ´»1', code: '114111' },
                { name: 'èº«ä½“1ç”Ÿæ´»2', code: '114211' },
                { name: 'èº«ä½“1ç”Ÿæ´»3', code: '114311' },
                { name: 'èº«ä½“2ç”Ÿæ´»1', code: '115111' },
                { name: 'èº«ä½“2ç”Ÿæ´»2', code: '115211' },
                { name: 'èº«ä½“ä»‹è­·3', code: '111311' },
                { name: 'èº«ä½“ä»‹è­·4', code: '111411' }
            ],
            '120ã€œ150åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“01ç”Ÿæ´»3', code: '114193' },
                { name: 'èº«ä½“02ç”Ÿæ´»3', code: '114658' },
                { name: 'èº«ä½“1ç”Ÿæ´»2', code: '114211' },
                { name: 'èº«ä½“1ç”Ÿæ´»3', code: '114311' },
                { name: 'èº«ä½“2ç”Ÿæ´»1', code: '115111' },
                { name: 'èº«ä½“2ç”Ÿæ´»2', code: '115211' },
                { name: 'èº«ä½“2ç”Ÿæ´»3', code: '115311' },
                { name: 'èº«ä½“3ç”Ÿæ´»1', code: '116111' },
                { name: 'èº«ä½“3ç”Ÿæ´»2', code: '116123' },
                { name: 'èº«ä½“ä»‹è­·4', code: '111411' },
                { name: 'èº«ä½“ä»‹è­·5', code: '111511' }
            ],
            '150ã€œ180åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“1ç”Ÿæ´»3', code: '114311' },
                { name: 'èº«ä½“2ç”Ÿæ´»1', code: '115111' },
                { name: 'èº«ä½“2ç”Ÿæ´»2', code: '115211' },
                { name: 'èº«ä½“2ç”Ÿæ´»3', code: '115311' },
                { name: 'èº«ä½“3ç”Ÿæ´»1', code: '116111' },
                { name: 'èº«ä½“3ç”Ÿæ´»2', code: '116123' },
                { name: 'èº«ä½“3ç”Ÿæ´»3', code: '116135' },
                { name: 'èº«ä½“4ç”Ÿæ´»1', code: '116211' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“ä»‹è­·5', code: '111511' },
                { name: 'èº«ä½“ä»‹è­·6', code: '111611' }
            ],
            '180ã€œ210åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“2ç”Ÿæ´»2', code: '115211' },
                { name: 'èº«ä½“2ç”Ÿæ´»3', code: '115311' },
                { name: 'èº«ä½“3ç”Ÿæ´»1', code: '116111' },
                { name: 'èº«ä½“3ç”Ÿæ´»2', code: '116123' },
                { name: 'èº«ä½“3ç”Ÿæ´»3', code: '116135' },
                { name: 'èº«ä½“4ç”Ÿæ´»1', code: '116211' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“4ç”Ÿæ´»3', code: '116235' },
                { name: 'èº«ä½“5ç”Ÿæ´»1', code: '116311' },
                { name: 'èº«ä½“5ç”Ÿæ´»2', code: '116323' },
                { name: 'èº«ä½“ä»‹è­·6', code: '111611' },
                { name: 'èº«ä½“ä»‹è­·7', code: '111711' }
            ],
            '210ã€œ240åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“2ç”Ÿæ´»3', code: '115311' },
                { name: 'èº«ä½“3ç”Ÿæ´»1', code: '116111' },
                { name: 'èº«ä½“3ç”Ÿæ´»2', code: '116123' },
                { name: 'èº«ä½“3ç”Ÿæ´»3', code: '116135' },
                { name: 'èº«ä½“4ç”Ÿæ´»1', code: '116211' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“4ç”Ÿæ´»3', code: '116235' },
                { name: 'èº«ä½“5ç”Ÿæ´»1', code: '116311' },
                { name: 'èº«ä½“5ç”Ÿæ´»2', code: '116323' },
                { name: 'èº«ä½“5ç”Ÿæ´»3', code: '116335' },
                { name: 'èº«ä½“6ç”Ÿæ´»1', code: '116411' },
                { name: 'èº«ä½“ä»‹è­·7', code: '111711' },
                { name: 'èº«ä½“ä»‹è­·8', code: '111811' }
            ],
            '240ã€œ270åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“3ç”Ÿæ´»1', code: '116111' },
                { name: 'èº«ä½“3ç”Ÿæ´»2', code: '116123' },
                { name: 'èº«ä½“3ç”Ÿæ´»3', code: '116135' },
                { name: 'èº«ä½“4ç”Ÿæ´»1', code: '116211' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“4ç”Ÿæ´»3', code: '116235' },
                { name: 'èº«ä½“5ç”Ÿæ´»1', code: '116311' },
                { name: 'èº«ä½“5ç”Ÿæ´»2', code: '116323' },
                { name: 'èº«ä½“5ç”Ÿæ´»3', code: '116335' },
                { name: 'èº«ä½“6ç”Ÿæ´»1', code: '116411' },
                { name: 'èº«ä½“6ç”Ÿæ´»2', code: '116423' },
                { name: 'èº«ä½“7ç”Ÿæ´»1', code: '116511' },
                { name: 'èº«ä½“ä»‹è­·8', code: '111811' },
                { name: 'èº«ä½“ä»‹è­·9', code: '111911' }
            ],
            '270ã€œ300åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“3ç”Ÿæ´»2', code: '116123' },
                { name: 'èº«ä½“3ç”Ÿæ´»3', code: '116135' },
                { name: 'èº«ä½“4ç”Ÿæ´»1', code: '116211' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“4ç”Ÿæ´»3', code: '116235' },
                { name: 'èº«ä½“5ç”Ÿæ´»1', code: '116311' },
                { name: 'èº«ä½“5ç”Ÿæ´»2', code: '116323' },
                { name: 'èº«ä½“5ç”Ÿæ´»3', code: '116335' },
                { name: 'èº«ä½“6ç”Ÿæ´»1', code: '116411' },
                { name: 'èº«ä½“6ç”Ÿæ´»2', code: '116423' },
                { name: 'èº«ä½“6ç”Ÿæ´»3', code: '116435' },
                { name: 'èº«ä½“7ç”Ÿæ´»1', code: '116511' },
                { name: 'èº«ä½“7ç”Ÿæ´»2', code: '116523' },
                { name: 'èº«ä½“ä»‹è­·9', code: '111911' }
            ],
            '300ã€œ330åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“3ç”Ÿæ´»3', code: '116135' },
                { name: 'èº«ä½“4ç”Ÿæ´»1', code: '116211' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“4ç”Ÿæ´»3', code: '116235' },
                { name: 'èº«ä½“5ç”Ÿæ´»1', code: '116311' },
                { name: 'èº«ä½“5ç”Ÿæ´»2', code: '116323' },
                { name: 'èº«ä½“5ç”Ÿæ´»3', code: '116335' },
                { name: 'èº«ä½“6ç”Ÿæ´»1', code: '116411' },
                { name: 'èº«ä½“6ç”Ÿæ´»2', code: '116423' },
                { name: 'èº«ä½“6ç”Ÿæ´»3', code: '116435' },
                { name: 'èº«ä½“7ç”Ÿæ´»1', code: '116511' },
                { name: 'èº«ä½“7ç”Ÿæ´»2', code: '116523' },
                { name: 'èº«ä½“7ç”Ÿæ´»3', code: '116535' },
                { name: 'èº«ä½“8ç”Ÿæ´»1', code: '116611' },
                { name: 'èº«ä½“ä»‹è­·9', code: '111911' }
            ],
            '330ã€œ360åˆ†': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“4ç”Ÿæ´»1', code: '116211' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“4ç”Ÿæ´»3', code: '116235' },
                { name: 'èº«ä½“5ç”Ÿæ´»1', code: '116311' },
                { name: 'èº«ä½“5ç”Ÿæ´»2', code: '116323' },
                { name: 'èº«ä½“5ç”Ÿæ´»3', code: '116335' },
                { name: 'èº«ä½“6ç”Ÿæ´»1', code: '116411' },
                { name: 'èº«ä½“6ç”Ÿæ´»2', code: '116423' },
                { name: 'èº«ä½“6ç”Ÿæ´»3', code: '116435' },
                { name: 'èº«ä½“7ç”Ÿæ´»1', code: '116511' },
                { name: 'èº«ä½“7ç”Ÿæ´»2', code: '116523' },
                { name: 'èº«ä½“7ç”Ÿæ´»3', code: '116535' },
                { name: 'èº«ä½“8ç”Ÿæ´»1', code: '116611' },
                { name: 'èº«ä½“8ç”Ÿæ´»2', code: '116623' },
                { name: 'èº«ä½“ä»‹è­·9', code: '111911' }
            ],
            '360åˆ†ä»¥ä¸Š': [
                { name: 'ç”Ÿæ´»æ´åŠ©3', code: '117311' },
                { name: 'èº«ä½“4ç”Ÿæ´»2', code: '116223' },
                { name: 'èº«ä½“4ç”Ÿæ´»3', code: '116235' },
                { name: 'èº«ä½“5ç”Ÿæ´»1', code: '116311' },
                { name: 'èº«ä½“5ç”Ÿæ´»2', code: '116323' },
                { name: 'èº«ä½“5ç”Ÿæ´»3', code: '116335' },
                { name: 'èº«ä½“6ç”Ÿæ´»1', code: '116411' },
                { name: 'èº«ä½“6ç”Ÿæ´»2', code: '116423' },
                { name: 'èº«ä½“6ç”Ÿæ´»3', code: '116435' },
                { name: 'èº«ä½“7ç”Ÿæ´»1', code: '116511' },
                { name: 'èº«ä½“7ç”Ÿæ´»2', code: '116523' },
                { name: 'èº«ä½“7ç”Ÿæ´»3', code: '116535' },
                { name: 'èº«ä½“8ç”Ÿæ´»1', code: '116611' },
                { name: 'èº«ä½“8ç”Ÿæ´»2', code: '116623' },
                { name: 'èº«ä½“8ç”Ÿæ´»3', code: '116635' },
                { name: 'èº«ä½“9ç”Ÿæ´»1', code: '116711' },
                { name: 'èº«ä½“9ç”Ÿæ´»2', code: '116723' },
                { name: 'èº«ä½“9ç”Ÿæ´»3', code: '116735' }
            ]
        };

        // ===== éšœæ”¯ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ãƒ¼ã‚¿ =====
        const DISABILITY_SERVICES = {
            'å±…å®…ä»‹è­·': {
                'å±…å®…èº«ä½“ä»‹è­·': '111000',
                'å±…å®…å®¶äº‹æ´åŠ©': '112000',
                'é€šé™¢ä»‹åŠ©ï¼ˆèº«ä½“ä»‹è­·ã‚ã‚Šï¼‰': '113000',
                'é€šé™¢ä»‹åŠ©ï¼ˆèº«ä½“ä»‹è­·ãªã—ï¼‰': '114000'
            },
            'é‡åº¦è¨ªä»‹': {
                'é‡åº¦è¨ªå•ä»‹è­·â… ': '121000',
                'é‡åº¦è¨ªå•ä»‹è­·â…¡': '122000',
                'é‡åº¦è¨ªå•ä»‹è­·â…¢': '123000'
            },
            'åŒè¡Œæ´è­·': {
                'åŒè¡Œæ´è­·': '153000'
            },
            'äºŒäººä»‹åŠ©ï¼ˆ2äººç›®ï¼‰': {
                '2äººä»‹åŠ©ï¼ˆ2äººç›®ï¼‰': 'DK0001'
            },
            'ç§»å‹•æ”¯æ´1': {
                'ç§»å‹•æ”¯æ´': 'A11000'
            }
        };

        // ===== å¤œæœã‚³ãƒ¼ãƒ‰å¤‰æ›é–¢æ•° =====
        function convertToNightCode(code) {
            if (code.length < 2) return code;

            const base = code.slice(0, -2);
            const last = code.slice(-2);

            // ã‚³ãƒ¼ãƒ‰å¤‰æ›ãƒ«ãƒ¼ãƒ«ï¼ˆæœˆé–“ã‚·ãƒ•ãƒˆã«æº–æ‹ ï¼‰
            const conversionMap = {
                '11': '12',
                '23': '24',
                '35': '36',
                '45': '46',
                '69': '70',
                '93': '94',
                '01': '02',
                '46': '47',
                '58': '59'
            };

            const converted = conversionMap[last];
            return converted ? base + converted : code;
        }

        // ===== ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰é¸æŠãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ¨ªä¸¦ã³å¯¾å¿œç‰ˆï¼‰ =====
        document.addEventListener('DOMContentLoaded', function () {
            const systemSelect = document.getElementById('systemSelect');
            const nursingTypeSelect = document.getElementById('nursingTypeSelect');
            const timeRangeSelect = document.getElementById('timeRangeSelect');
            const disabilityMainSelect = document.getElementById('disabilityMainSelect');
            const finalServiceSelect = document.getElementById('finalServiceSelect');
            const nightCheckbox = document.getElementById('nightModeCheckbox');
            const nightCheckGroup = document.getElementById('nightCheckGroup');

            // ã‚¹ãƒ†ãƒƒãƒ—1ï¼šåˆ¶åº¦é¸æŠ
            systemSelect.addEventListener('change', function () {
                resetAllSelections();

                if (this.value === 'nursing') {
                    nursingTypeSelect.style.display = 'inline-block';
                } else if (this.value === 'disability') {
                    disabilityMainSelect.style.display = 'inline-block';
                }
            });

            // ã‚¹ãƒ†ãƒƒãƒ—2-Aï¼šä»‹ä¿ - ç¨®é¡é¸æŠ
            nursingTypeSelect.addEventListener('change', function () {
                timeRangeSelect.style.display = 'none';
                finalServiceSelect.style.display = 'none';
                nightCheckGroup.style.display = 'none';
                finalServiceSelect.innerHTML = '<option value="">è©³ç´°</option>';

                if (this.value === 'care') {
                    timeRangeSelect.style.display = 'inline-block';
                    nightCheckGroup.style.display = 'flex';
                } else if (this.value === 'twoPersonAssist') {
                    // äºŒäººä»‹åŠ©ã®å ´åˆã¯ç›´æ¥ã‚µãƒ¼ãƒ“ã‚¹è¡¨ç¤º
                    const option = document.createElement('option');
                    option.value = 'DK0001';
                    option.textContent = 'äºŒäººä»‹åŠ©ï¼ˆ2äººç›®ï¼‰';
                    option.dataset.serviceName = 'äºŒäººä»‹åŠ©ï¼ˆ2äººç›®ï¼‰';
                    finalServiceSelect.appendChild(option);
                    finalServiceSelect.value = 'DK0001';
                    finalServiceSelect.style.display = 'inline-block';
                }
            });

            // ã‚¹ãƒ†ãƒƒãƒ—2-A-1ï¼šä»‹è­· - æ™‚é–“å¸¯é¸æŠ
            timeRangeSelect.addEventListener('change', function () {
                if (this.value) {
                    updateServicesByTimeRange(this.value);
                    finalServiceSelect.style.display = 'inline-block';
                }
            });

            // å¤œæœãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚
            nightCheckbox.addEventListener('change', function () {
                const timeRange = timeRangeSelect.value;
                if (timeRange) {
                    updateServicesByTimeRange(timeRange);
                }
            });

            // ã‚¹ãƒ†ãƒƒãƒ—2-Bï¼šéšœæ”¯ - å¤§æ é¸æŠ
            disabilityMainSelect.addEventListener('change', function () {
                if (this.value) {
                    updateDisabilityServices(this.value);
                    finalServiceSelect.style.display = 'inline-block';
                }
            });

            // æ™‚é–“å¸¯ã«å¿œã˜ãŸã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°
            function updateServicesByTimeRange(timeRange) {
                const services = NURSING_CARE_SERVICES_BY_TIME[timeRange] || [];
                const isNight = nightCheckbox.checked;

                finalServiceSelect.innerHTML = '<option value="">è©³ç´°</option>';

                services.forEach(service => {
                    const code = isNight ? convertToNightCode(service.code) : service.code;
                    const name = isNight ? service.name + 'ãƒ»å¤œ' : service.name;

                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    option.dataset.serviceName = name;
                    finalServiceSelect.appendChild(option);
                });
            }

            // éšœæ”¯ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°
            function updateDisabilityServices(mainCategory) {
                const services = DISABILITY_SERVICES[mainCategory] || {};

                finalServiceSelect.innerHTML = '<option value="">è©³ç´°</option>';

                for (const [name, code] of Object.entries(services)) {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    option.dataset.serviceName = name;
                    finalServiceSelect.appendChild(option);
                }
            }

            // å…¨é¸æŠãƒªã‚»ãƒƒãƒˆ
            function resetAllSelections() {
                nursingTypeSelect.style.display = 'none';
                timeRangeSelect.style.display = 'none';
                disabilityMainSelect.style.display = 'none';
                finalServiceSelect.style.display = 'none';
                nightCheckGroup.style.display = 'none';

                nursingTypeSelect.value = '';
                timeRangeSelect.value = '';
                disabilityMainSelect.value = '';
                finalServiceSelect.innerHTML = '<option value="">è©³ç´°</option>';
                nightCheckbox.checked = false;
            }

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
            window.cascadeServiceSelector = {
                resetAllSelections
            };
        });
    </script>

    <script>
        // ã‚µãƒ¼ãƒ“ã‚¹é …ç›®ã®ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆã‚µãƒ¼ãƒ“ã‚¹è¨˜éŒ²ç”»é¢ã¨å®Œå…¨ä¸€è‡´ï¼‰
        const serviceItemsData = {
            'èº«ä½“': {
                'æ’æ³„': ['ç¢ºèª', 'ãƒˆã‚¤ãƒ¬ä»‹åŠ©', 'Pãƒˆã‚¤ãƒ¬ä»‹åŠ©', 'ãŠã‚€ã¤äº¤æ›', 'ãƒ‘ãƒƒãƒ‰äº¤æ›', 'æ±šã‚ŒãŸè¡£æœã‚„ãƒªãƒãƒ³ç­‰ã®äº¤æ›å‡¦ç†', 'é™°éƒ¨ãƒ»è‡€éƒ¨ã®æ¸…æ‹­ãƒ»æ´—æµ„', 'æ’å°¿ãƒ»å°¿å‡¦ç†ï¼ˆã€€ï¼‰å›ã€€ï¼ˆã€€ï¼‰ã„', 'æ’ä¾¿ã€€å›ï¼ˆæ€§çŠ¶ã€€ã€€ï¼‰'],
                'é£Ÿäº‹': ['å§¿å‹¢ã®ç¢ºä¿', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ææ–™ã®èª¬æ˜', 'æ‘‚é£Ÿä»‹åŠ©', 'é£Ÿäº‹é‡ãƒ»å®Œé£Ÿãƒ»æ®‹é‡ï¼ˆ / )', 'æ°´åˆ†è£œçµ¦ï¼ˆã€€ï¼‰ã„', 'ç‰¹æ®µã®èª¿ç†ï¼ˆã€€ï¼‰', 'çŒ®ç«‹'],
                'æ¸…æ‹­ãƒ»å…¥æµ´': ['æ¸…æ‹­', 'éƒ¨åˆ†æµ´', 'æ´—é«ª'],
                'èº«ä½“æ•´å®¹': ['å…¨èº«æµ´', 'æ´—é¢', 'å£è…”ã‚±ã‚¢', 'æ•´å®¹', 'æ›´è¡£ä»‹åŠ©', 'æ©Ÿå™¨ä»‹åŠ©'],
                'ç§»å‹•': ['ä½“ä½å¤‰æ›', 'ç§»ä¹—ä»‹åŠ©', 'ç§»å‹•ä»‹åŠ©', 'æ­©è¡Œä»‹åŠ©', 'å¤–å‡ºæº–å‚™ä»‹åŠ©', 'å¸°å®…å—å…¥ä»‹åŠ©', 'é€šé™¢ä»‹åŠ©', 'è²·ç‰©ä»‹åŠ©'],
                'èµ·åºŠå°±å¯': ['èµ·åºŠä»‹åŠ©', 'å°±å¯ä»‹åŠ©'],
                'è‡ªç«‹æ”¯æ´': ['å…±ã«è¡Œã†ï¼ˆèª¿ç†ãƒ»æ¸…æƒãƒ»æ´—æ¿¯ãƒ»è¡£é¡æ•´ç†ï¼‰', 'èªçŸ¥ç—‡é«˜é½¢è€…ã®è¨˜æ†¶ã¸ã®åƒãã‹ã‘', 'è»¢å€’äºˆé˜²ã®å£°æ›ã‘ãƒ»è¦‹å®ˆã‚Šï¼ˆå…¥æµ´ãƒ»æ›´è¡£ãƒ»ç§»å‹•ï¼‰', 'è²·ç‰©é¸æŠã®æ´åŠ©']
            },
            'å®¶äº‹': {
                'æ¸…æƒ': ['å±…å®¤ãƒ»ãƒˆã‚¤ãƒ¬ãƒ»å“ä¸Šãƒ»å°æ‰€ãƒ»æµ´å®¤ãƒ»Pãƒˆã‚¤ãƒ¬ãƒ»æ´—é¢æ‰€ãƒ»å»Šä¸‹ãƒ»å¯å®¤', 'ç’°å¢ƒæ•´å‚™', 'ã‚´ãƒŸå‡ºã—'],
                'æ´—æ¿¯': ['æ´—æ¿¯', 'ä¹¾ç‡¥ï¼ˆç‰©å¹²ã—ï¼‰', 'å–å…¥ã‚Œãƒ»åç´', 'ã‚¢ã‚¤ãƒ­ãƒ³'],
                'ãƒ™ãƒƒãƒ‰ãƒ¡ã‚¤ã‚¯': ['ã‚·ãƒ¼ãƒ„äº¤æ›', 'æ•´ç†ãƒ»æ•´é “'],
                'è¡£é¡ãƒ»å¯å…·': ['è¡£é¡ã®æ•´ç†', 'è¢«æœã®è£œä¿®', 'å¸ƒå›£å¹²ã—'],
                'èª¿ç†': ['ä¸‹æ‹µãˆ', 'èª¿ç†', 'é…ãƒ»ä¸‹è†³', 'çŒ®ç«‹'],
                'è²·ç‰©ç­‰': ['æ—¥å¸¸å“ç­‰ã®è²·ç‰©', 'è–¬ã®å—å–ã‚Š']
            },
            'å¿…é ˆ': {
                'åŸºæœ¬': ['è¨˜éŒ²', 'å¥åº·ãƒã‚§ãƒƒã‚¯']
            },
            'æ§˜å­': {
                'åŸºæœ¬ãƒã‚§ãƒƒã‚¯': ['é¡”è‰²', 'ç™ºæ±—', 'è¨˜éŒ²', 'ç’°å¢ƒæ•´å‚™', 'ç›¸è«‡æ´åŠ©', 'æƒ…å ±åé›†ãƒ»æä¾›'],
                'ãƒã‚¤ã‚¿ãƒ«': ['ä½“æ¸©', 'è¡€åœ§ï¼ˆä¸Šï¼‰', 'è¡€åœ§ï¼ˆä¸‹ï¼‰']
            }
        };

        // ãƒã‚§ãƒƒã‚¯é …ç›®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function generateCheckItemsContent(serviceType, checkedItems = []) {
            let html = '';
            for (const [mainCategory, subCategories] of Object.entries(serviceItemsData)) {
                html += `<div class="check-category">`;
                html += `<div class="check-category-title">${mainCategory}</div>`;
                for (const [subCategoryName, items] of Object.entries(subCategories)) {
                    if (mainCategory !== 'å¿…é ˆ' && mainCategory !== 'æ§˜å­') {
                        html += `<div style="font-weight: 600; color: var(--text-gray); margin: 8px 0 4px; font-size: 0.85em;">${subCategoryName}</div>`;
                    }
                    items.forEach((item, index) => {
                        const itemId = `${mainCategory}-${subCategoryName}-${index}`;
                        const isChecked = checkedItems.includes(item) ? 'checked' : '';
                        html += `
                        <div class="check-item">
                            <input type="checkbox" id="${itemId}" value="${item}" ${isChecked}>
                            <label for="${itemId}">${item}</label>
                        </div>
                    `;
                    });
                }
                html += `</div>`;
            }
            return html;
        }

        // ãƒã‚§ãƒƒã‚¯é …ç›®ã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getCheckedItems(contentElement) {
            const checkboxes = contentElement.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        document.addEventListener('DOMContentLoaded', function () {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆ©ç”¨è€…æƒ…å ±ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            let currentUserId = urlParams.get('userId') || urlParams.get('user');

            // ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
            const DEMO_USERS_MAP = {
                '0001': { name: 'å±±ç”° å¤ªéƒ' },
                '0002': { name: 'éˆ´æœ¨ ä¸€éƒ' },
                '0003': { name: 'ä½è—¤ èŠ±å­' },
                '0004': { name: 'ç”°ä¸­ æ¬¡éƒ' },
                '0005': { name: 'é«˜æ©‹ å„ªå­' },
                '0006': { name: 'ä¼Šè—¤ å¥å¤ª' },
                '0007': { name: 'æ¸¡è¾º ç¾å’²' },
                '0008': { name: 'å±±æœ¬ å‰›' }
            };

            let currentUserName = DEMO_USERS_MAP[currentUserId] ? DEMO_USERS_MAP[currentUserId].name : 'ã‚²ã‚¹ãƒˆåˆ©ç”¨è€…';

            // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã«åˆ©ç”¨è€…åã‚’è¡¨ç¤º
            document.getElementById('pageTitle').textContent = `é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ - ${currentUserName} æ§˜`;

            const appData = { users: {}, services: {} };
            const planBody = document.getElementById('plan-body');
            const addServiceBtn = document.getElementById('addServiceBtn');
            const modal = document.getElementById('addServiceModal');
            const modalForm = document.getElementById('addServiceForm');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const syncShiftsBtn = document.getElementById('syncShiftsBtn');
            const saveCarePlanBtn = document.getElementById('saveCarePlanBtn');

            function renderServicesForUser(userId) {
                planBody.innerHTML = '';
                if (!userId || !appData.users[userId] || !appData.users[userId].serviceIds) return;

                const template = document.getElementById('serviceRowTemplate');
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½œæˆ
                let tpl = template;
                if (!tpl) {
                    tpl = document.createElement('template');
                    tpl.id = 'serviceRowTemplate';
                    tpl.innerHTML = `
                    <tr class="service-row">
                        <td class="service-info-cell">
                            <i class="fas fa-user-circle staff-icon"></i>
                            <div class="staff-list">
                                <div class="staff">ãƒ˜ãƒ«ãƒ‘ãƒ¼A</div>
                                <div class="staff">ãƒ˜ãƒ«ãƒ‘ãƒ¼B</div>
                            </div>
                            <button type="button" class="instruction-icon">æŒ‡ç¤º</button>
                            <div class="service-details">
                                <!-- ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                            </div>
                            <div class="memo-area">
                                <label>å‚™è€ƒ</label>
                                <textarea placeholder="å‚™è€ƒã‚’å…¥åŠ›..."></textarea>
                            </div>
                            <div class="check-items-section">
                                <button class="check-items-toggle">ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’è¡¨ç¤º â–¼</button>
                                <div class="check-items-content">
                                    <!-- ãƒã‚§ãƒƒã‚¯é …ç›®ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                            <button type="button" class="transfer-week-btn">é€±é–“ã‚·ãƒ•ãƒˆã¸è»¢è¨˜</button>
                        </td>
                        <td><div class="schedule-item"><input type="time" class="start-time"><br><input type="time" class="end-time"><br><input type="text" class="staff-name-display" placeholder="æ‹…å½“è€…"><br><textarea placeholder="å†…å®¹"></textarea></div></td>
                        <td><div class="schedule-item"><input type="time" class="start-time"><br><input type="time" class="end-time"><br><input type="text" class="staff-name-display" placeholder="æ‹…å½“è€…"><br><textarea placeholder="å†…å®¹"></textarea></div></td>
                        <td><div class="schedule-item"><input type="time" class="start-time"><br><input type="time" class="end-time"><br><input type="text" class="staff-name-display" placeholder="æ‹…å½“è€…"><br><textarea placeholder="å†…å®¹"></textarea></div></td>
                        <td><div class="schedule-item"><input type="time" class="start-time"><br><input type="time" class="end-time"><br><input type="text" class="staff-name-display" placeholder="æ‹…å½“è€…"><br><textarea placeholder="å†…å®¹"></textarea></div></td>
                        <td><div class="schedule-item"><input type="time" class="start-time"><br><input type="time" class="end-time"><br><input type="text" class="staff-name-display" placeholder="æ‹…å½“è€…"><br><textarea placeholder="å†…å®¹"></textarea></div></td>
                        <td><div class="schedule-item"><input type="time" class="start-time"><br><input type="time" class="end-time"><br><input type="text" class="staff-name-display" placeholder="æ‹…å½“è€…"><br><textarea placeholder="å†…å®¹"></textarea></div></td>
                        <td><div class="schedule-item"><input type="time" class="start-time"><br><input type="time" class="end-time"><br><input type="text" class="staff-name-display" placeholder="æ‹…å½“è€…"><br><textarea placeholder="å†…å®¹"></textarea></div></td>
                    </tr>`;
                    document.body.appendChild(tpl);
                }

                const daysOfWeek = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

                appData.users[userId].serviceIds.forEach((serviceId, serviceIndex) => {
                    const service = appData.services[serviceId];
                    if (!service) return;

                    const newRowFragment = tpl.content.cloneNode(true);
                    const newRowEl = newRowFragment.querySelector('.service-row');
                    newRowEl.dataset.serviceId = serviceId;
                    newRowEl.dataset.serviceCode = service.serviceCode || '';

                    const serviceDetailsEl = newRowEl.querySelector('.service-details');
                    serviceDetailsEl.innerHTML = '';

                    if (service.customName && service.customName.trim()) {
                        const customNameSpan = document.createElement('span');
                        customNameSpan.className = 'service-name-custom';
                        customNameSpan.textContent = service.customName;
                        serviceDetailsEl.appendChild(customNameSpan);
                        // æ”¹è¡Œ
                        serviceDetailsEl.appendChild(document.createElement('br'));
                    }

                    const categorySpan = document.createElement('span');
                    categorySpan.className = 'category';
                    categorySpan.textContent = service.type;
                    serviceDetailsEl.appendChild(categorySpan);
                    serviceDetailsEl.appendChild(document.createElement('br'));

                    const idSpan = document.createElement('span');
                    idSpan.className = 'service-id';
                    idSpan.textContent = 'ID: ' + (service.serviceCode || serviceId);
                    serviceDetailsEl.appendChild(idSpan);

                    const scheduleItems = newRowEl.querySelectorAll('.schedule-item');
                    scheduleItems.forEach((item, index) => {
                        const dayKey = daysOfWeek[index];
                        if (service.schedule && service.schedule[dayKey]) {
                            const daySchedule = service.schedule[dayKey];
                            if (daySchedule.startTime) item.querySelector('.start-time').value = daySchedule.startTime;
                            if (daySchedule.endTime) item.querySelector('.end-time').value = daySchedule.endTime;
                            if (daySchedule.staff) item.querySelector('.staff-name-display').value = daySchedule.staff;
                            if (daySchedule.content) item.querySelector('textarea').value = daySchedule.content;
                        }
                    });

                    if (service.memo) {
                        newRowEl.querySelector('.memo-area textarea').value = service.memo;
                    }

                    const checkItemsContent = newRowEl.querySelector('.check-items-content');
                    const checkedItems = service.checkItems || [];
                    checkItemsContent.innerHTML = generateCheckItemsContent(service.type, checkedItems);

                    planBody.appendChild(newRowFragment);
                });

                document.querySelectorAll('.check-items-toggle').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const content = this.nextElementSibling;
                        content.classList.toggle('visible');
                    });
                });
            }

            function hideModal() {
                modal.classList.remove('visible');
                modalForm.reset();
                document.getElementById('newServiceName').value = '';
                if (window.cascadeServiceSelector && window.cascadeServiceSelector.resetAllSelections) {
                    window.cascadeServiceSelector.resetAllSelections();
                }
                modal.dataset.editMode = 'false';
                modal.dataset.editServiceId = '';
                modal.querySelector('.modal-header h2').textContent = 'æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ ';
                modal.querySelector('#modalSaveBtn').textContent = 'ä¿å­˜';
            }

            function addNewService(userId, customName, masterName, serviceCode) {
                const newServiceId = serviceCode || ('S' + Date.now());
                appData.services[newServiceId] = {
                    customName: customName || '',
                    type: masterName,
                    serviceCode: serviceCode || '',
                    schedule: {},
                    memo: '',
                    checkItems: []
                };
                if (!appData.users[userId]) {
                    appData.users[userId] = { serviceIds: [] };
                }
                appData.users[userId].serviceIds.push(newServiceId);
                renderServicesForUser(userId);
            }

            // ã‚µãƒ¼ãƒ“ã‚¹ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³
            const editDeleteServiceBtn = document.getElementById('editDeleteServiceBtn');
            const serviceSelectModal = document.getElementById('serviceSelectModal');
            const serviceSelectList = document.getElementById('serviceSelectList');
            const serviceSelectCloseBtn = document.getElementById('serviceSelectCloseBtn');
            const serviceSelectCancelBtn = document.getElementById('serviceSelectCancelBtn');

            function hideServiceSelectModal() { serviceSelectModal.classList.remove('visible'); }

            function renderServiceSelectList() {
                const services = appData.users[currentUserId]?.serviceIds || [];
                if (services.length === 0) {
                    serviceSelectList.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                let html = '';
                services.forEach(serviceId => {
                    const service = appData.services[serviceId];
                    if (service) {
                        html += `
                            <div class="service-select-item" data-service-id="${serviceId}">
                                <div class="service-select-info">
                                    <div class="service-select-name">${service.type}</div>
                                    <div class="service-select-id">ID: ${service.serviceCode || serviceId}</div>
                                </div>
                                <div class="service-select-actions">
                                    <button type="button" class="delete-btn" data-service-id="${serviceId}">ğŸ—‘ï¸ å‰Šé™¤</button>
                                </div>
                            </div>`;
                    }
                });
                serviceSelectList.innerHTML = html;
            }

            editDeleteServiceBtn.addEventListener('click', () => {
                renderServiceSelectList();
                serviceSelectModal.classList.add('visible');
            });
            serviceSelectCloseBtn.addEventListener('click', hideServiceSelectModal);
            serviceSelectCancelBtn.addEventListener('click', hideServiceSelectModal);

            serviceSelectList.addEventListener('click', (event) => {
                const serviceId = event.target.dataset.serviceId;
                if (!serviceId) return;
                if (event.target.classList.contains('delete-btn')) {
                    if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                        delete appData.services[serviceId];
                        const idx = appData.users[currentUserId].serviceIds.indexOf(serviceId);
                        if (idx > -1) appData.users[currentUserId].serviceIds.splice(idx, 1);
                        renderServicesForUser(currentUserId);
                        renderServiceSelectList();
                    }
                }
            });

            // æŒ‡ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«
            const instructionModal = document.getElementById('instructionModal');
            const instructionCancelBtn = document.getElementById('instructionCancelBtn');
            const instructionSaveBtn = document.getElementById('instructionSaveBtn');

            planBody.addEventListener('click', function (event) {
                if (event.target.classList.contains('staff-icon')) {
                    const staffList = event.target.nextElementSibling.nextElementSibling;
                    staffList.classList.toggle('visible');
                }
                if (event.target.classList.contains('instruction-icon')) {
                    document.getElementById('instructionText').value = appData.users[currentUserId]?.instructions || '';
                    instructionModal.classList.add('visible');
                }
                if (event.target.classList.contains('transfer-week-btn')) {
                    alert('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šã‚·ãƒ•ãƒˆã¸ã®è»¢è¨˜æ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™');
                }
            });

            instructionCancelBtn.addEventListener('click', () => instructionModal.classList.remove('visible'));
            instructionSaveBtn.addEventListener('click', () => {
                if (!appData.users[currentUserId]) appData.users[currentUserId] = { serviceIds: [] };
                appData.users[currentUserId].instructions = document.getElementById('instructionText').value;
                instructionModal.classList.remove('visible');
                alert('æŒ‡ç¤ºã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            });

            addServiceBtn.addEventListener('click', () => modal.classList.add('visible'));
            modalCancelBtn.addEventListener('click', hideModal);
            modalForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const customServiceName = document.getElementById('newServiceName').value.trim();
                const finalServiceSelect = document.getElementById('finalServiceSelect');
                const selectedOption = finalServiceSelect.options[finalServiceSelect.selectedIndex];
                if (!selectedOption || !selectedOption.value) { alert('ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
                const serviceCode = selectedOption.value;
                const serviceName = selectedOption.dataset.serviceName || selectedOption.textContent;
                addNewService(currentUserId, customServiceName, serviceName, serviceCode);
                hideModal();
            });

            saveCarePlanBtn.addEventListener('click', () => alert('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šä¿å­˜ã—ã¾ã—ãŸ'));
            syncShiftsBtn.addEventListener('click', () => alert('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šã‚·ãƒ•ãƒˆåŒæœŸæ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™'));

            // åˆæœŸåŒ–
            function initialize() {
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                const s1 = 'S' + Date.now();
                const s2 = 'S' + (Date.now() + 1);

                appData.services = {
                    [s1]: {
                        customName: '',
                        type: 'èº«ä½“ä»‹è­·',
                        schedule: {
                            mon: { startTime: '09:00', endTime: '10:00', staff: 'ç”°ä¸­ ãƒ˜ãƒ«ãƒ‘ãƒ¼' },
                            wed: { startTime: '09:00', endTime: '10:00', staff: 'ç”°ä¸­ ãƒ˜ãƒ«ãƒ‘ãƒ¼' }
                        },
                        memo: 'ç‰¹ã«ãªã—',
                        checkItems: ['ç¢ºèª', 'ãƒˆã‚¤ãƒ¬ä»‹åŠ©']
                    },
                    [s2]: {
                        customName: '',
                        type: 'ç”Ÿæ´»æ´åŠ©',
                        schedule: {
                            tue: { startTime: '14:00', endTime: '15:00', staff: 'ä½è—¤ ãƒ˜ãƒ«ãƒ‘ãƒ¼' }
                        },
                        memo: 'æƒé™¤ä¸­å¿ƒ',
                        checkItems: ['å±…å®¤ãƒ»ãƒˆã‚¤ãƒ¬ãƒ»å“ä¸Šãƒ»å°æ‰€ãƒ»æµ´å®¤ãƒ»Pãƒˆã‚¤ãƒ¬ãƒ»æ´—é¢æ‰€ãƒ»å»Šä¸‹ãƒ»å¯å®¤']
                    }
                };

                appData.users = {
                    [currentUserId]: {
                        name: currentUserName,
                        serviceIds: [s1, s2],
                        instructions: 'æ°´åˆ†è£œçµ¦ã‚’ã“ã¾ã‚ã«'
                    }
                };

                renderServicesForUser(currentUserId);
            }

            initialize();
        });
    </script>
</body>

</html>