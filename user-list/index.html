<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ©ç”¨è€…ä¸€è¦§ãƒ»æ”¹</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- pdfmake for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    :root {
      --primary-color: #fb923c;
      --secondary-color: #fed7aa;
      --accent-color: #ea580c;
      --success-color: #fb923c;
      --danger-color: #ea580c;
      --light-bg: #fff9f0;
      --main-bg: #fcfcfc;
      --white-bg: #ffffff;
      --font-color: #4a4a4a;
      --border-color: #efefef;
    }

    /* ====== Base / Layout ====== */
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background-color: var(--main-bg);
      color: var(--font-color);
      width: 100%;
    }

    #app-container {
      width: 100%;
    }

    .main-content {
      flex-grow: 1;
      padding: 0.75rem;
      min-width: 0;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .header h1 {
      font-size: 1.25rem;
      margin: 0;
    }

    .user-info {
      font-size: 14px;
      color: #555;
    }

    /* ====== Toolbar ====== */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--white-bg);
      padding: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
      margin-bottom: 0.5rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .toolbar-left .btn {
      margin-right: 8px;
    }

    .btn {
      padding: 0.5rem 0.85rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .search-bar {
      position: relative;
      width: 300px;
      max-width: 100%;
    }

    .search-bar input {
      width: 100%;
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--border-color);
      background-color: var(--white-bg);
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 13px;
    }

    .search-bar i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      cursor: pointer;
    }

    /* ====== Table ====== */
    .table-container {
      background-color: var(--white-bg);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
      overflow: auto;
      max-height: calc(100vh - 250px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th,
    td {
      padding: 0.6rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
      vertical-align: middle;
    }

    thead {
      background-color: var(--light-bg);
    }

    thead th {
      font-size: 0.75rem;
      color: #6c757d;
      font-weight: 600;
      position: sticky;
      top: 0;
      background-color: var(--light-bg);
      z-index: 10;
    }

    tbody td {
      font-size: 0.85rem;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background-color: #f5f5f5;
    }

    .user-name span {
      display: block;
      font-size: 0.75rem;
      color: #6c757d;
    }

    /* ====== Status / Actions ====== */
    .action-icon {
      font-size: 18px;
      color: #555;
      text-decoration: none;
      transition: color 0.2s;
      cursor: pointer;
      position: relative;
      display: inline-block;
    }

    .action-icon:hover {
      color: var(--primary-color);
    }

    .notification {
      color: var(--danger-color);
      font-weight: bold;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25em 0.6em;
      font-size: 0.8rem;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 50rem;
      color: #fff;
    }

    .status-active {
      background-color: var(--success-color);
    }

    .status-inactive {
      background-color: var(--secondary-color);
    }

    .status-paused {
      background-color: #ffc107;
    }

    .status-ended {
      background-color: #6c757d;
    }

    /* ====== æœªå…¥åŠ›æ¤œçŸ¥ãƒãƒƒã‚¸ãƒ»ãƒ©ãƒ™ãƒ« ====== */
    .badge-danger {
      display: inline-block;
      padding: 4px 8px;
      background-color: #ffccdd;
      color: #333;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      margin-right: 4px;
      margin-bottom: 2px;
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 10px;
      height: 10px;
      background-color: var(--danger-color);
      border-radius: 50%;
      border: 2px solid white;
    }

    .icon-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 10px;
      height: 10px;
      background-color: var(--danger-color);
      border: 2px solid white;
      border-radius: 50%;
      z-index: 1;
    }

    .notice-cell {
      max-width: 200px;
      word-wrap: break-word;
      white-space: normal;
    }

    .notice-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .icon-btn {
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      position: relative;
    }

    .icon {
      width: 24px;
      height: 24px;
      fill: #495057;
      vertical-align: middle;
    }

    /* ====== Filter Row ====== */
    .filter-row td {
      padding: 0.5rem !important;
      vertical-align: middle;
      position: sticky;
      top: 37px;
      background-color: var(--light-bg);
      z-index: 9;
    }

    .filter-row input,
    .filter-row select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.4rem;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-size: 0.85rem;
    }

    .filter-checkbox-cell {
      text-align: center;
    }

    /* ====== Count Bar & Pagination ====== */
    .count-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 0.25rem;
      padding: 0.4rem 0.6rem;
      background-color: var(--light-bg);
      border-radius: 4px;
    }

    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background-color: var(--light-bg);
      border-radius: 4px;
      margin-top: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .pagination-info {
      font-size: 14px;
      color: #666;
    }

    .pagination-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .pagination-controls button {
      padding: 6px 12px;
      font-size: 13px;
    }

    .page-numbers {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .page-btn {
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      background-color: white;
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
    }

    .page-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .page-btn:hover:not(.active) {
      background-color: #f8f9fa;
    }

    .items-per-page {
      font-size: 13px;
      color: #666;
    }

    .items-per-page select {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      margin-left: 8px;
    }

    /* ====== Modal ====== */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      overflow-y: auto;
    }

    .modal-backdrop.visible {
      visibility: visible;
      opacity: 1;
      display: flex;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      overflow-y: auto;
    }

    .modal-overlay.visible {
      visibility: visible;
      opacity: 1;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      width: 600px;
      max-width: 90%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      margin: 1rem 0;
      max-height: 85vh;
      overflow-y: auto;
    }

    .form-container {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      width: 600px;
      max-width: 90%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      margin: 1rem 0;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1rem;
    }

    .modal-header h1,
    .modal-header h2 {
      margin: 0;
    }

    .modal-close,
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      box-sizing: border-box;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .form-row .form-group {
      flex: 1;
      min-width: 200px;
    }

    .service-list {
      border: 1px dashed var(--border-color);
      background: #fcfcfc;
      padding: 0.75rem;
      border-radius: 8px;
    }

    .service-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .service-item {
      display: grid;
      grid-template-columns: 2fr 1.5fr auto;
      gap: 0.5rem;
      align-items: center;
    }

    .service-item select,
    .service-item input {
      padding: 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }

    .service-item .remove-btn {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecdd3;
      border-radius: 6px;
      padding: 0.45rem 0.75rem;
      cursor: pointer;
    }

    .service-total {
      margin-top: 0.5rem;
      font-weight: 600;
      color: #444;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
    }

    .checkbox-item input {
      width: auto;
      margin-right: 0.5rem;
    }

    .modal-footer {
      text-align: right;
      margin-top: 1.5rem;
    }

    .checkbox-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      border: 1px solid var(--border-color);
      padding: 1rem;
      border-radius: 6px;
    }

    .submit-button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 1rem;
    }

    .submit-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .loader {
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .file-info {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    .section-title {
      margin: 16px 0 8px;
      font-size: 14px;
      color: #666;
      font-weight: 700;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .help {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    /* ====== Service History Styles ====== */
    .history-item {
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--primary-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: var(--light-bg);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .history-date {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--font-color);
    }

    .history-service-type {
      font-size: 0.85rem;
      color: #666;
    }

    .history-info {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .info-tag {
      background: var(--light-bg);
      border: 1px solid var(--border-color);
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      color: var(--accent-color);
    }

    .history-time {
      font-size: 0.85rem;
      color: #555;
      margin-top: 4px;
    }

    .history-detail-modal {
      max-width: 700px;
    }

    .history-detail-section {
      margin-bottom: 16px;
    }

    .history-detail-section h3 {
      font-size: 1rem;
      color: var(--font-color);
      margin: 0 0 8px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 4px;
    }

    .history-detail-section p {
      margin: 4px 0;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .service-detail {
      background: var(--light-bg);
      padding: 10px;
      border-radius: 8px;
      margin-top: 8px;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }

    /* ====== Toast Notification ====== */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #28a745;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      transform: translateX(400px);
      transition: transform 0.3s ease-in-out;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 300px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.error {
      background-color: #dc3545;
    }

    .toast.warning {
      background-color: #ffc107;
      color: #212529;
    }

    .toast .toast-icon {
      font-size: 18px;
    }

    .toast .toast-message {
      flex-grow: 1;
    }

    .toast .toast-close {
      background: none;
      border: none;
      color: inherit;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
    }

    /* ====== Responsive ====== */
    @media (max-width: 768px) {
      .main-content {
        padding: 1rem;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .toolbar-left {
        display: flex;
        justify-content: flex-end;
      }

      .form-row {
        flex-direction: column;
        gap: 0;
      }

      .form-row .form-group {
        margin-bottom: 1rem;
      }

      .checkbox-container {
        grid-template-columns: 1fr;
      }

      .modal-content,
      .form-container {
        padding: 1.5rem;
      }

      .pagination-container {
        flex-direction: column;
        gap: 10px;
      }

      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }

      .toast {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
        transform: translateY(-100px);
      }

      .toast.show {
        transform: translateY(0);
      }
    }

    /* ====== Print Styles ====== */
    @media print {

      /* ã™ã¹ã¦ã®è¦ç´ ã®borderã‚’å®Œå…¨ã«éè¡¨ç¤º(æœ€å¼·ã®è¨­å®š)*/
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      #userTable,
      #userTable *,
      table,
      table *,
      th,
      td,
      tr {
        border: 0 !important;
        border-top: 0 !important;
        border-bottom: 0 !important;
        border-left: 0 !important;
        border-right: 0 !important;
        outline: 0 !important;
        box-shadow: none !important;
      }

      /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚°ãƒªãƒƒãƒ‰ç·š(border)ã‚’å®Œå…¨ã«éè¡¨ç¤º */
      table {
        border: none !important;
        border-collapse: collapse !important;
      }

      table th,
      table td,
      thead th,
      tbody td,
      tbody tr td,
      thead tr th,
      #userTable th,
      #userTable td {
        border: none !important;
        border-top: none !important;
        border-bottom: none !important;
        border-left: none !important;
        border-right: none !important;
        outline: none !important;
      }

      .table-container table th,
      .table-container table td {
        border: none !important;
        border-bottom: none !important;
      }

      /* ä¸è¦ãªè¦ç´ ã‚’éè¡¨ç¤º */
      .toolbar,
      .search-bar,
      .pagination-container,
      .count-bar,
      .filter-row,
      .action-icon,
      .icon-btn,
      button,
      .btn {
        display: none !important;
      }

      /* å°åˆ·æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
      .table-container {
        box-shadow: none !important;
        max-height: none !important;
        overflow: visible !important;
        border: none !important;
      }

      tbody tr:hover {
        background-color: transparent !important;
      }

      tbody tr:last-child td {
        border-bottom: none !important;
      }

      /* ãƒšãƒ¼ã‚¸ä½™ç™½ã®èª¿æ•´ */
      @page {
        margin: 1cm;
      }

      body {
        background-color: white !important;
      }

      .main-content {
        background-color: white !important;
      }
    }
  </style>
</head>

<body>
  <!-- App Container -->
  <div id="app-container">
    <main class="main-content">
      <header class="header">
        <h1>åˆ©ç”¨è€…ä¸€è¦§</h1>
        <div style="display: flex; align-items: center; gap: 20px;">
          <a href="monthlyshift.html" target="_blank" class="btn btn-primary" style="text-decoration: none;">ğŸ“…
            æœˆé–“ã‚·ãƒ•ãƒˆ</a>
          <div class="user-info">ã‚ˆã†ã“ãã€ç®¡ç†è€…æ§˜</div>
        </div>
      </header>

      <div class="toolbar">
        <div class="toolbar-left">
          <button id="new-user-btn" class="btn btn-primary" type="button">æ–°è¦ç™»éŒ²</button>
        </div>
        <div class="search-bar">
          <input id="searchName" type="search" placeholder="æ°åã§æ¤œç´¢" aria-label="æ°åã§æ¤œç´¢">
          <i class="fas fa-microphone" title="éŸ³å£°æ¤œç´¢"></i>
        </div>
      </div>

      <!-- ä»¶æ•°è¡¨ç¤ºãƒãƒ¼ -->
      <div class="count-bar">
        <div id="listCount" style="font-size: 14px; color: #666; font-weight: bold;">
          è¡¨ç¤ºä¸­: 0ä»¶ / ç·æ•°: 0ä»¶
        </div>
      </div>

      <!-- ä¸Šéƒ¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div id="pagination-container-top" class="pagination-container">
        <div class="pagination-info">
          <span id="pagination-info-top">1-50 / 100ä»¶</span>
        </div>
        <div class="pagination-controls">
          <button id="first-page-btn-top" class="btn btn-secondary" title="æœ€åˆã®ãƒšãƒ¼ã‚¸">
            <i class="fas fa-angle-double-left"></i>
          </button>
          <button id="prev-page-btn-top" class="btn btn-secondary" title="å‰ã®ãƒšãƒ¼ã‚¸">
            <i class="fas fa-angle-left"></i> å‰ã¸
          </button>
          <div id="page-numbers-top" class="page-numbers">
            <!-- ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™-->
          </div>
          <button id="next-page-btn-top" class="btn btn-secondary" title="æ¬¡ã®ãƒšãƒ¼ã‚¸">
            æ¬¡ã¸ <i class="fas fa-angle-right"></i>
          </button>
          <button id="last-page-btn-top" class="btn btn-secondary" title="æœ€å¾Œã®ãƒšãƒ¼ã‚¸">
            <i class="fas fa-angle-double-right"></i>
          </button>
        </div>
        <div class="items-per-page">
          <label for="items-per-page-select-top">è¡¨ç¤ºä»¶æ•°:</label>
          <select id="items-per-page-select-top">
            <option value="25">25ä»¶</option>
            <option value="50">50ä»¶</option>
            <option value="100">100ä»¶</option>
            <option value="200">200ä»¶</option>
            <option value="500">500ä»¶</option>
            <option value="1000" selected>1000ä»¶</option>
          </select>
        </div>
      </div>

      <div class="table-container" role="region" aria-label="åˆ©ç”¨è€…ãƒ†ãƒ¼ãƒ–ãƒ«" tabindex="0">
        <table id="userTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>æ›¸é¡</th>
              <th>åå‰ (ãƒ•ãƒªã‚¬ãƒŠ)</th>
              <th>ã‚µè²¬</th>
              <th>åˆ©ç”¨çŠ¶æ³</th>
              <th>ä½æ‰€</th>
              <th>å†…å®¹</th>
              <th>ãŠçŸ¥ã‚‰ã›</th>
              <th>é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³</th>
              <th>åŸºæœ¬æƒ…å ±</th>
              <th>è¨ˆç”»æ›¸<br>(FIM)</th>
              <th>æ›´æ–°æ›¸é¡</th>
              <th>å±¥æ­´</th>
            </tr>
            <tr class="filter-row">
              <td><input type="text" id="filter-id" placeholder="ç•ªå·"></td>
              <td></td>
              <td><input type="text" id="filter-name" placeholder="åå‰"></td>
              <td><select id="filter-manager"></select></td>
              <td><select id="filter-usage"></select></td>
              <td><select id="filter-address"></select></td>
              <td><select id="filter-content"></select></td>
              <td><select id="filter-notice"></select></td>
              <td colspan="5"></td>
            </tr>
          </thead>
          <tbody id="user-table-body">
            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã®å†…å®¹ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™-->
          </tbody>
        </table>
      </div>

      <!-- ä¸‹éƒ¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div id="pagination-container" class="pagination-container">
        <div class="pagination-info">
          <span id="pagination-info">1-50 / 100ä»¶</span>
        </div>
        <div class="pagination-controls">
          <button id="first-page-btn" class="btn btn-secondary" title="æœ€åˆã®ãƒšãƒ¼ã‚¸">
            <i class="fas fa-angle-double-left"></i>
          </button>
          <button id="prev-page-btn" class="btn btn-secondary" title="å‰ã®ãƒšãƒ¼ã‚¸">
            <i class="fas fa-angle-left"></i> å‰ã¸
          </button>
          <div id="page-numbers" class="page-numbers">
            <!-- ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™-->
          </div>
          <button id="next-page-btn" class="btn btn-secondary" title="æ¬¡ã®ãƒšãƒ¼ã‚¸">
            æ¬¡ã¸ <i class="fas fa-angle-right"></i>
          </button>
          <button id="last-page-btn" class="btn btn-secondary" title="æœ€å¾Œã®ãƒšãƒ¼ã‚¸">
            <i class="fas fa-angle-double-right"></i>
          </button>
        </div>
        <div class="items-per-page">
          <label for="items-per-page-select">è¡¨ç¤ºä»¶æ•°:</label>
          <select id="items-per-page-select">
            <option value="25">25ä»¶</option>
            <option value="50">50ä»¶</option>
            <option value="100">100ä»¶</option>
            <option value="200">200ä»¶</option>
            <option value="500">500ä»¶</option>
            <option value="1000" selected>1000ä»¶</option>
          </select>
        </div>
      </div>
    </main>

    <!-- ====== åŸºæœ¬æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«(æ–°æ§‹)====== -->
    <div id="basic-info-modal" class="modal-backdrop" role="dialog" aria-modal="true"
      aria-labelledby="basic-info-modal-title">
      <div class="form-container">
        <div class="modal-header">
          <h1 id="basic-info-modal-title">åŸºæœ¬æƒ…å ± (<span id="basic-info-modal-user-name"></span>)</h1>
          <button class="modal-close" aria-label="é–‰ã˜ã‚‹" onclick="closeModal('basic-info-modal')">Ã—</button>
        </div>
        <div id="basic-info-loader" class="loader" style="display:none;">
          <div class="spinner" aria-hidden="true"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        <form id="basic-info-form">
          <input type="hidden" id="basic-info-clientId" name="clientId">
          <div id="basic-info-form-body" style="display:none;"></div>
        </form>
      </div>
    </div>

    <!-- ====== æ›´æ–°æ›¸é¡ãƒ¢ãƒ¼ãƒ€ãƒ«(ã‚¹ã‚­ãƒ¼ãƒé§†å‹•)====== -->
    <div id="update-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="update-modal-title">
      <div class="form-container">
        <div class="modal-header">
          <h1 id="update-modal-title">æ›´æ–°æ›¸é¡(<span id="update-modal-user-name"></span>)</h1>
          <button class="modal-close" aria-label="é–‰ã˜ã‚‹" onclick="closeModal('update-modal')">Ã—</button>
        </div>

        <div id="update-loader" class="loader" style="display:none;">
          <div class="spinner" aria-hidden="true"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <form id="update-form">
          <input type="hidden" id="update-clientId" name="clientId">
          <div id="update-form-body" style="display:none;">
            <div id="update-dynamic-fields"></div>
            <div id="update-history" style="margin-top:8px;"></div>
            <button type="submit" id="update-submit-button" class="submit-button">ã“ã®å†…å®¹ã§æ›´æ–°ã™ã‚‹</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ====== è¨ˆç”»æ›¸(FIM)ãƒ¢ãƒ¼ãƒ€ãƒ« ====== -->
    <div id="plan-fim-modal" class="modal-backdrop" role="dialog" aria-modal="true"
      aria-labelledby="plan-fim-modal-title">
      <div class="form-container">
        <div class="modal-header">
          <h1 id="plan-fim-modal-title">è¨ˆç”»æ›¸(FIM) (<span id="plan-fim-modal-user-name"></span>)</h1>
          <button class="modal-close" aria-label="é–‰ã˜ã‚‹" onclick="closeModal('plan-fim-modal')">Ã—</button>
        </div>

        <div id="plan-fim-loader" class="loader" style="display:none;">
          <div class="spinner" aria-hidden="true"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <form id="plan-fim-form">
          <input type="hidden" id="plan-fim-clientId" name="clientId">
          <div id="plan-fim-form-body" style="display:none;">
            <div id="plan-fim-dynamic-fields"></div>
            <div id="plan-fim-history" style="margin-top:8px;"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button type="submit" id="plan-fim-submit-button" class="submit-button"
                style="flex: 1;">ã“ã®å†…å®¹ã§ä¿å­˜ã™ã‚‹</button>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <button type="button" id="plan-fim-pdf-shogai-button" class="btn btn-secondary"
                style="flex: 1; padding: 0.75rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;"
                onclick="exportPlanFimToPDF('shogai')">
                <i class="fas fa-file-pdf"></i> éšœå®³è¨ˆç”»æ›¸ä½œæˆ
              </button>
              <button type="button" id="plan-fim-pdf-kaigo-button" class="btn btn-secondary"
                style="flex: 1; padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;"
                onclick="exportPlanFimToPDF('kaigo')">
                <i class="fas fa-file-pdf"></i> ä»‹è­·è¨ˆç”»æ›¸ä½œæˆ
              </button>
              <button type="button" id="plan-fim-pdf-ido-button" class="btn btn-secondary"
                style="flex: 1; padding: 0.75rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;"
                onclick="exportPlanFimToPDF('ido')">
                <i class="fas fa-file-pdf"></i> ç§»å‹•è¨ˆç”»æ›¸ä½œæˆ
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- æ–°è¦åˆ©ç”¨è€…åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="new-user-modal" class="modal-backdrop" role="dialog" aria-modal="true"
      aria-labelledby="new-user-modal-title">
      <div class="form-container">
        <div class="modal-header">
          <h2 id="new-user-modal-title">æ–°è¦åˆ©ç”¨è€…åŠ </h2>
          <button class="modal-close" aria-label="é–‰ã˜ã‚‹" onclick="closeModal('new-user-modal')">Ã—</button>
        </div>

        <div id="new-user-loader" class="loader" style="display:none;">
          <div class="spinner" aria-hidden="true"></div>
          <p>ä½œæˆä¸­...</p>
        </div>

        <form id="new-user-form">
          <div id="new-user-form-body">
            <div class="form-group">
              <label for="new-user-id">åˆ©ç”¨è€…ID <span style="color: red;">*</span></label>
              <input type="text" id="new-user-id" name="userId" required placeholder="ä¾‹ 0006"
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <small style="color: #666;">4æ¡æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
            </div>

            <div class="form-group">
              <label for="new-user-name">æ°å <span style="color: red;">*</span></label>
              <input type="text" id="new-user-name" name="userName" required placeholder="ä¾‹ ç”°ä¸­ å¤ªéƒ style=" width: 100%;
                padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
              <label for="new-user-kana">ãƒ•ãƒªã‚¬ãƒŠ<span style="color: red;">*</span></label>
              <input type="text" id="new-user-kana" name="userKana" required placeholder="ä¾‹ ã‚¿ãƒŠã‚« ã‚¿ãƒ­ã‚¦"
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
              <label for="new-user-manager">ã‚µè²¬ <span style="color: red;">*</span></label>
              <input type="text" id="new-user-manager" name="userManager" required placeholder="ä¾‹ ä½è—¤ å¥ä¸€"
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
              <label for="new-user-address">ä½æ‰€ <span style="color: red;">*</span></label>
              <input type="text" id="new-user-address" name="userAddress" required placeholder="ä¾‹ å¤§é˜ªå¸‚ä¸­å¤®åŒºæœ¬ç”º1-2-3"
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="form-group">
              <label for="new-user-notice">ãŠçŸ¥ã‚‰ã›</label>
              <input type="text" id="new-user-notice" name="userNotice" placeholder="ä¾‹ ç‰¹è¨˜äº‹é …ç›®ã‚ã‚‹å ´å style=" width: 100%;
                padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <button type="submit" id="new-user-submit-button" class="submit-button">åˆ©ç”¨è€…è¿½åŠ </button>
          </div>
        </form>
      </div>
    </div>

    <!-- æ›¸é¡ãƒ•ã‚©ãƒ«ãƒ€ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="documents-modal" class="modal-backdrop" style="display:none;">
      <div class="form-container" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="form-header">
          <h2 id="documents-modal-title">æ›¸é¡ãƒ•ã‚©ãƒ«ãƒ€</h2>
          <button class="close-btn" onclick="closeModal('documents-modal')" aria-label="é–‰ã˜ã‚‹">&times;</button>
        </div>

        <div id="documents-loader" class="loader" style="display:none;">
          <div class="spinner"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <div id="documents-content">
          <!-- åˆ©ç”¨è€…æƒ…å ±è¡¨ç¤º -->
          <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <p style="margin: 0; font-size: 14px; color: #666;">åˆ©ç”¨è€…ID: <strong id="documents-userId"></strong></p>
            <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold;" id="documents-userName"></p>
          </div>

          <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div
            style="background-color: #fff; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; font-size: 16px;">æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </h3>

            <div class="form-group">
              <label for="document-category">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
              <select id="document-category"
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="contract">å¥‘ç´„</option>
                <option value="medical">è¨ºæ–­æ›¸ãƒ»åŒ»ç™‚æƒ…å ±</option>
                <option value="certificate">å—çµ¦è¨¼</option>
                <option value="plan">æ”¯æ´è¨ˆç”»æ›¸</option>
                <option value="report">å ±å‘Šæ›¸</option>
                <option value="photo">å†™çœŸ</option>
                <option value="other">ãä»–/option>
              </select>
            </div>

            <div class="form-group">
              <label for="document-file">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ/label>
                <input type="file" id="document-file" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #666;">å¯¾å¿œå½¢å¼ ç”»åƒã€PDFã€Wordã€Œxcel</small>
            </div>

            <div class="form-group">
              <label for="document-memo">ãƒ¡ãƒ¢(ä»»æ„)/label>
                <textarea id="document-memo" rows="2" placeholder="ä¾‹ 2024å¹´åº¦å¥‘ç´„"
                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>

            <button type="button" class="btn btn-primary" onclick="uploadDocumentFile()" style="width: 100%;">
              <i class="fas fa-upload"></i> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>
          </div>

          <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
          <div>
            <h3 style="font-size: 16px; margin-bottom: 10px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <div id="documents-list" style="display: flex; flex-direction: column; gap: 10px;">
              <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™-->
            </div>
            <div id="documents-empty" style="text-align: center; padding: 40px; color: #999; display: none;">
              <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 10px;"></i>
              <p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« ====== -->
  <div id="service-history-modal" class="modal-backdrop" role="dialog" aria-modal="true"
    aria-labelledby="service-history-modal-title">
    <div class="modal-content" style="max-width: 800px; max-height: 85vh;">
      <div class="modal-header">
        <h1 id="service-history-modal-title">ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½å±¥æ­´ (<span id="service-history-modal-user-name"></span>)</h1>
        <button class="modal-close" aria-label="é–‰ã˜ã‚‹" onclick="closeModal('service-history-modal')">Ã—</button>
      </div>

      <div id="service-history-loader" class="loader" style="display:none;">
        <div class="spinner"></div>
        <p>å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ãã„..</p>
      </div>

      <div id="service-history-content" style="margin-top: 1rem;">
        <!-- åˆ©ç”¨è€…æƒ…å ±è¡¨ç¤º -->
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #666;">åˆ©ç”¨è€…ID: <strong id="service-history-userId"></strong></p>
          <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold;" id="service-history-userName"></p>
        </div>

        <!-- å±¥æ­´ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="service-history-empty" style="display:none; text-align: center; padding: 40px; color: #888;">
          <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: 16px;"></i>
          <p>ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>

        <!-- å±¥æ­´ãƒªã‚¹ã¦-->
        <div id="service-history-list" style="max-height: 500px; overflow-y: auto;">
          <!-- å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ãŒå‹•çš„æŒ¿å…¥ã•ã‚Œã¾ã™-->
        </div>
      </div>
    </div>
  </div>
  <!-- End of app-container -->

  <!-- DEMO VERSION: ãƒ‡ãƒ¢ãƒãƒŠãƒ¼ -->
  <div
    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; text-align: center; font-weight: 600; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;">
    âš ï¸ ãƒ‡ãƒ¢ç‰ˆ - ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¶ç©ºã®ã‚‚ã®ã§ã™
  </div>
  <style>
    body {
      padding-top: 45px !important;
    }
  </style>

  <!-- DEMO VERSION: Firebase mocking - å®Ÿéš›ã®Firebaseã«ã¯æ¥ç¶šã—ãªã„ -->
  <script>
    console.log('[DEMO] Firebase SDKã‚’ãƒ¢ãƒƒã‚¯ã«ç½®æ› ===== DEMO VERSION =====');
    window.IS_DEMO = true;

    // ãƒ€ãƒŸãƒ¼åˆ©ç”¨è€…ãƒ‡ãƒ¼ã‚¿ï¼ˆ8åã®ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
    window.DEMO_USERS = [
      { id: '0001', name: 'å±±ç”° å¤ªéƒ', kana: 'ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦', manager: 'ç”°ä¸­ èŠ±å­', status: 'åˆ©ç”¨ä¸­', address: 'æ±äº¬éƒ½æ–°å®¿åŒº', content: 'èº«ä½“ãƒ»ç”Ÿæ´»', notice: 'ç‰¹ã«ãªã—', phone: '03-1234-5678', birthDate: '1945-05-15', insuranceNumber: '1234567890', support_services: [{ type: 'è¨ªå•ä»‹è­·', monthlyLimit: 30 }] },
      { id: '0002', name: 'ä½è—¤ èŠ±å­', kana: 'ã‚µãƒˆã‚¦ ãƒãƒŠã‚³', manager: 'éˆ´æœ¨ ä¸€éƒ', status: 'åˆ©ç”¨ä¸­', address: 'æ±äº¬éƒ½æ¸‹è°·åŒº', content: 'å±…å®…ä»‹è­·', notice: 'è¦ç¢ºèªäº‹é …ã‚ã‚Š', phone: '03-2345-6789', birthDate: '1950-08-20', insuranceNumber: '2345678901', support_services: [{ type: 'å±…å®…ä»‹è­·', monthlyLimit: 25 }] },
      { id: '0003', name: 'éˆ´æœ¨ ä¸€éƒ', kana: 'ã‚¹ã‚ºã‚­ ã‚¤ãƒãƒ­ã‚¦', manager: 'ç”°ä¸­ èŠ±å­', status: 'åˆ©ç”¨ä¸­', address: 'æ±äº¬éƒ½å“å·åŒº', content: 'ç§»å‹•æ”¯æ´', notice: '', phone: '03-3456-7890', birthDate: '1948-03-10', insuranceNumber: '3456789012', support_services: [{ type: 'ç§»å‹•æ”¯æ´', monthlyLimit: 20 }] },
      { id: '0004', name: 'é«˜æ©‹ ç¾å’²', kana: 'ã‚¿ã‚«ãƒã‚· ãƒŸã‚µã‚­', manager: 'ä½è—¤ æ¬¡éƒ', status: 'ä¼‘æ­¢ä¸­', address: 'æ±äº¬éƒ½ä¸–ç”°è°·åŒº', content: 'èº«ä½“', notice: 'å…¥é™¢ä¸­', phone: '03-4567-8901', birthDate: '1955-12-01', insuranceNumber: '4567890123', support_services: [{ type: 'è¨ªå•ä»‹è­·', monthlyLimit: 15 }] },
      { id: '0005', name: 'ä¼Šè—¤ å¥å¤ª', kana: 'ã‚¤ãƒˆã‚¦ ã‚±ãƒ³ã‚¿', manager: 'ç”°ä¸­ èŠ±å­', status: 'åˆ©ç”¨ä¸­', address: 'æ±äº¬éƒ½ç›®é»’åŒº', content: 'ç”Ÿæ´»æ´åŠ©', notice: '', phone: '03-5678-9012', birthDate: '1942-07-25', insuranceNumber: '5678901234', support_services: [{ type: 'è¨ªå•ä»‹è­·', monthlyLimit: 40 }] },
      { id: '0006', name: 'æ¸¡è¾º ãã‚ˆ', kana: 'ãƒ¯ã‚¿ãƒŠãƒ™ ã‚­ãƒ¨', manager: 'éˆ´æœ¨ ä¸€éƒ', status: 'åˆ©ç”¨ä¸­', address: 'æ±äº¬éƒ½ä¸­é‡åŒº', content: 'èº«ä½“ãƒ»ç§»å‹•', notice: 'é€±3å›è¨ªå•', phone: '03-6789-0123', birthDate: '1940-01-30', insuranceNumber: '6789012345', support_services: [{ type: 'è¨ªå•ä»‹è­·', monthlyLimit: 35 }] },
      { id: '0007', name: 'å°æ— æ­£ç”·', kana: 'ã‚³ãƒãƒ¤ã‚· ãƒã‚µã‚ª', manager: 'ä½è—¤ æ¬¡éƒ', status: 'åˆ©ç”¨çµ‚äº†', address: 'æ±äº¬éƒ½æ‰ä¸¦åŒº', content: 'å±…å®…ä»‹è­·', notice: '2025å¹´12æœˆçµ‚äº†', phone: '03-7890-1234', birthDate: '1938-09-05', insuranceNumber: '7890123456', support_services: [{ type: 'å±…å®…ä»‹è­·', monthlyLimit: 20 }] },
      { id: '0008', name: 'åŠ è—¤ ç¯€å­', kana: 'ã‚«ãƒˆã‚¦ ã‚»ãƒ„ã‚³', manager: 'ç”°ä¸­ èŠ±å­', status: 'åˆ©ç”¨ä¸­', address: 'æ±äº¬éƒ½ç·´é¦¬åŒº', content: 'é‡åº¦è¨ªå•ä»‹è­·', notice: '24æ™‚é–“æ”¯æ´ä½“åˆ¶', phone: '03-8901-2345', birthDate: '1952-04-18', insuranceNumber: '8901234567', support_services: [{ type: 'é‡åº¦è¨ªå•ä»‹è­·', monthlyLimit: 200 }] }
    ];
  </script>

  <script type="module">
    console.log('[DEMO] ES6 MODULE - Mock initialization');

    // ãƒ€ãƒŸãƒ¼ã®Firestoreãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
    const DEMO_USERS = window.DEMO_USERS;

    // ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.firebaseApp = { name: 'demo-app' };
    window.db = { type: 'mock-firestore' };
    window.storage = { type: 'mock-storage' };

    // Firestore mock functions
    const mockDoc = (db, ...paths) => ({ path: paths.join('/'), id: paths[paths.length - 1] });
    const mockCollection = (db, path) => ({ path, type: 'collection' });

    const mockGetDocs = async (ref) => {
      console.log('[DEMO] getDocs called for:', ref?.path || 'unknown');
      if (ref?.path === 'riyousya') {
        return {
          docs: DEMO_USERS.map(u => ({
            id: u.id,
            data: () => u,
            ref: { id: u.id, collection: () => ({ path: `riyousya/${u.id}` }) }
          })),
          size: DEMO_USERS.length,
          empty: false
        };
      }
      return { docs: [], size: 0, empty: true };
    };

    const mockGetDoc = async (ref) => {
      console.log('[DEMO] getDoc called for:', ref?.path || ref?.id || 'unknown');
      const userId = ref?.id || ref?.path?.split('/')[1];
      const user = DEMO_USERS.find(u => u.id === userId);
      if (user) {
        return { exists: () => true, data: () => user, id: user.id };
      }
      return { exists: () => false, data: () => null };
    };

    const mockSetDoc = async (ref, data) => { console.log('[DEMO] setDoc (ç„¡åŠ¹åŒ–):', ref, data); return Promise.resolve(); };
    const mockAddDoc = async (ref, data) => { console.log('[DEMO] addDoc (ç„¡åŠ¹åŒ–):', data); return { id: 'demo-' + Date.now() }; };
    const mockUpdateDoc = async (ref, data) => { console.log('[DEMO] updateDoc (ç„¡åŠ¹åŒ–):', data); return Promise.resolve(); };
    const mockDeleteDoc = async (ref) => { console.log('[DEMO] deleteDoc (ç„¡åŠ¹åŒ–)'); return Promise.resolve(); };
    const mockQuery = (...args) => args[0];
    const mockWhere = () => (ref) => ref;
    const mockOrderBy = () => (ref) => ref;
    const mockServerTimestamp = () => new Date().toISOString();
    const mockTimestamp = { fromDate: (d) => d, now: () => new Date() };
    const mockOnSnapshot = (ref, callback) => { setTimeout(() => callback({ docs: [] }), 100); return () => { }; };

    // Storage mock
    const mockRef = (storage, path) => ({ path, type: 'storage-ref' });
    const mockUploadBytes = async () => { console.log('[DEMO] uploadBytes (ç„¡åŠ¹åŒ–)'); return { ref: {} }; };
    const mockGetDownloadURL = async () => '#demo-url';
    const mockDeleteObject = async () => { console.log('[DEMO] deleteObject (ç„¡åŠ¹åŒ–)'); };

    window.firebaseModules = {
      collection: mockCollection, getDocs: mockGetDocs, getDoc: mockGetDoc, doc: mockDoc,
      setDoc: mockSetDoc, addDoc: mockAddDoc, updateDoc: mockUpdateDoc, deleteDoc: mockDeleteDoc,
      query: mockQuery, where: mockWhere, orderBy: mockOrderBy, serverTimestamp: mockServerTimestamp,
      Timestamp: mockTimestamp, onSnapshot: mockOnSnapshot,
      ref: mockRef, uploadBytes: mockUploadBytes, getDownloadURL: mockGetDownloadURL, deleteObject: mockDeleteObject
    };

    console.log('[DEMO] Firebase mock initialized');
  </script>

  <!-- Firebase Compat ãƒ¢ãƒƒã‚¯ -->
  <script>
    // Mock Firebase Compat
    window.firebase = {
      apps: [{}],
      initializeApp: function () { return {}; },
      database: function () {
        return {
          ref: function () {
            return {
              once: function () { return Promise.resolve({ val: function () { return null; } }); },
              on: function () { },
              off: function () { },
              set: function () { return Promise.resolve(); }
            };
          }
        };
      }
    };
    window.firebaseCompat = window.firebase;
    window.realtimeDb = window.firebase.database();
    console.log('[DEMO] Firebase Compat mock initialized');
  </script>

  <script>
    /* ================================================================
       DEMO VERSION: GAS APIç„¡åŠ¹åŒ–
    ================================================================ */
    const GAS_MAIN_URL = null;
    const GAS_URL = null;
    const GAS_UPDATE_URL = null;
    const KAIGO_PLAN_GAS_URL = null;

    /* ================================================================
       Firebase API Functions (DEMO VERSION)
    ================================================================ */
    const USE_FIREBASE = true;

    const COLLECTIONS = {
      USERS: 'riyousya',
      BASIC_INFO: 'riyousya/basicInfo',
      UPDATE_DOCS: 'riyousya/updateDoc',
      HISTORY: 'riyousya/history',
      DOCUMENTS: 'riyousya/documents'
    };

    const STORAGE_PATHS = {
      DOCUMENTS: 'riyousya/documents',
      FILES: 'riyousya/files'
    };

    /**
     * åˆ©ç”¨è€…ãƒªã‚¹ãƒˆã‚’å–å¾— (DEMO VERSION)
     */
    async function getUserListFromFirebase() {
      console.log('[DEMO] getUserListFromFirebase called');
      const users = window.DEMO_USERS.map(u => ({
        id: u.id,
        name: u.name,
        kana: u.kana,
        manager: u.manager,
        status: u.status,
        address: u.address,
        notice: u.notice,
        support_services: u.support_services
      }));

      const statusById = {};
      users.forEach(u => {
        statusById[u.id] = {
          basicInfoComplete: true,
          updateDocsComplete: true,
          planFimComplete: true,
          googleDriveUrl: '#'
        };
      });

      return { status: 'success', message: 'ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­', users, statusById };
    }



    /**
     * åˆ©ç”¨è€…ãƒ‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—)irebaseç‰ˆ)
     */
    async function getUserDataFromFirebase(userId, dataType) {
      try {
        const { doc, getDoc, collection } = window.firebaseModules;

        // riyousya â†E{userId} â†EbasicInfo/updateDoc â†Edata
        const userRef = doc(window.db, 'riyousya', userId);

        const subCollectionName = dataType === 'basicInfo' ? 'basicInfo' : 'updateDoc';
        const dataCollectionRef = collection(userRef, subCollectionName);
        const dataDocRef = doc(dataCollectionRef, 'data');

        const docSnap = await getDoc(dataDocRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          console.log('Firebase getUserData loaded:', dataType, data);
          return { status: 'success', values: data.values || {}, files: data.files || {} };
        } else {
          console.log('Firebase getUserData not found:', userId, dataType);
          return { status: 'not_found', values: {}, files: {} };
        }
      } catch (error) {
        console.error('Firebase getUserData error:', error);
        return { status: 'error', message: error.message };
      }
    }

    /**
     * åˆ©ç”¨è€…ãƒ‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜)irebaseç‰ˆ)
     */
    async function saveUserDataToFirebase(userId, dataType, data) {
      try {
        const { doc, setDoc, serverTimestamp, collection, getDoc } = window.firebaseModules;

        // riyousya â†E{userId} â†EbasicInfo/updateDoc â†Edata
        const userRef = doc(window.db, 'riyousya', userId);

        const subCollectionName = dataType === 'basicInfo' ? 'basicInfo' : 'updateDoc';
        const dataCollectionRef = collection(userRef, subCollectionName);
        const dataDocRef = doc(dataCollectionRef, 'data');

        await setDoc(dataDocRef, {
          userId: userId,
          ...data,
          lastUpdated: serverTimestamp(),
          updatedBy: 'ã‚·ã‚¹ãƒ†ãƒ '
        }, { merge: true });

        // âœEè¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚æ›´æ–°(ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºç”¨ã®åŸºæœ¬æƒ…å ±ã‚’ä¿å­˜)
        const parentUpdateData = {};

        if (dataType === 'basicInfo' && data.values) {
          // åŸºæœ¬æƒ…å ±ã‹ã‚‰è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ä¿å­˜ã™ã¹ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
          if (data.values.user_name !== undefined) parentUpdateData.name = data.values.user_name;
          if (data.values.user_kana !== undefined) parentUpdateData.kana = data.values.user_kana;
          if (data.values.care_manager !== undefined) parentUpdateData.manager = data.values.care_manager;
          if (data.values.address !== undefined) parentUpdateData.address = data.values.address;
        } else if (dataType === 'updateDoc' && data.values) {
          // æ›´æ–°æ›¸é¡ã‹ã‚‰è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ä¿å­˜ã™ã¹ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
          if (data.values.status !== undefined) parentUpdateData.status = data.values.status;
          if (data.values.support_services !== undefined) parentUpdateData.support_services = data.values.support_services;
        }

        // è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€æ›´æ–°ã¾ãŸæ–°è¦ä½œæˆ
        if (Object.keys(parentUpdateData).length > 0) {
          const parentDoc = await getDoc(userRef);
          if (parentDoc.exists()) {
            // æ—¢å­˜è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
            await setDoc(userRef, parentUpdateData, { merge: true });
            console.log('è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°:', userId, parentUpdateData);
          } else {
            // è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã®æ–°è¦ä½œæˆ
            await setDoc(userRef, { id: userId, ...parentUpdateData });
            console.log('è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–°è¦ä½œæˆ:', userId, parentUpdateData);
          }
        }

        // å±¥æ­´ã‚’ä¿å­˜ï¼ˆå¤±æ•—ã—ã¦ã‚‚æœ¬ä½“ä¿å­˜ã¯æˆåŠŸã¨ã—ã¦æ‰±ã†ï¼‰
        try {
          await saveHistoryToFirebase(userId, dataType, 'æ›´æ–°', data);
        } catch (historyErr) {
          console.warn('å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæœ¬ä½“ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜æ¸ˆã¿ï¼‰:', historyErr);
        }

        console.log('Firebase saveUserData success:', userId, dataType);
        return { status: 'success', message: 'ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ' };
      } catch (error) {
        console.error('Firebase saveUserData error:', error);
        return { status: 'error', message: error.message };
      }
    }

    /**
     * å±¥æ­´ã‚’ä¿å­˜)irebaseç‰ˆ)
     */
    async function saveHistoryToFirebase(userId, dataType, action, data) {
      try {
        const { doc, collection, addDoc, serverTimestamp } = window.firebaseModules;

        // ãƒ‘ã‚¹: riyousya/{userId}/history
        const userDocRef = doc(window.db, 'riyousya', userId);
        const historyRef = collection(userDocRef, 'history');

        await addDoc(historyRef, {
          userId,
          dataType,
          action,
          user: 'system',
          timestamp: serverTimestamp(),
          data: JSON.stringify(data)
        });

        console.log(`å±¥æ­´ä¿æœŸ userId=${userId}, dataType=${dataType}, action=${action}`);
      } catch (error) {
        console.error('Firebase saveHistory error:', error);
      }
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)irebaseç‰ˆ)
     */
    async function uploadFileToFirebaseStorage(file, userId, dataType, fieldId) {
      if (!file) return null;

      try {
        const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;
        const timestamp = new Date().getTime();
        const fileName = `${userId}_${dataType}_${fieldId}_${timestamp}_${file.name}`;
        const filePath = `${STORAGE_PATHS.FILES}/${fileName}`;
        const storageRef = ref(window.storage, filePath);

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const snapshot = await uploadBytes(storageRef, file);

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
        const downloadURL = await getDownloadURL(snapshot.ref);

        return {
          fileName: file.name,
          mimeType: file.type,
          fileUrl: downloadURL,
          filePath: filePath
        };
      } catch (error) {
        console.error('Firebase uploadFile error:', error);
        throw error;
      }
    }

    // Firebase: å±¥æ­´å–å¾—)erviceRecordsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—)
    async function getUserHistoryFromFirebase(userId, dataType) {
      try {
        const { collection, query, where, orderBy, getDocs } = window.firebaseModules;

        // ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½ç”»é¢ã¨åŒã˜ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ serviceRecordsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
        // userIdã¯åˆ©ç”¨è€…ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ãŸã‚ã€åˆ©ç”¨è€…ã§æ¤œç´¢
        const userName = await getUserNameById(userId);
        if (!userName) {
          console.warn(`ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: userId=${userId}`);
          return [];
        }

        const q = query(
          collection(window.db, 'serviceRecords'),
          where('customer', '==', userName),
          orderBy('date', 'desc'),
          orderBy('start', 'desc')
        );

        const snapshot = await getDocs(q);
        const history = [];

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          history.push({
            id: docSnap.id,
            userId: userId,
            dataType: 'serviceRecord',
            action: 'ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½',
            user: data.userEmail || data.helperEmail || 'ã‚·ã‚¹ãƒ†ãƒ ',
            timestamp: data.date ? new Date(data.date + ' ' + (data.start || '00:00')) : new Date(),
            customer: data.customerName || data.customer,
            date: data.date,
            start: data.startTime || data.start,
            end: data.endTime || data.end,
            actualDuration: data.actualDuration || '',
            type: data.serviceType || data.type,
            notes: data.notes,
            details: data.details,
            data: data
          });
        });

        console.log(`å±¥æ­´å–å¾— userId=${userId}, userName=${userName}, dataType=${dataType}, ä»¶æ•°=${history.length}`);
        return history;
      } catch (error) {
        console.error('Firebase getUserHistory error:', error);
        return [];
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‹ã‚‰åˆ©ç”¨è€…ã‚’å–å¾—
    async function getUserNameById(userId) {
      try {
        const { doc, getDoc, collection } = window.firebaseModules;
        const userDocRef = doc(window.db, 'riyousya', userId);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          return userDoc.data().name;
        }
        return null;
      } catch (error) {
        console.error('getUserNameById error:', error);
        return null;
      }
    }

    /* ================================================================
       å…±é€š
    ================================================================ */
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('visible');
      }
    }
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°(ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å¯¾å¿œ)
    async function uploadFileToGoogleDrive(file, userId, dataType, fieldId) {
      if (!file) return null;

      try {
        // USE_FIREBASEãƒ•ãƒ©ã‚°ã§Firebaseã¨GASã‚’ã‚Šæ›¿ã„
        if (USE_FIREBASE) {
          return await uploadFileToFirebaseStorage(file, userId, dataType, fieldId);
        }

        // GASç‰ˆ
        const fileData = await fileToBase64(file);

        const payload = {
          action: 'uploadFile',
          userId: userId,
          dataType: dataType,
          fieldId: fieldId,
          fileName: file.name,
          mimeType: file.type,
          fileData: fileData.data // Base64ãƒ‡ãƒ¼ã‚¿
        };

        const response = await fetch(GAS_MAIN_URL, { method: 'POST', body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const responseText = await response.text();
        let result;
        try { result = JSON.parse(responseText); } catch { throw new Error('GASã‹ã‚‰ã®å¿œç­”ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); }

        if (result.status === 'success') {
          return { fileName: file.name, mimeType: file.type, fileUrl: result.fileUrl, fileId: result.fileId };
        } else {
          throw new Error(result.message || 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }

    function showFileUploadProgress(fileName) { showToast(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ{fileName}ã€ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'info', 5000); }

    function fileToBase64(file) {
      if (!file) return Promise.resolve(null);
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve({ fileName: file.name, mimeType: file.type, data: reader.result });
        reader.onerror = (e) => reject(e);
      });
    }
    window.addEventListener('click', (e) => { if (e.target.classList.contains('modal-backdrop')) e.target.style.display = 'none'; });

    /* === Toast Notification System === */
    function showToast(message, type = 'success', duration = 3000) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();
      let icon = '';
      switch (type) {
        case 'success': icon = '<i class="fas fa-check-circle"></i>'; break;
        case 'error': icon = '<i class="fas fa-exclamation-circle"></i>'; break;
        case 'warning': icon = '<i class="fas fa-exclamation-triangle"></i>'; break;
        default: icon = '<i class="fas fa-info-circle"></i>';
      }
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
    <span class="toast-icon">${icon}</span>
    <span class="toast-message">${message}</span>
    <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
  `;
      document.body.appendChild(toast);
      setTimeout(() => { toast.classList.add('show'); }, 100);
      setTimeout(() => {
        if (toast.parentNode) {
          toast.classList.remove('show');
          setTimeout(() => { if (toast.parentNode) toast.remove(); }, 300);
        }
      }, duration);
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    function showLoadingSpinner(message = 'èª­ã¿è¾¼ã¿ä¸­...') {
      const existingSpinner = document.getElementById('main-loading-spinner');
      if (existingSpinner) existingSpinner.remove();
      const spinner = document.createElement('div');
      spinner.id = 'main-loading-spinner';
      spinner.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9998; display: flex; justify-content: center; align-items: center; flex-direction: column;">
      <div class="spinner" style="margin-bottom: 20px;"></div>
      <p style="color: #666; font-size: 16px; margin: 0;">${message}</p>
    </div>`;
      document.body.appendChild(spinner);
    }
    function hideLoadingSpinner() { const spinner = document.getElementById('main-loading-spinner'); if (spinner) spinner.remove(); }

    // ãŠçŸ¥ã‚‰ã›HTMLç”Ÿæˆ
    function generateNoticeHtml(originalNotice, userStatus) {
      const notices = [];
      if (originalNotice && originalNotice.trim()) {
        const cleanNotice = originalNotice.replace(/åŸºæœ¬æƒ…å ±æœªè¨˜å…¥/g, '').replace(/è¨ˆç”»æ›¸æœªè¨˜å…¥/g, '').replace(/æ›´æ–°æ›¸é¡æœªè¨˜å…¥/g, '').replace(/åˆ¤å®šã‚¨ãƒ©ãƒ¼/g, '').trim();
        if (cleanNotice) notices.push(`<span class="manual-notice">${cleanNotice}</span>`);
      }
      const autoNotices = computeNoticeText(userStatus);
      if (autoNotices.length > 0) autoNotices.forEach(n => notices.push(`<span class="badge-danger">${n}</span>`));
      return notices.length > 0 ? `<div class="notice-badges">${notices.join('')}</div>` : '';
    }
    function computeNoticeText(userStatus) {
      const notices = [];
      try {
        if (!userStatus.basicInfoComplete) notices.push('åŸºæœ¬æƒ…å ±æœªè¨˜å…¥');
        if (!userStatus.planFimComplete) notices.push('è¨ˆç”»æ›¸æœªè¨˜å…¥');
        if (!userStatus.updateDocsComplete) notices.push('æ›´æ–°æ›¸é¡æœªè¨˜å…¥');

        return notices.slice(0, 3);
      } catch (e) {
        console.error(e); return ['åˆ¤å®šã‚¨ãƒ©ãƒ¼'];
      }
    }
    function applyBadgeIfNeeded(iconHtml, shouldShowBadge, ariaLabel) {
      if (!shouldShowBadge) return iconHtml;
      return `<div class="action-icon-wrapper" style="position: relative; display: inline-block;">${iconHtml}<span class="icon-badge" aria-label="${ariaLabel}"></span></div>`;
    }

    /* ================================================================
       æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
    ================================================================ */
    function debounce(func, wait) { let t; return function (...a) { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; }
    function normalizeText(str) {
      if (!str) return '';
      let normalized = str.normalize('NFKC');
      normalized = normalized.replace(/[\u3041-\u3096]/g, m => String.fromCharCode(m.charCodeAt(0) + 0x60));
      normalized = normalized.normalize('NFD');
      normalized = normalized.toUpperCase();
      return normalized;
    }
    function matchesName(row, query) {
      if (!query.trim()) return true;
      const q = normalizeText(query.trim());
      const dataName = normalizeText(row.getAttribute('data-name') || '');
      const dataKana = normalizeText(row.getAttribute('data-name-kana') || '');
      const cellName = normalizeText(row.querySelector('.cell-name')?.textContent || '');
      const cellKana = normalizeText(row.querySelector('.cell-kana')?.textContent || '');
      return dataName.includes(q) || dataKana.includes(q) || cellName.includes(q) || cellKana.includes(q);
    }
    function matchesUsageStatus(row, filterValue) { if (!filterValue) return true; return row.getAttribute('data-status') === filterValue; }
    function matchesManager(row, filterValue) { if (!filterValue) return true; return row.getAttribute('data-manager') === filterValue; }
    function matchesAddress(row, filterValue) { if (!filterValue) return true; const address = row.getAttribute('data-address') || ''; return address.includes(filterValue); }
    function matchesNotice(row, filterValue) {
      if (!filterValue) return true;
      const noticeText = (row.querySelector('.notice-cell')?.textContent || '').trim();
      switch (filterValue) {
        case 'åŸºæœ¬æƒ…å ±æœªè¨˜å…¥': return noticeText.includes('åŸºæœ¬æƒ…å ±æœªè¨˜å…¥');
        case 'æ›´æ–°æ›¸é¡æœªè¨˜å…¥': return noticeText.includes('æ›´æ–°æ›¸é¡æœªè¨˜å…¥');
        case 'ã©ã¡ã‚‰ã‚‚è¨˜å…¥æ¸ˆã¿':
          const a = noticeText.includes('åŸºæœ¬æƒ…å ±æœªè¨˜å…¥'), b = noticeText.includes('æ›´æ–°æ›¸é¡æœªè¨˜å…¥'), empty = (noticeText === '' || noticeText === '-');
          return !a && !b && !empty;
        case 'ã©ã¡ã‚‰ã‚‚æœªè¨˜å…¥': return noticeText.includes('åŸºæœ¬æƒ…å ±æœªè¨˜å…¥') && noticeText.includes('æ›´æ–°æ›¸é¡æœªè¨˜å…¥');
        default: return true;
      }
    }
    function applyFilters() {
      const idFilter = document.getElementById('filter-id')?.value || '';
      const nameFilter = document.getElementById('filter-name')?.value || '';
      const managerFilter = document.getElementById('filter-manager')?.value || '';
      const usageFilter = document.getElementById('filter-usage')?.value || '';
      const addressFilter = document.getElementById('filter-address')?.value || '';
      const contentFilter = document.getElementById('filter-content')?.value || '';
      const noticeFilter = document.getElementById('filter-notice')?.value || '';

      const rows = document.querySelectorAll('#userTable tbody tr');
      let visibleCount = 0;
      rows.forEach(row => {
        const rowId = row.getAttribute('data-id') || '';
        const rowName = (row.querySelector('.user-name')?.textContent || '').toLowerCase();
        const rowManager = row.getAttribute('data-manager') || '';
        const rowUsage = row.getAttribute('data-status') || '';
        const rowAddress = row.getAttribute('data-address') || '';
        const rowContentText = (row.querySelector('.content-cell')?.textContent || '').trim();
        const rowNoticeText = (row.querySelector('.notice-cell')?.textContent || '').trim();

        const idMatch = !idFilter || rowId.includes(idFilter);
        const nameMatch = !nameFilter || rowName.includes(nameFilter.toLowerCase());
        const managerMatch = !managerFilter || rowManager === managerFilter;
        const usageMatch = !usageFilter || rowUsage === usageFilter;
        const addressMatch = !addressFilter || rowAddress.startsWith(addressFilter);
        const contentMatch = !contentFilter || rowContentText.includes(contentFilter);

        let noticeMatch = true;
        if (noticeFilter) {
          switch (noticeFilter) {
            case 'ãŠçŸ¥ã‚‰ã›ã‚ã‚Š':
              noticeMatch = rowNoticeText !== '' && rowNoticeText !== '-';
              break;
            case 'åŸºæœ¬æƒ…å ±æœªè¨˜å…¥':
              noticeMatch = rowNoticeText.includes('åŸºæœ¬æƒ…å ±æœªè¨˜å…¥');
              break;
            case 'è¨ˆç”»æ›¸æœªè¨˜å…¥':
              noticeMatch = rowNoticeText.includes('è¨ˆç”»æ›¸æœªè¨˜å…¥');
              break;
            case 'æ›´æ–°æ›¸é¡æœªè¨˜å…¥':
              noticeMatch = rowNoticeText.includes('æ›´æ–°æ›¸é¡æœªè¨˜å…¥');
              break;
            case 'ãã®ä»–':
              // è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãŠçŸ¥ã‚‰ã›ä»¥å¤–
              const hasAutoNotice = rowNoticeText.includes('åŸºæœ¬æƒ…å ±æœªè¨˜å…¥') ||
                rowNoticeText.includes('è¨ˆç”»æ›¸æœªè¨˜å…¥') ||
                rowNoticeText.includes('æ›´æ–°æ›¸é¡æœªè¨˜å…¥');
              noticeMatch = !hasAutoNotice && rowNoticeText !== '' && rowNoticeText !== '-';
              break;
            default:
              noticeMatch = true;
          }
        }

        const isVisible = idMatch && nameMatch && managerMatch && usageMatch && addressMatch && contentMatch && noticeMatch;
        row.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
      });
      updateListCount(visibleCount, rows.length);
    }
    function updateListCount(visible, total) { const el = document.getElementById('listCount'); if (el) el.textContent = `è¡¨ç¤ºä¸­: ${visible}ä»¶ / ç·æ•°: ${total}ä»¶`; }
    function getStatusBadgeClass(status) { switch (status) { case 'åˆ©ç”¨ä¸­': return 'status-badge status-active'; case 'ä¸­æ–­ä¸­': return 'status-badge status-paused'; case 'çµ‚äº†': return 'status-badge status-ended'; default: return 'status-badge status-active'; } }

    function filterByUsageStatus(status) {
      const filterUsageSelect = document.getElementById('filter-usage');
      if (filterUsageSelect) {
        filterUsageSelect.value = status;
        applyFilters();
        showToast(`åˆ©ç”¨çŠ¶æ³ã€Œ{status}ã€ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã—ãŸ`, 'success', 2000);
      }
    }

    function populateFilterDropdowns() {
      if (!allUsers || allUsers.length === 0) return;

      // Populate manager dropdown
      const filterManagerSelect = document.getElementById('filter-manager');
      if (filterManagerSelect) {
        const managers = [...new Set(allUsers.map(u => u.manager).filter(Boolean))].sort();
        filterManagerSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µè²¬</option>';
        managers.forEach(m => {
          const option = document.createElement('option');
          option.value = m;
          option.textContent = m;
          filterManagerSelect.appendChild(option);
        });
      }

      // Populate usage status dropdown
      const filterUsageSelect = document.getElementById('filter-usage');
      if (filterUsageSelect) {
        filterUsageSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®åˆ©ç”¨çŠ¶æ³</option>';
        ['åˆ©ç”¨ä¸­', 'ä¸­æ–­ä¸­', 'çµ‚äº†'].forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = status;
          filterUsageSelect.appendChild(option);
        });
      }

      // Populate address dropdown (extract city/town)
      const filterAddressSelect = document.getElementById('filter-address');
      if (filterAddressSelect) {
        const getMunicipality = (address) => (address || '').match(/^(.+?[å¸‚åŒºç”ºæ‘])/)?.[1] || null;
        const municipalities = [...new Set(allUsers.map(u => getMunicipality(u.address)).filter(Boolean))].sort();
        filterAddressSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®ä½æ‰€</option>';
        municipalities.forEach(m => {
          const option = document.createElement('option');
          option.value = m;
          option.textContent = m;
          filterAddressSelect.appendChild(option);
        });
      }

      // Populate content dropdown
      const filterContentSelect = document.getElementById('filter-content');
      if (filterContentSelect) {
        filterContentSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®å†…å®¹</option>';
        const contentOptions = ['éšœå®³', 'ä»‹è­·', 'ç§»å‹•'];
        contentOptions.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          filterContentSelect.appendChild(option);
        });
      }

      // Populate notice dropdown
      const filterNoticeSelect = document.getElementById('filter-notice');
      if (filterNoticeSelect) {
        filterNoticeSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
        const noticeOptions = ['ãŠçŸ¥ã‚‰ã›ã‚ã‚Š', 'åŸºæœ¬æƒ…å ±æœªè¨˜å…¥', 'è¨ˆç”»æ›¸æœªè¨˜å…¥', 'æ›´æ–°æ›¸é¡æœªè¨˜å…¥', 'ãã®ä»–'];
        noticeOptions.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          filterNoticeSelect.appendChild(option);
        });
      }
    }

    function initFilters() {
      const filterIdInput = document.getElementById('filter-id');
      const filterNameInput = document.getElementById('filter-name');
      const filterManagerSelect = document.getElementById('filter-manager');
      const filterUsageSelect = document.getElementById('filter-usage');
      const filterAddressSelect = document.getElementById('filter-address');
      const filterContentSelect = document.getElementById('filter-content');
      const filterNoticeSelect = document.getElementById('filter-notice');
      const searchInput = document.getElementById('searchName');

      if (filterIdInput) filterIdInput.addEventListener('input', debounce(applyFilters, 200));
      if (filterNameInput) {
        filterNameInput.addEventListener('input', debounce(applyFilters, 200));
        // Sync with top search box
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            filterNameInput.value = e.target.value;
            applyFilters();
          });
          filterNameInput.addEventListener('input', (e) => {
            searchInput.value = e.target.value;
          });
        }
      }
      if (filterManagerSelect) filterManagerSelect.addEventListener('change', applyFilters);
      if (filterUsageSelect) filterUsageSelect.addEventListener('change', applyFilters);
      if (filterAddressSelect) filterAddressSelect.addEventListener('change', applyFilters);
      if (filterContentSelect) filterContentSelect.addEventListener('change', applyFilters);
      if (filterNoticeSelect) filterNoticeSelect.addEventListener('change', applyFilters);

      populateFilterDropdowns();
      updateListCount(0, 0);
    }
    document.addEventListener('DOMContentLoaded', async function () {
      console.log('=== DOM Content Loaded ===');

      // Check if Firebase is ready
      console.log('Firebase modules available:', !!window.firebaseModules);
      console.log('Firebase DB available:', !!window.db);

      // Check if modals exist
      console.log('Basic info modal exists:', !!document.getElementById('basic-info-modal'));
      console.log('Update modal exists:', !!document.getElementById('update-modal'));
      console.log('Documents modal exists:', !!document.getElementById('documents-modal'));

      // Initialize with Firestore real-time listener when USE_FIREBASE is true
      if (USE_FIREBASE) {
        await initializeClientApplication();
      } else {
        await fetchUsersWithStatusFromGAS();
      }
      initFilters();
      setupPaginationListeners();

      console.log('=== Initialization Complete ===');
    });
    function setupPaginationListeners() {
      const firstBtn = document.getElementById('first-page-btn'); if (firstBtn) firstBtn.addEventListener('click', () => goToPage(1));
      const prevBtn = document.getElementById('prev-page-btn'); if (prevBtn) prevBtn.addEventListener('click', () => goToPage(currentPage - 1));
      const nextBtn = document.getElementById('next-page-btn'); if (nextBtn) nextBtn.addEventListener('click', () => goToPage(currentPage + 1));
      const lastBtn = document.getElementById('last-page-btn'); if (lastBtn) lastBtn.addEventListener('click', () => { const totalPages = Math.ceil(filteredUsers.length / itemsPerPage); goToPage(totalPages); });
      const sel = document.getElementById('items-per-page-select');
      if (sel) sel.addEventListener('change', (e) => { itemsPerPage = parseInt(e.target.value); currentPage = 1; const top = document.getElementById('items-per-page-select-top'); if (top) top.value = e.target.value; renderUserTable(); });
      const selTop = document.getElementById('items-per-page-select-top');
      if (selTop) selTop.addEventListener('change', (e) => { itemsPerPage = parseInt(e.target.value); currentPage = 1; const bottom = document.getElementById('items-per-page-select'); if (bottom) bottom.value = e.target.value; renderUserTable(); });
      const firstBtnTop = document.getElementById('first-page-btn-top'); if (firstBtnTop) firstBtnTop.addEventListener('click', () => goToPage(1));
      const prevBtnTop = document.getElementById('prev-page-btn-top'); if (prevBtnTop) prevBtnTop.addEventListener('click', () => goToPage(currentPage - 1));
      const nextBtnTop = document.getElementById('next-page-btn-top'); if (nextBtnTop) nextBtnTop.addEventListener('click', () => goToPage(currentPage + 1));
      const lastBtnTop = document.getElementById('last-page-btn-top'); if (lastBtnTop) lastBtnTop.addEventListener('click', () => { const totalPages = Math.ceil(filteredUsers.length / itemsPerPage); goToPage(totalPages); });
    }

    /* ================================================================
       åŸºæœ¬æƒ…å ±(æ–°ã‚¹ã‚­ãƒ¼ãƒ)
    ================================================================ */
    const basicInfoModal = document.getElementById('basic-info-modal');
    const basicInfoForm = document.getElementById('basic-info-form');
    const basicInfoLoader = document.getElementById('basic-info-loader');

    /** â–¼ æ–°ã€ŒåŸºæœ¬æƒ…å ±ã€ã‚¹ã‚­ãƒ¼ãƒï¼ˆè¦ä»¶æº–æ‹ )*/
    const DEFAULT_BASIC_INFO_SCHEMA = [
      // --- åˆ©ç”¨è€…ã®åŸºæœ¬æƒ…å ± ---
      { id: 'user_name', label: 'åˆ©ç”¨è€…', type: 'text', required: true, help: 'ã“ã®åˆ©ç”¨è€…ã®æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' },
      { id: 'user_kana', label: 'ãƒ•ãƒªã‚¬ãƒŠ', type: 'text', required: true, help: 'åˆ©ç”¨è€…ã®ãƒ•ãƒªã‚¬ãƒŠã‚’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„' },

      // --- ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã¨æ¡ä»¶ä»˜ã ---
      {
        id: 'service_types', label: 'å†…å®¹', type: 'checkbox', options: [
          { value: 'éšœå®³', label: 'éšœå®³' },
          { value: 'ä»‹è­·', label: 'ä»‹è­·' },
          { value: 'ç§»å‹•', label: 'ç§»å‹•' }
        ], help: 'è¤‡æ•°é¸æŠå¯èƒ½ã§ã™ã€‚ã€Œéšœå®³ã€ã‚’é¸ã¶ã¨ åŒºåˆ†ãƒ»ç¨®åˆ¥ ã‚’å…¥åŠ›ã§ãã¾ã™'
      },

      {
        id: 'division', label: 'åŒºåˆ†', type: 'select', conditional: { field: 'service_types', includes: 'éšœå®³' }, options: [
          { value: 'åŒºåˆ†1', label: 'åŒºåˆ†1' }, { value: 'åŒºåˆ†2', label: 'åŒºåˆ†2' }, { value: 'åŒºåˆ†3', label: 'åŒºåˆ†3' },
          { value: 'åŒºåˆ†4', label: 'åŒºåˆ†4' }, { value: 'åŒºåˆ†5', label: 'åŒºåˆ†5' }, { value: 'åŒºåˆ†6', label: 'åŒºåˆ†6' },
          { value: 'åŒè¡Œ', label: 'åŒè¡Œ' }, { value: 'é‡åº¦åŒ»ã‚±ã‚¢å…', label: 'é‡åº¦åŒ»ã‚±ã‚¢å…' },
          { value: 'ãã®ä»–ï¼ˆå…ç«¥)', label: 'ãã®ä»–ï¼ˆå…ç«¥)' }, { value: 'çµ‚äº†', label: 'çµ‚äº†' }
        ]
      },

      {
        id: 'category', label: 'ç¨®åˆ¥', type: 'select', conditional: { field: 'service_types', includes: 'éšœå®³' }, options: [
          { value: 'å±…å®…', label: 'å±…å®…' }, { value: 'å…ç«¥', label: 'å…ç«¥' }, { value: 'é‡åº¦', label: 'é‡åº¦' }, { value: 'åŒè¡Œ', label: 'åŒè¡Œ' }, { value: 'çµ‚äº†', label: 'çµ‚äº†' }
        ]
      },

      {
        id: 'care_level', label: 'è¦ä»‹è­·åº¦', type: 'select', conditional: { field: 'service_types', includes: 'ä»‹è­·' }, options: [
          { value: 'è¦ä»‹è­·åº¦1', label: 'è¦ä»‹è­·åº¦1' },
          { value: 'è¦ä»‹è­·åº¦2', label: 'è¦ä»‹è­·åº¦2' },
          { value: 'è¦ä»‹è­·åº¦3', label: 'è¦ä»‹è­·åº¦3' },
          { value: 'è¦ä»‹è­·åº¦4', label: 'è¦ä»‹è­·åº¦4' },
          { value: 'è¦ä»‹è­·åº¦5', label: 'è¦ä»‹è­·åº¦5' },
          { value: 'è¦æ”¯æ´2', label: 'è¦æ”¯æ´2' },
          { value: 'çµ‚äº†', label: 'çµ‚äº†' }
        ]
      },

      // --- å…¨å“¡ã«è¡¨ç¤º ---
      { id: 'start_date', label: 'åˆ©ç”¨é–‹å§‹æ—¥', type: 'date' },
      { id: 'procedure', label: 'æ‰‹é †', type: 'textarea', rows: 2 },
      { id: 'address', label: 'åˆ©ç”¨è€…ä½æ‰€', type: 'text' },
      { id: 'support_office', label: 'ç›¸è«‡æ”¯æ´äº‹æ¥­æ‰€', type: 'text' },
      { id: 'care_manager', label: 'ä»‹è­·ç›¸è«‡å“¡', type: 'text' },
      { id: 'medical_org', label: 'ä»‹è­·ãƒ»åŒ»ç™‚æ©Ÿé–¢', type: 'text' },
      { id: 'birthdate', label: 'ç”Ÿå¹´æœˆæ—¥', type: 'date' },
      { id: 'notes', label: 'å‚™è€ƒ', type: 'textarea', rows: 3 },

      // --- BCPé …ç›®(é–‹é–‰å¯èƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³)---
      {
        id: 'safety_check', label: 'å®‰å¦ç¢ºèª', type: 'select', section: 'bcp', options: [
          { value: 'å¿…è¦', label: 'å¿…è¦' }, { value: 'ä¸è¦', label: 'ä¸è¦' }
        ]
      },
      {
        id: 'medical_care', label: 'åŒ»ç™‚ãƒ»ä»‹è­·', type: 'select', section: 'bcp', options: [
          { value: 'è»Šæ¤…å­', label: 'è»Šæ¤…å­' },
          { value: 'ç²¾ç¥éšœå®³ã«ã‚ˆã‚‹æ··ä¹±', label: 'ç²¾ç¥éšœå®³ã«ã‚ˆã‚‹æ··ä¹±' },
          { value: 'çŸ¥çš„éšœå®³ã«ã‚ˆã‚‹æ··ä¹±', label: 'çŸ¥çš„éšœå®³ã«ã‚ˆã‚‹æ··ä¹±' },
          { value: 'èªçŸ¥ç—‡ã«ã‚ˆã‚‹æ··ä¹±', label: 'èªçŸ¥ç—‡ã«ã‚ˆã‚‹æ··ä¹±' },
          { value: 'åˆ¤æ–­å¯èƒ½', label: 'åˆ¤æ–­å¯èƒ½' }
        ]
      },
      {
        id: 'building_env', label: 'å»ºç‰©ç’°å¢ƒ', type: 'select', section: 'bcp', options: [
          { value: 'â—‹', label: 'â—‹' }, { value: 'â–³', label: 'â–³' }, { value: 'Ã—', label: 'Ã—' }
        ]
      },
      {
        id: 'regional_env', label: 'åœ°åŸŸç’°å¢ƒ', type: 'select', section: 'bcp', options: [
          { value: 'å®‰å¦', label: 'å®‰å¦' }, { value: 'æ°´å®³', label: 'æ°´å®³' }, { value: 'åœŸç ‚ç½å®³', label: 'åœŸç ‚ç½å®³' }, { value: 'æ°´å®³ãƒ»åœŸç ‚ç½å®³', label: 'æ°´å®³ãƒ»åœŸç ‚ç½å®³' }
        ]
      },
      {
        id: 'evacuation', label: 'é¿é›£', type: 'select', section: 'bcp', options: [
          { value: 'å®¶æ—åŒå±…', label: 'å®¶æ—åŒå±…' }, { value: 'é«˜é½¢ãƒ»ç‹¬å±…', label: 'é«˜é½¢ãƒ»ç‹¬å±…' },
          { value: 'é«˜é½¢ä¸–å¸¯', label: 'é«˜é½¢ä¸–å¸¯' }, { value: 'ç‹¬å±…', label: 'ç‹¬å±…' },
          { value: 'æ—¥ä¸­ãƒ»ç‹¬å±…', label: 'æ—¥ä¸­ãƒ»ç‹¬å±…' }, { value: 'æ–½è¨­', label: 'æ–½è¨­' }
        ]
      },
      { id: 'bcp_notes', label: 'BCPå‚™è€ƒ', type: 'textarea', section: 'bcp', rows: 3 },

      // --- è¿½åŠ é …ç›®(å¸¸æ™‚è¡¨ç¤º)---
      { id: 'google_drive_url', label: 'Google Driveã®URL', type: 'text', help: 'ã“ã®åˆ©ç”¨è€…ã®Google Driveãƒ•ã‚©ãƒ«ãƒ€ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' },
      { id: 'emergency_contact', label: 'ç·Šæ€¥é€£çµ¡å…ˆ', type: 'text' },
      { id: 'family_contact', label: 'å®¶æ—é€£çµ¡å…ˆ', type: 'text' },
      { id: 'medical_history', label: 'æ—¢å¾€æ­´', type: 'textarea', rows: 3 },
      { id: 'medication', label: 'æœè–¬æƒ…å ±', type: 'textarea', rows: 3 },
      { id: 'allergy_info', label: 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±', type: 'textarea', rows: 2 },
      { id: 'special_notes', label: 'ç‰¹è¨˜äº‹é …', type: 'textarea', rows: 3 },
      { id: 'other_file', label: 'ãã®ä»–', type: 'file' }
    ];

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã(Firestore/GASã‹ã‚‰èª­ã‚“ã§æç”»)--- */
    async function openBasicInfoModal(userId, userName) {
      console.log('[Debug] openBasicInfoModal called', userId, userName);
      document.getElementById('basic-info-modal-user-name').textContent = userName;
      document.getElementById('basic-info-clientId').value = userId;
      const modal = document.getElementById('basic-info-modal');
      if (modal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒ†ãƒ¼
        modal.style.display = '';
        modal.classList.remove('visible');

        // å°‘ã—å»¶ã•ã›ã¦ç¢ºå®Ÿã«è¡¨ç¤º
        setTimeout(() => {
          modal.style.display = 'flex';
          modal.classList.add('visible');
          console.log('[Debug] Basic info modal opened');
        }, 10);
      } else {
        console.error('[Debug] Basic info modal not found!');
      }
      const loader = document.getElementById('basic-info-loader');
      if (loader) loader.style.display = 'block';
      const formBody = document.getElementById('basic-info-form-body');
      if (formBody) formBody.style.display = 'none';
      try {
        let values = {};
        if (USE_FIREBASE) {
          // Load from Firestore subcollection: riyousya/{userId}/basicInfo/data
          console.log('[Firebaseèª­ã¿è¾¼ã¿] ãƒ‘ã‚¹: riyousya/' + userId + '/basicInfo/data');
          const { doc, getDoc, collection } = window.firebaseModules;
          const userDocRef = doc(window.db, 'riyousya', userId);

          // è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰åå‰ã¨ã‚«ãƒŠã‚’å–å¾—
          const parentDoc = await getDoc(userDocRef);
          let userName = '';
          let userKana = '';
          if (parentDoc.exists()) {
            const parentData = parentDoc.data();
            userName = parentData.name || '';
            userKana = parentData.kana || '';
            console.log('[Firebaseèª­ã¿è¾¼ã¿] è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å–å¾— name=' + userName + ', kana=' + userKana);
          }

          const basicInfoRef = doc(collection(userDocRef, 'basicInfo'), 'data');
          const basicInfoDoc = await getDoc(basicInfoRef);

          if (basicInfoDoc.exists()) {
            const basicInfoData = basicInfoDoc.data();
            values = basicInfoData.values || {};
            console.log('[Firebaseèª­ã¿è¾¼ã¿] basicInfo ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
            console.log('[Firebaseèª­ã¿è¾¼ã¿] values:', values);

            // Convert Firestore Timestamps back to date strings for form display
            const convertedValues = {};
            for (const key in values) {
              if (values[key] && values[key].toDate) {
                // This is a Firestore Timestamp
                convertedValues[key] = timestampToDateString(values[key]);
              } else {
                convertedValues[key] = values[key];
              }
            }
            values = convertedValues;
            console.log('[Firebaseèª­ã¿è¾¼ã¿] å¤‰æ›å¾Œã®values:', values);
          }

          // åå‰ã¨ã‚«ãƒŠã‚’è¿½åŠ 
          values.user_name = userName;
          values.user_kana = userKana;
        } else {
          // Load from GAS
          const savedData = await getUserDataFromGAS(userId, 'basicInfo');
          values = savedData ? savedData.values || {} : {};
        }
        renderBasicInfoBySchema(DEFAULT_BASIC_INFO_SCHEMA, values);
      } catch (e) {
        showToast('åŸºæœ¬æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
        renderBasicInfoBySchema(DEFAULT_BASIC_INFO_SCHEMA, {});
      } finally {
        basicInfoLoader.style.display = 'none';
        document.getElementById('basic-info-form-body').style.display = 'block';
        applyBasicInfoConditional();
      }
    }

    /* --- å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼è¡Œã‚’è¿½åŠ ã™ã‚‹é–¢æ•° --- */
    function addFamilyMemberRow(container, familyData = {}) {
      const familyRow = document.createElement('div');
      familyRow.className = 'family-member-row';
      familyRow.style.cssText = 'display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; margin-bottom:15px; padding:15px; background:#f9f9f9; border-radius:6px; align-items:end;';

      // åå‰
      const nameGroup = document.createElement('div');
      nameGroup.className = 'form-group';
      nameGroup.style.marginBottom = '0';
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'åå‰';
      nameLabel.style.cssText = 'display:block; font-size:13px; margin-bottom:4px; font-weight:500;';
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.className = 'family-name';
      nameInput.value = familyData.name || '';
      nameInput.placeholder = 'ä¾‹ ç”°ä¸­ èŠ±å­';
      nameInput.style.cssText = 'width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:13px;';
      nameGroup.appendChild(nameLabel);
      nameGroup.appendChild(nameInput);

      // ç¶šæŸ„
      const relationGroup = document.createElement('div');
      relationGroup.className = 'form-group';
      relationGroup.style.marginBottom = '0';
      const relationLabel = document.createElement('label');
      relationLabel.textContent = 'ç¶šæŸ„';
      relationLabel.style.cssText = 'display:block; font-size:13px; margin-bottom:4px; font-weight:500;';
      const relationInput = document.createElement('input');
      relationInput.type = 'text';
      relationInput.className = 'family-relation';
      relationInput.value = familyData.relation || '';
      relationInput.placeholder = 'ä¾‹ é…å¶è€…';
      relationInput.style.cssText = 'width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:13px;';
      relationGroup.appendChild(relationLabel);
      relationGroup.appendChild(relationInput);

      // é›»è©±ç•ªå·
      const phoneGroup = document.createElement('div');
      phoneGroup.className = 'form-group';
      phoneGroup.style.marginBottom = '0';
      const phoneLabel = document.createElement('label');
      phoneLabel.textContent = 'é›»è©±ç•ªå·';
      phoneLabel.style.cssText = 'display:block; font-size:13px; margin-bottom:4px; font-weight:500;';
      const phoneInput = document.createElement('input');
      phoneInput.type = 'tel';
      phoneInput.className = 'family-phone';
      phoneInput.value = familyData.phone || '';
      phoneInput.placeholder = 'ä¾‹ 090-1234-5678';
      phoneInput.style.cssText = 'width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:13px;';
      phoneGroup.appendChild(phoneLabel);
      phoneGroup.appendChild(phoneInput);

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.className = 'btn-delete-family';
      deleteBtn.style.cssText = 'background:#f44336; color:white; border:none; padding:8px 12px; cursor:pointer; border-radius:4px; font-size:13px; height:36px;';
      deleteBtn.addEventListener('click', () => {
        if (container.querySelectorAll('.family-member-row').length > 1) {
          familyRow.remove();
        } else {
          showToast('æœ€ä½1ã¤ã®å®¶æ—æƒ…å ±ã‚’æ®‹ã™å¿…è¦ãŒã‚ã‚Šã¾ã™', 'warning');
        }
      });

      familyRow.appendChild(nameGroup);
      familyRow.appendChild(relationGroup);
      familyRow.appendChild(phoneGroup);
      familyRow.appendChild(deleteBtn);

      container.appendChild(familyRow);
    }

    /* --- ã‚¹ã‚­ãƒ¼ãƒæç”» conditionalå¯¾å¿œ + é–‹é–‰æ©Ÿèƒ½ --- */
    function renderBasicInfoBySchema(schema, values = {}) {
      const body = document.getElementById('basic-info-form-body');
      body.innerHTML = '';

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = 'åŸºæœ¬æƒ…å ±';
      title.style.fontWeight = '700';
      title.style.marginTop = '0';
      body.appendChild(title);

      const frag = document.createDocumentFragment();

      // é–‹é–‰å¯èƒ½ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³(æ—¢å­˜é …ç›®)
      const collapsibleSection = document.createElement('div');
      collapsibleSection.className = 'collapsible-section';
      collapsibleSection.style.marginBottom = '20px';

      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.className = 'toggle-button';
      toggleBtn.textContent = 'â–¼ åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º';
      toggleBtn.style.cssText = 'background:#4CAF50; color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:4px; margin-bottom:10px; font-size:14px;';

      const collapsibleContent = document.createElement('div');
      collapsibleContent.className = 'collapsible-content';
      collapsibleContent.style.display = 'none';

      let isExpanded = false;
      toggleBtn.addEventListener('click', () => {
        isExpanded = !isExpanded;
        collapsibleContent.style.display = isExpanded ? 'block' : 'none';
        toggleBtn.textContent = isExpanded ? 'â–² åŸºæœ¬æƒ…å ±ã‚’éè¡¨ç¤º' : 'â–¼ åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º';
      });

      collapsibleSection.appendChild(toggleBtn);
      collapsibleSection.appendChild(collapsibleContent);

      // ã‚¹ã‚­ãƒ¼ãƒã‚’3ã¤ã«åˆ†(æ—¢å­˜é …ç›® vs BCPé …ç›® vs è¿½åŠ é …ç›®)
      const existingFields = schema.filter(f =>
        f.section !== 'bcp' && !['emergency_contact', 'family_contact', 'medical_history', 'medication', 'allergy_info', 'special_notes', 'other_file'].includes(f.id)
      );
      const bcpFields = schema.filter(f => f.section === 'bcp');
      const additionalFields = schema.filter(f =>
        ['emergency_contact', 'family_contact', 'medical_history', 'medication', 'allergy_info', 'special_notes', 'other_file'].includes(f.id)
      );

      // æ—¢å­˜é …ç›®ã‚’é–‹é–‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
      existingFields.forEach(field => {
        const wrap = document.createElement('div'); wrap.className = 'form-group';
        wrap.dataset.fieldId = field.id;

        const label = document.createElement('label'); label.htmlFor = `bi_${field.id}`; label.textContent = field.label || field.id; wrap.appendChild(label);

        let input;
        if (field.type === 'textarea') {
          input = document.createElement('textarea'); input.rows = field.rows || 3; input.value = values[field.id] || '';
        } else if (field.type === 'checkbox') {
          input = document.createElement('div'); input.className = 'checkbox-group';
          input.style.cssText = 'display: flex; flex-direction: column; gap: 12px; margin-top: 8px;';
          const savedValues = values[field.id] || [];
          (field.options || []).forEach(opt => {
            const checkWrap = document.createElement('label');
            checkWrap.style.cssText = `
          display: flex;
          align-items: center;
          padding: 12px 16px;
          background: #f8f9fa;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s ease;
          user-select: none;
        `;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = opt.value;
            checkbox.dataset.checkboxField = field.id;
            checkbox.style.cssText = `
          width: 20px;
          height: 20px;
          margin-right: 12px;
          cursor: pointer;
          accent-color: ${opt.value === 'éšœå®³' ? '#dc3545' : opt.value === 'ä»‹è­·' ? '#28a745' : '#007bff'};
        `;
            if (Array.isArray(savedValues) && savedValues.includes(opt.value)) {
              checkbox.checked = true;
              checkWrap.style.background = opt.value === 'éšœå®³' ? '#ffe5e5' : opt.value === 'ä»‹è­·' ? '#e5ffe5' : '#e5f3ff';
              checkWrap.style.borderColor = opt.value === 'éšœå®³' ? '#dc3545' : opt.value === 'ä»‹è­·' ? '#28a745' : '#007bff';
            }

            const labelText = document.createElement('span');
            labelText.textContent = opt.label;
            labelText.style.cssText = 'font-size: 15px; font-weight: 500;';

            // ãƒ›ãƒãƒ¼åŠ¹æœã¨ãƒã‚§ãƒƒã‚¯æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            checkbox.addEventListener('change', function () {
              if (this.checked) {
                checkWrap.style.background = opt.value === 'éšœå®³' ? '#ffe5e5' : opt.value === 'ä»‹è­·' ? '#e5ffe5' : '#e5f3ff';
                checkWrap.style.borderColor = opt.value === 'éšœå®³' ? '#dc3545' : opt.value === 'ä»‹è­·' ? '#28a745' : '#007bff';
              } else {
                checkWrap.style.background = '#f8f9fa';
                checkWrap.style.borderColor = '#e9ecef';
              }
            });

            checkWrap.addEventListener('mouseenter', function () {
              if (!checkbox.checked) {
                checkWrap.style.background = '#e9ecef';
                checkWrap.style.borderColor = '#dee2e6';
              }
            });

            checkWrap.addEventListener('mouseleave', function () {
              if (!checkbox.checked) {
                checkWrap.style.background = '#f8f9fa';
                checkWrap.style.borderColor = '#e9ecef';
              }
            });

            checkWrap.appendChild(checkbox);
            checkWrap.appendChild(labelText);
            input.appendChild(checkWrap);
          });
        } else if (field.type === 'select') {
          input = document.createElement('select');
          (field.options || []).forEach(opt => {
            const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.label || opt.value;
            input.appendChild(o);
          });
          if (values[field.id]) input.value = values[field.id];
        } else if (field.type === 'date') {
          input = document.createElement('input'); input.type = 'date'; input.value = values[field.id] || '';
        } else if (field.type === 'file') {
          input = document.createElement('input'); input.type = 'file';
          if (field.accept) input.accept = field.accept;
        } else {
          input = document.createElement('input'); input.type = field.type || 'text'; input.value = values[field.id] || '';
        }

        input.id = `bi_${field.id}`;
        input.dataset.biField = field.id;
        input.classList.add('bi-field');
        wrap.appendChild(input);

        if (field.help) { const h = document.createElement('div'); h.className = 'help'; h.textContent = field.help; wrap.appendChild(h); }

        if (field.conditional) {
          wrap.dataset.conditionalField = field.conditional.field;
          if (field.conditional.equals) {
            wrap.dataset.conditionalEquals = field.conditional.equals;
          }
          if (field.conditional.includes) {
            wrap.dataset.conditionalIncludes = field.conditional.includes;
          }
        }

        collapsibleContent.appendChild(wrap);
      });

      frag.appendChild(collapsibleSection);

      // å®¶æ—ã‚’å«ã‚€ç’°å¢ƒã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ )CPã®å‰)
      const familySection = document.createElement('div');
      familySection.className = 'collapsible-section';
      familySection.style.marginBottom = '20px';

      const familyToggleBtn = document.createElement('button');
      familyToggleBtn.type = 'button';
      familyToggleBtn.className = 'toggle-button';
      familyToggleBtn.textContent = 'â–¼ å®¶æ—ã‚’å«ã‚€ç’°å¢ƒè¡¨ç¤º';
      familyToggleBtn.style.cssText = 'background:#2196F3; color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:4px; margin-bottom:10px; font-size:14px;';

      const familyContent = document.createElement('div');
      familyContent.className = 'collapsible-content';
      familyContent.id = 'family-environment-content';
      familyContent.style.display = 'none';

      let familyExpanded = false;
      familyToggleBtn.addEventListener('click', () => {
        familyExpanded = !familyExpanded;
        familyContent.style.display = familyExpanded ? 'block' : 'none';
        familyToggleBtn.textContent = familyExpanded ? 'â–² å®¶æ—ã‚’å«ã‚€ç’°å¢ƒéè¡¨ç¤º' : 'â–¼ å®¶æ—ã‚’å«ã‚€ç’°å¢ƒè¡¨ç¤º';
      });

      // å®¶æ—ãƒªãƒªãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ¼
      const familyListContainer = document.createElement('div');
      familyListContainer.id = 'family-list-container';
      familyContent.appendChild(familyListContainer);

      // æ—¢å­˜å®¶æ—æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
      const existingFamilies = values.family_environment || [];
      console.log('[åŸºæœ¬æƒ…å ±èª­ã¿è¾¼ã¿] å®¶æ—æƒ…å ±:', existingFamilies.length, 'ä»¶', existingFamilies);
      if (existingFamilies.length === 0) {
        // åˆæœŸçŠ¶æ…‹ã¨ã—ã¦1ã‚»ãƒƒãƒˆè¿½åŠ 
        addFamilyMemberRow(familyListContainer, {});
      } else {
        // ä¿å­˜ã•ã‚Œã¦ã„å®¶æ—æƒ…å ±ã‚’è¡¨ç¤º
        existingFamilies.forEach(family => {
          addFamilyMemberRow(familyListContainer, family);
        });
      }

      // è¿½åŠ ãƒœã‚¿ãƒ³
      const addFamilyBtn = document.createElement('button');
      addFamilyBtn.type = 'button';
      addFamilyBtn.className = 'btn btn-secondary';
      addFamilyBtn.textContent = 'è¿½åŠ ';
      addFamilyBtn.style.cssText = 'background:#4CAF50; color:white; border:none; padding:8px 16px; cursor:pointer; border-radius:4px; margin-top:10px; font-size:13px;';
      addFamilyBtn.addEventListener('click', () => {
        addFamilyMemberRow(familyListContainer, {});
      });
      familyContent.appendChild(addFamilyBtn);

      familySection.appendChild(familyToggleBtn);
      familySection.appendChild(familyContent);
      frag.appendChild(familySection);

      // BCPé …ç›®ã‚’é–‹é–‰å¯èƒ½ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ 
      if (bcpFields.length > 0) {
        const bcpSection = document.createElement('div');
        bcpSection.className = 'collapsible-section';
        bcpSection.style.marginBottom = '20px';

        const bcpToggleBtn = document.createElement('button');
        bcpToggleBtn.type = 'button';
        bcpToggleBtn.className = 'toggle-button';
        bcpToggleBtn.textContent = 'â–¼ BCPã‚’è¡¨ç¤º';
        bcpToggleBtn.style.cssText = 'background:#FF9800; color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:4px; margin-bottom:10px; font-size:14px;';

        const bcpContent = document.createElement('div');
        bcpContent.className = 'collapsible-content';
        bcpContent.style.display = 'none';

        let bcpExpanded = false;
        bcpToggleBtn.addEventListener('click', () => {
          bcpExpanded = !bcpExpanded;
          bcpContent.style.display = bcpExpanded ? 'block' : 'none';
          bcpToggleBtn.textContent = bcpExpanded ? 'â–² BCPã‚’éè¡¨ç¤º' : 'â–¼ BCPã‚’è¡¨ç¤º';
        });

        bcpFields.forEach(field => {
          const wrap = document.createElement('div'); wrap.className = 'form-group';
          wrap.dataset.fieldId = field.id;

          const label = document.createElement('label'); label.htmlFor = `bi_${field.id}`; label.textContent = field.label || field.id; wrap.appendChild(label);

          let input;
          if (field.type === 'textarea') {
            input = document.createElement('textarea'); input.rows = field.rows || 3; input.value = values[field.id] || '';
          } else if (field.type === 'select') {
            input = document.createElement('select');
            (field.options || []).forEach(opt => {
              const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.label || opt.value;
              input.appendChild(o);
            });
            if (values[field.id]) input.value = values[field.id];
          } else if (field.type === 'date') {
            input = document.createElement('input'); input.type = 'date'; input.value = values[field.id] || '';
          } else {
            input = document.createElement('input'); input.type = field.type || 'text'; input.value = values[field.id] || '';
          }

          input.id = `bi_${field.id}`;
          input.dataset.biField = field.id;
          input.classList.add('bi-field');
          wrap.appendChild(input);

          if (field.help) { const h = document.createElement('div'); h.className = 'help'; h.textContent = field.help; wrap.appendChild(h); }

          bcpContent.appendChild(wrap);
        });

        bcpSection.appendChild(bcpToggleBtn);
        bcpSection.appendChild(bcpContent);
        frag.appendChild(bcpSection);
      }

      // è¿½åŠ é …ç›®ã‚’å¸¸æ™‚è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
      if (additionalFields.length > 0) {
        const additionalTitle = document.createElement('div');
        additionalTitle.className = 'section-title';
        additionalTitle.textContent = 'è¿½åŠ æƒ…å ±';
        additionalTitle.style.fontWeight = '700';
        additionalTitle.style.marginTop = '20px';
        additionalTitle.style.marginBottom = '15px';
        frag.appendChild(additionalTitle);

        additionalFields.forEach(field => {
          const wrap = document.createElement('div'); wrap.className = 'form-group';
          wrap.dataset.fieldId = field.id;

          const label = document.createElement('label'); label.htmlFor = `bi_${field.id}`; label.textContent = field.label || field.id; wrap.appendChild(label);

          let input;
          if (field.type === 'textarea') {
            input = document.createElement('textarea'); input.rows = field.rows || 3; input.value = values[field.id] || '';
          } else if (field.type === 'file') {
            input = document.createElement('input'); input.type = 'file';
            if (field.accept) input.accept = field.accept;

            // ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢
            if (values[field.id]) {
              const fileInfo = document.createElement('div');
              fileInfo.className = 'file-info';
              fileInfo.style.cssText = 'margin-top:8px; padding:8px; background:#f5f5f5; border-radius:4px;';
              const link = document.createElement('a');
              link.href = values[field.id];
              link.target = '_blank';
              link.textContent = 'ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã';
              link.style.cssText = 'color:#1976d2; text-decoration:none;';
              fileInfo.appendChild(link);
              wrap.appendChild(fileInfo);
            }
          } else {
            input = document.createElement('input'); input.type = field.type || 'text'; input.value = values[field.id] || '';
          }

          input.id = `bi_${field.id}`;
          input.dataset.biField = field.id;
          input.classList.add('bi-field');
          wrap.appendChild(input);

          if (field.help) { const h = document.createElement('div'); h.className = 'help'; h.textContent = field.help; wrap.appendChild(h); }

          frag.appendChild(wrap);
        });
      }

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.id = 'basic-info-submit-button';
      submitBtn.className = 'submit-button';
      submitBtn.textContent = 'ã“ã®å†…å®¹ã§æ›´æ–°ã™ã‚‹';
      frag.appendChild(submitBtn);

      body.appendChild(frag);

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
      const serviceTypesCheckboxes = document.querySelectorAll('input[data-checkbox-field="service_types"]');
      serviceTypesCheckboxes.forEach(cb => {
        cb.addEventListener('change', applyBasicInfoConditional);
      });

      // æ—§å½¢å¼ã®äº’æ›æ€§ç¶­æŒ
      const serviceTypeEl = document.getElementById('bi_service_type');
      if (serviceTypeEl) serviceTypeEl.addEventListener('change', applyBasicInfoConditional);

      // åˆæœŸçŠ¶æ…‹ã‚’é©ç”¨
      applyBasicInfoConditional();
    }

    /* --- æ¡ä»¶ä»˜ãè¡¨ç¤º(ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹=éšœå®³ ã®ã¨ãã®ã¿åŒºåˆ†ç¨®åˆ¥ã‚’æ´»æ€§åŒ–--- */
    function applyBasicInfoConditional() {
      // service_typesãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰é¸æŠå€¤ã‚’å–å¾—
      const serviceTypesChecked = Array.from(document.querySelectorAll('input[data-checkbox-field="service_types"]:checked')).map(cb => cb.value);

      const allConditional = document.querySelectorAll('#basic-info-form-body .form-group[data-conditional-field]');
      allConditional.forEach(wrap => {
        const requiredField = wrap.dataset.conditionalField;
        const requiredEquals = wrap.dataset.conditionalEquals;
        const requiredIncludes = wrap.dataset.conditionalIncludes;

        let ok = false;
        if (requiredField === 'service_types' && requiredIncludes) {
          // includesæ¡ä»¶: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«æŒ‡å®šã®å€¤ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
          ok = serviceTypesChecked.includes(requiredIncludes);
        } else if (requiredField === 'service_type' && requiredEquals) {
          // æ—§å½¢å¼ã®äº’æ›æ€§ç¶­æŒ
          const serviceType = document.getElementById('bi_service_type')?.value || '';
          ok = (serviceType === requiredEquals);
        }

        wrap.style.display = ok ? '' : 'none';
        const input = wrap.querySelector('.bi-field');
        if (input) input.disabled = !ok;
        if (!ok) { // å€¤ã‚¯ãƒªã‚¢(ä¸è¦ãªã‚‰å‰Šé™¤å¯)
          if (input?.tagName === 'SELECT') input.selectedIndex = -1;
          else if (input) input.value = '';
        }
      });
    }

    /* --- é€ä¿¡å‡¦ç†ã‚¹ã‚­ãƒ¼ãƒå€¤ã‚’ä¿å­˜)irestore/GAS API)--- */
    document.addEventListener('submit', async (e) => {
      if (e.target.id === 'basic-info-form') {
        e.preventDefault();
        const btn = document.getElementById('basic-info-submit-button');
        btn.disabled = true; btn.textContent = 'æ›´æ–°ä¸­...';
        try {
          const clientId = document.getElementById('basic-info-clientId').value;
          const values = {};

          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åé›†
          const checkboxFields = new Set();
          document.querySelectorAll('input[data-checkbox-field]').forEach(cb => {
            checkboxFields.add(cb.dataset.checkboxField);
          });

          checkboxFields.forEach(fieldName => {
            const checkedBoxes = document.querySelectorAll(`input[data-checkbox-field="${fieldName}"]:checked`);
            values[fieldName] = Array.from(checkedBoxes).map(cb => cb.value);
          });

          // é€šå¸¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åé›†
          for (const el of document.querySelectorAll('#basic-info-form .bi-field')) {
            if (!el.disabled && el.type !== 'file' && !el.classList.contains('checkbox-group')) {
              const fieldName = el.dataset.biField;
              // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚å­—ã®ã¾ã¾ä¿å­˜)imestampå¤‰æ›ã—ãªã—ï¿½
              values[fieldName] = el.value;
            }
          }

          // å®¶æ—æƒ…å ±ã‚’åˆ—ã¨ã—ã¦åé›†
          const familyMembers = [];
          const familyRows = document.querySelectorAll('.family-member-row');
          familyRows.forEach(row => {
            const name = row.querySelector('.family-name')?.value || '';
            const relation = row.querySelector('.family-relation')?.value || '';
            const phone = row.querySelector('.family-phone')?.value || '';

            // ç©ºã§ãªã—ã®ã¿ä¿æœŸ
            if (name || relation || phone) {
              familyMembers.push({ name, relation, phone });
            }
          });
          values.family_environment = familyMembers;
          console.log('[åŸºæœ¬æƒ…å ±ä¿å­˜] å®¶æ—æƒ…å ±:', familyMembers.length, 'ä»¶', familyMembers);

          if (USE_FIREBASE) {
            // Firestore save to subcollection: riyousya/{userId}/basicInfo/data
            const { doc, setDoc, collection, serverTimestamp } = window.firebaseModules;
            const userDocRef = doc(window.db, 'riyousya', clientId);
            const basicInfoRef = doc(collection(userDocRef, 'basicInfo'), 'data');

            console.log('[Firebaseä¿å­˜] ãƒ‘ã‚¹: riyousya/' + clientId + '/basicInfo/data');
            console.log('[Firebaseä¿å­˜] clientId:', clientId, 'type:', typeof clientId);
            console.log('[Firebaseä¿å­˜] values:', JSON.stringify(values, null, 2));

            const saveData = {
              userId: clientId,
              values: values,
              files: {},
              lastUpdated: serverTimestamp(),
              updatedBy: 'system'
            };

            console.log('[Firebaseä¿å­˜] saveData:', JSON.stringify(saveData, null, 2));

            await setDoc(basicInfoRef, saveData, { merge: true });

            console.log('[Firebaseä¿å­˜] basicInfo ä¿å­˜æˆåŠŸ');

            // è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚æ›´æ–°
            const parentUpdateData = {};
            if (values.user_name !== undefined) parentUpdateData.name = values.user_name;
            if (values.user_kana !== undefined) parentUpdateData.kana = values.user_kana;
            if (values.care_manager !== undefined) parentUpdateData.manager = values.care_manager;
            if (values.address !== undefined) parentUpdateData.address = values.address;
            if (values.service_types !== undefined) parentUpdateData.service_types = values.service_types;

            if (Object.keys(parentUpdateData).length > 0) {
              const { getDoc } = window.firebaseModules;
              const parentDoc = await getDoc(userDocRef);
              if (parentDoc.exists()) {
                await setDoc(userDocRef, parentUpdateData, { merge: true });
                console.log('[Firebaseä¿å­˜] è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°:', parentUpdateData);
              } else {
                await setDoc(userDocRef, { id: clientId, ...parentUpdateData });
                console.log('[Firebaseä¿å­˜] è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–°è¦ä½œæˆ:', parentUpdateData);
              }

              // allUsersãƒªã‚¹ãƒˆã‚‚æ›´æ–°(ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã®å³æ™‚åæ˜ ç”¨)
              const userIndex = allUsers.findIndex(u => u.id === clientId);
              if (userIndex !== -1) {
                if (parentUpdateData.name) allUsers[userIndex].name = parentUpdateData.name;
                if (parentUpdateData.kana) allUsers[userIndex].kana = parentUpdateData.kana;
                if (parentUpdateData.manager) allUsers[userIndex].manager = parentUpdateData.manager;
                if (parentUpdateData.address) allUsers[userIndex].address = parentUpdateData.address;
                console.log('[åŸºæœ¬æƒ…å ±ä¿å­˜] allUsersæ›´æ–°å®Œäº†');
              }
            }
          } else {
            // GAS save
            const saveData = { values, files: {} };
            await saveUserDataToGAS(clientId, 'basicInfo', saveData);
          }

          showToast('åŸºæœ¬æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');

          // userStatusMapã‚’æ›´æ–°ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          console.log('[åŸºæœ¬æƒ…å ±ä¿å­˜] clientId:', clientId);
          console.log('[åŸºæœ¬æƒ…å ±ä¿å­˜] Google Drive URL:', values.google_drive_url);
          console.log('[åŸºæœ¬æƒ…å ±ä¿å­˜] userStatusMap before update:', userStatusMap[clientId]);

          // userStatusMapãŒå­˜åœ¨ã—ãªã„å ´åˆã®åˆæœŸåŒ–
          if (!userStatusMap[clientId]) {
            userStatusMap[clientId] = {
              basicInfoComplete: false,
              updateDocsComplete: false,
              planFimComplete: false,
              googleDriveUrl: ''
            };
          }

          userStatusMap[clientId].basicInfoComplete = Object.keys(values).length > 0;
          userStatusMap[clientId].googleDriveUrl = values.google_drive_url || '';

          console.log('[åŸºæœ¬æƒ…å ±ä¿å­˜] userStatusMap after update:', userStatusMap[clientId]);

          renderUserTable();

          closeModal('basic-info-modal');
        } catch (err) {
          console.error('[åŸºæœ¬æƒ…å ±ä¿å­˜] ã‚¨ãƒ©ãƒ¼è©³ç´°:', err);
          console.error('[åŸºæœ¬æƒ…å ±ä¿å­˜] ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰', err.code);
          console.error('[åŸºæœ¬æƒ…å ±ä¿å­˜] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', err.message);
          console.error('[åŸºæœ¬æƒ…å ±ä¿å­˜] ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', err.stack);
          showToast('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err.message + (err.code ? ' (' + err.code + ')' : ''), 'error');
        } finally {
          btn.disabled = false; btn.textContent = 'ã“å†…å®¹ã§æ›´æ–°ã™ã‚‹';
        }
      }
    });

    /* ================================================================
       æ›´æ–°æ›¸é¡)-4 å¸¸æ™‚+ 5:FIM æŠ˜ã‚ŠãŸãŸã¿ + 6:åŸºæœ¬ãƒã‚§ãƒƒã‚¯ æŠ˜ã‚ŠãŸãŸã¿)
    ================================================================ */
    const updateModal = document.getElementById('update-modal');
    const updateForm = document.getElementById('update-form');
    const updateLoader = document.getElementById('update-loader');
    const updateDynamicFields = document.getElementById('update-dynamic-fields');
    const updateHistory = document.getElementById('update-history');

    const SUPPORT_HOUR_OPTIONS = [
      { value: '', label: 'æœªé¸æŠ' },
      ...Array.from({ length: 200 }, (_, idx) => {
        const hour = idx + 1;
        const label = `${hour}æ™‚é–“`;
        return { value: label, label };
      })
    ];

    const SERVICE_TYPE_OPTIONS = [
      { value: '', label: 'é¸æŠã—ã¦ãã ã•ã„' },
      { value: '111000', label: '111000 - èº«ä½“ä»‹è­·' },
      { value: '112000', label: '112000 - å®¶äº‹æ´åŠ©' },
      { value: '113000', label: '113000 - é€šé™¢ï¼ˆèº«ä½“ä»‹è­·ã‚ã‚Šï¼‰' },
      { value: '114000', label: '114000 - é€šé™¢ï¼ˆèº«ä½“ä»‹è­·ãªã—ï¼‰' },
      { value: '153000', label: '153000 - åŒè¡Œæ´è­·' },
      { value: 'A11000', label: 'A11000 - ç§»å‹•æ”¯æ´' },
      { value: 'DK0001', label: 'DK0001 - äºŒäººä»‹åŠ©' }
    ];

    const DEFAULT_UPDATE_SCHEMA = [
      {
        id: 'status', label: '1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', type: 'select', options: [
          { value: 'åˆ©ç”¨ä¸­', label: 'åˆ©ç”¨ä¸­' }, { value: 'çµ‚äº†', label: 'çµ‚äº†' }, { value: 'ä¸­æ–­ä¸­', label: 'ä¸­æ–­ä¸­' }
        ]
      },
      { id: 'monitoring_date', label: '2. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ—¥', type: 'date' },
      { id: 'plan_end_date', label: '3. è¨ˆç”»æ›¸çµ‚äº†', type: 'date' },
      { id: 'recipient_end_date', label: '4. å—çµ¦è¨¼çµ‚äº†æ—¥', type: 'date' },
      { id: 'support_services', label: '5. ã‚µãƒ¼ãƒ“ã‚¹åˆ¥æœˆé–“æ”¯çµ¦é‡', type: 'serviceList' }
    ];

    const FIM_LEVELS = [
      { value: '1:å®Œå…¨è‡ªç«‹', label: '1: å®Œå…¨è‡ªç«‹' },
      { value: '2:ä¿®æ­£è‡ªç«‹', label: '2: ä¿®æ­£è‡ªç«‹' },
      { value: '3:ç›£è¦–åˆã¯æº–å‚™', label: '3: ç›£è¦–åˆã¯æº–å‚™' },
      { value: '4:æœ€å°ä»‹åŠ©', label: '4: æœ€å°ä»‹åŠ©' },
      { value: '5:ä¸­ç­‰åº¦ä»‹åŠ©', label: '5: ä¸­ç­‰åº¦ä»‹åŠ©' },
      { value: '6:æœ€å¤§ä»‹åŠ©', label: '6: æœ€å¤§ä»‹åŠ©' },
      { value: '7:å…¨ä»‹åŠ©', label: '7: å…¨ä»‹åŠ©' }
    ];
    const YES_NO_REMARK = [
      { value: 'ã¯ã„', label: 'ã¯ã„' },
      { value: 'ã„ã„ãˆ', label: 'ã„ã„ãˆ' },
      { value: 'å‚™è€ƒ', label: 'å‚™è€ƒ' }
    ];
    const FIM_FIELDS = [
      { id: 'fim_eating', label: 'é£Ÿäº‹', type: 'select', options: FIM_LEVELS },
      { id: 'fim_grooming', label: 'æ•´å®¹', type: 'select', options: FIM_LEVELS },
      { id: 'fim_bathing', label: 'æ¸…æ‹­/å…¥æµ´', type: 'select', options: FIM_LEVELS },
      { id: 'fim_upper_dress', label: 'æ›´è¡£(ä¸ŠåŠèº«)', type: 'select', options: FIM_LEVELS },
      { id: 'fim_lower_dress', label: 'æ›´è¡£(ä¸‹åŠèº«)', type: 'select', options: FIM_LEVELS },
      { id: 'fim_toileting', label: 'ãƒˆã‚¤ãƒ¬å‹•ä½œ', type: 'select', options: FIM_LEVELS },
      { id: 'fim_urination', label: 'æ’å°¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', type: 'select', options: FIM_LEVELS },
      {
        id: 'fim_urination_tool', label: 'æ’å°¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« - ç”¨å…·', type: 'select', options: [
          { value: 'ãƒˆã‚¤ãƒ¬', label: 'ãƒˆã‚¤ãƒ¬' }, { value: 'Pãƒˆã‚¤ãƒ¬', label: 'Pãƒˆã‚¤ãƒ¬' }, { value: 'ãŠã‚€ã¤', label: 'ãŠã‚€ã¤' }, { value: 'ãƒãƒ«ãƒ¼ãƒ³ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«', label: 'ãƒãƒ«ãƒ¼ãƒ³ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«' }
        ]
      },
      { id: 'fim_urination_sense', label: 'æ’å°¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« - å°¿æ„', type: 'select', options: [{ value: 'ã‚ã‚Š', label: 'ã‚ã‚Š' }, { value: 'ãªã—', label: 'ãªã—' }] },
      { id: 'fim_urination_incontinence', label: 'æ’å°¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« - å°¿å¤±ç¦', type: 'select', options: [{ value: 'ã‚ã‚Š', label: 'ã‚ã‚Š' }, { value: 'ãªã—', label: 'ãªã—' }] },
      { id: 'fim_defecation', label: 'æ’ä¾¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', type: 'select', options: FIM_LEVELS },
      {
        id: 'fim_defecation_tool', label: 'æ’ä¾¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« - ç”¨å…·', type: 'select', options: [
          { value: 'ãƒˆã‚¤ãƒ¬', label: 'ãƒˆã‚¤ãƒ¬' }, { value: 'Pãƒˆã‚¤ãƒ¬', label: 'Pãƒˆã‚¤ãƒ¬' }, { value: 'ãŠã‚€ã¤', label: 'ãŠã‚€ã¤' }, { value: 'ã‚¹ãƒˆãƒ¼ãƒï¼ˆäººå·¥è‚›é–€)', label: 'ã‚¹ãƒˆãƒ¼ãƒï¼ˆäººå·¥è‚›é–€)' }
        ]
      },
      { id: 'fim_defecation_sense', label: 'æ’ä¾¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« - ä¾¿æ„', type: 'select', options: [{ value: 'ã‚ã‚Š', label: 'ã‚ã‚Š' }, { value: 'ãªã—', label: 'ãªã—' }] },
      { id: 'fim_defecation_incontinence', label: 'æ’ä¾¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« - ä¾¿å¤±ç¦', type: 'select', options: [{ value: 'ã‚ã‚Š', label: 'ã‚ã‚Š' }, { value: 'ãªã—', label: 'ãªã—' }] },
      { id: 'fim_transfer_bed_wheelchair', label: 'ç§»ä¹—- ãƒ™ãƒƒãƒ‰ãƒ»è»Šæ¤…å­', type: 'select', options: FIM_LEVELS },
      { id: 'fim_transfer_toilet', label: 'ç§»ä¹—- ãƒˆã‚¤ãƒ¬', type: 'select', options: FIM_LEVELS },
      { id: 'fim_rollover', label: 'å¯è¿”ã‚Š', type: 'select', options: FIM_LEVELS },
      { id: 'fim_situp', label: 'èµ·ãä¸ŠãŒã‚Š', type: 'select', options: FIM_LEVELS },
      { id: 'fim_standup', label: 'ç«‹ã¡ä¸ŠãŒã‚Š', type: 'select', options: FIM_LEVELS },
      { id: 'fim_sitting_balance', label: 'åº§ä½ã®ä¿æŒ', type: 'select', options: FIM_LEVELS },
      { id: 'fim_standing_balance', label: 'ç«‹ä½ã®ä¿æŒ', type: 'select', options: FIM_LEVELS },
      { id: 'fim_transfer_bath', label: 'æµ´æ§½ãƒ»ã‚·ãƒ£ãƒ¯ãƒ¼ç§»ä¹—', type: 'select', options: FIM_LEVELS },
      { id: 'fim_walk_wheel', label: 'æ­©è¡Œãƒ»è»Šæ¤…å­ç§»å‹•', type: 'select', options: FIM_LEVELS },
      {
        id: 'fim_walk_aids_in', label: 'æ­©è¡Œãƒ»è»Šæ¤…å­ç§»å‹•- ç§»å‹•ï¼ˆå®¤å†…ï¼‰', type: 'select', options: [
          { value: 'ãªã—', label: 'ãªã—' }, { value: 'æ–', label: 'æ–' }, { value: 'æ­©è¡Œå™¨', label: 'æ­©è¡Œå™¨' }, { value: 'è»Šæ¤…å­', label: 'è»Šæ¤…å­' }, { value: 'ãã®ä»–', label: 'ãã®ä»–' }
        ]
      },
      {
        id: 'fim_walk_aids_out', label: 'æ­©è¡Œãƒ»è»Šæ¤…å­ç§»å‹•- ç§»å‹•ï¼ˆå®¤å¤–)', type: 'select', options: [
          { value: 'ãªã—', label: 'ãªã—' }, { value: 'æ–', label: 'æ–' }, { value: 'æ­©è¡Œå™¨', label: 'æ­©è¡Œå™¨' }, { value: 'è»Šæ¤…å­', label: 'è»Šæ¤…å­' }, { value: 'ãã®ä»–', label: 'ãã®ä»–' }
        ]
      },
      { id: 'fim_stairs', label: 'éšæ®µç§»å‹•', type: 'select', options: FIM_LEVELS },
      { id: 'fim_comprehension', label: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ç†è§£', type: 'select', options: FIM_LEVELS },
      { id: 'fim_expression', label: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - è¡¨å‡º', type: 'select', options: FIM_LEVELS },
      { id: 'fim_social_interaction', label: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ç¤¾ä¼šçš„äº¤æµ', type: 'select', options: FIM_LEVELS },
      { id: 'fim_problem_solving', label: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - å•é¡Œè§£æ±º', type: 'select', options: FIM_LEVELS },
      { id: 'fim_memory', label: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - è¨˜æ†¶', type: 'select', options: FIM_LEVELS },
      { id: 'fim_note', label: 'FIM å‚™è€ƒ', type: 'textarea', rows: 2 }
    ];

    const BASIC_CHECK_FIELDS = [
      { id: 'bc_q1', label: '1. æ—¥ç”¨å“ã®è²·ã„ç‰©ã‚’ã—ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q2', label: '2. å‹äººã®å®¶ã‚’è¨ªã­ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q3', label: '3. å®¶æ—ã‚„å‹äººã®ç›¸è«‡ã«ä¹—ã£ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q4', label: '4. éšæ®µã‚’æ‰‹ã™ã‚Šã‚„å£ã‚’ã¤ãŸã‚ã‚‰ãšã«ä¸Šã£ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q5', label: '5. æ¤…å­ã«åº§ã£ãŸçŠ¶æ…‹ã‹ã‚‰ä½•ã«ã‚‚ã¤ã‹ã¾ã‚‰ãšã«ç«‹ã¡ä¸ŠãŒã£ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q6', label: '6. 15åˆ†ç¶šã‘ã¦æ­©ã„ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q7', label: '7. ã“ã®ä¸€å¹´é–“ã«è»¢ã‚“ã ã“ã¨ãŒã‚ã‚Šã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q8', label: '8. è»¢å€’ã«å¯¾ã™ã‚‹ä¸å®‰ã¯å¤§ãã„ã§ã™ã‹', type: 'ynr' },
      { id: 'bc_q9', label: '9. 6ã‹æœˆé–“ã§2kgã‹ã‚‰3kgä»¥ä¸Šã®ä½“é‡æ¸›å°‘ãŒã‚ã‚Šã¾ã—ãŸã‹', type: 'ynr' },
      { id: 'bc_q10', label: '10. èº«é•·(m)', type: 'number' },
      { id: 'bc_q11', label: '11. ä½“é‡(kg)', type: 'number' },
      { id: 'bc_q12', label: '12. åŠå¹´å‰ã«æ¯”ã¹ã¦å›ºã„ã‚‚ã®ãŒé£Ÿã¹ã«ãããªã‚Šã¾ã—ãŸã‹', type: 'ynr' },
      { id: 'bc_q13', label: '13. ãŠèŒ¶ã‚„æ±ç‰©ã§ã‚€ã›ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q14', label: '14. å£ã®æ¸‡ããŒæ°—ã«ãªã‚Šã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q15', label: '15. é€±ã«1å›ä»¥ä¸Šã¯å¤–å‡ºã—ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q16', label: '16. å‘¨ã‚Šã®äººã‹ã‚‰ã€Œã„ã¤ã‚‚åŒã˜ã“ã¨ã‚’èãã€ãªã©ã®ç‰©å¿˜ã‚ŒãŒã‚ã‚‹ã¨è¨€ã‚ã‚Œã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q17', label: '17. è‡ªåˆ†ã§é›»è©±ç•ªå·ã‚’èª¿ã¹ã¦é›»è©±ã‚’ã‹ã‘ã‚‹ã“ã¨ã‚’ã—ã¦ã„ã¾ã™ã‹', type: 'ynr' },
      { id: 'bc_q18', label: '18. ä»Šæ—¥ãŒä½•æœˆä½•æ—¥ã‹ã‚ã‹ã‚‰ãªã„æ™‚ãŒã‚ã‚Šã¾ã™ã‹', type: 'ynr' }
    ];

    /* ================================================================
       è¨ˆç”»æ›¸(FIM) ã‚¹ã‚­ãƒ¼ãƒ
    ================================================================ */
    const PLAN_FIELDS = [
      // ä»‹è­·ä¿é™ºäº‹æ¥­æ‰€æƒ…å ±
      { id: 'care_office_number', label: 'ä»‹è­·ä¿é™ºäº‹æ¥­æ‰€ç•ªå·', type: 'text' },
      { id: 'office_name', label: 'äº‹æ¥­æ‰€å', type: 'text' },
      { id: 'office_address', label: 'ä½æ‰€', type: 'text' },
      { id: 'office_tel', label: 'TEL', type: 'text' },

      // ã‚±ã‚¢è¨ˆç”»è¡¨ï¼ˆå‹•çš„ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
      { id: 'care_plan_table', label: 'ã‚±ã‚¢è¨ˆç”»', type: 'careTable' },

      // ãã®ä»–ã®è¨ˆç”»æ›¸é …ç›®
      { id: 'care_procedure', label: 'ã‚±ã‚¢æ‰‹é †', type: 'textarea', rows: 4 },
      { id: 'comprehensive_support_policy', label: 'ç·åˆçš„æ´åŠ©ã®æ–¹é‡', type: 'textarea', rows: 3 },
      { id: 'client_family_wishes', label: 'æœ¬äººãƒ»å®¶æ—ã®å¸Œæœ›', type: 'textarea', rows: 3 },
      { id: 'long_term_goal', label: 'é•·æœŸç›®æ¨™', type: 'textarea', rows: 3 },
      { id: 'plan_remarks', label: 'å‚™è€ƒ', type: 'textarea', rows: 2 },
      { id: 'medical_advice_physical', label: 'åŒ»ç™‚ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹(èº«ä½“é¢)', type: 'textarea', rows: 2 },
      { id: 'medical_advice_lifestyle', label: 'åŒ»ç™‚ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹(ç”Ÿæ´»é¢)', type: 'textarea', rows: 2 },
      { id: 'creator_name', label: 'ä½œæˆè€…', type: 'text' },
      { id: 'explanation_date', label: 'èª¬æ˜æ—¥', type: 'date' },
      { id: 'explainer_name', label: 'èª¬æ˜è€…', type: 'text' }
    ];

    const DEFAULT_PLAN_FIM_SCHEMA = [
      { id: 'plan_header', label: '1. è¨ˆç”»æ›¸', type: 'sectionHeader' },
      { id: 'plan_toggle', label: 'è¨ˆç”»æ›¸ã®è©³ç´°ã‚’é–‹ã', type: 'toggleButton' },
      { id: 'fim_header', label: '2. FIM', type: 'sectionHeader' },
      { id: 'fim_toggle', label: 'FIMã®è©³ç´°ã‚’é–‹ã', type: 'toggleButton' },
      { id: 'basic_header', label: '3. åŸºæœ¬ãƒã‚§ãƒƒã‚¯', type: 'sectionHeader' },
      { id: 'basic_toggle', label: 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‹ã', type: 'toggleButton' }
    ];

    function normalizeSupportServices(raw) {
      if (!raw) return [];
      let data = raw;
      if (typeof raw === 'string') {
        try { data = JSON.parse(raw); } catch (e) { data = []; }
      }
      if (!Array.isArray(data)) return [];

      // æ—¥æœ¬èªåâ†’ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›ãƒãƒƒãƒ”ãƒ³ã‚°
      const serviceNameToCode = {
        'èº«ä½“': '111000',
        'å®¶äº‹æ´åŠ©': '112000',
        'é€šé™¢ï¼ˆèº«ä½“ä»‹è­·ã‚ã‚Šï¼‰': '113000',
        'é€šé™¢ï¼ˆèº«ä½“ä»‹è­·ãªã—ï¼‰': '114000',
        'åŒè¡Œæ´è­·': '153000',
        'ç§»å‹•': 'A11000',
        'äºŒäººä»‹åŠ©': 'DK0001'
      };

      return data.map(item => {
        let type = (item && (item.type || item.serviceType)) || '';
        // æ—¥æœ¬èªåã®å ´åˆã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
        if (serviceNameToCode[type]) {
          type = serviceNameToCode[type];
        }
        const limitValue = item ? item.monthlyLimit : '';
        const parsedLimit = typeof limitValue === 'number' ? limitValue : parseFloat(limitValue);
        return {
          type: type || '',
          monthlyLimit: Number.isFinite(parsedLimit) ? parsedLimit : ''
        };
      });
    }

    function updateSupportTotals(services, fallbackText = '') {
      const total = Array.isArray(services)
        ? services.reduce((sum, svc) => {
          const h = typeof svc.hours === 'number' ? svc.hours : parseFloat(svc.hours);
          return sum + (Number.isFinite(h) ? h : 0);
        }, 0)
        : 0;

      let totalText = '';
      if (total > 0) {
        totalText = `${total}\u6642\u9593`;
      } else if (fallbackText) {
        totalText = fallbackText;
      } else {
        totalText = '0\u6642\u9593';
      }

      document.querySelectorAll('[data-support-total]').forEach(el => {
        el.textContent = `\u7dcf\u652f\u7d66\u91cf: ${totalText}`;
      });
      const totalInput = document.getElementById('ud_total_support_hours');
      if (totalInput) {
        totalInput.value = totalText;
        // æœˆé–“ã‚·ãƒ•ãƒˆã¨ã®é€£æºç”¨ã«æ•°å€¤ã‚‚ä¿å­˜
        totalInput.dataset.numericValue = total;
      }
      const legacySupportHours = document.getElementById('ud_support_hours');
      if (legacySupportHours) {
        legacySupportHours.value = totalText;
        legacySupportHours.dataset.numericValue = total;
      }
    }

    function renderServiceListField(wrap, field, values) {
      const label = document.createElement('label'); label.textContent = field.label || '\u30b5\u30fc\u30d3\u30b9\u3092\u8ffd\u52a0';
      wrap.appendChild(label);

      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.id = `ud_${field.id}`;
      hidden.dataset.udField = field.id;
      hidden.dataset.json = 'true';
      hidden.classList.add('ud-field');
      hidden.value = '[]';
      wrap.appendChild(hidden);

      const listBox = document.createElement('div');
      listBox.className = 'service-list';

      const helper = document.createElement('div');
      helper.className = 'help';
      helper.textContent = 'ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡ã”ã¨ã«æœˆé–“æ”¯çµ¦é‡ï¼ˆæ™‚é–“ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
      listBox.appendChild(helper);

      const itemsContainer = document.createElement('div');
      itemsContainer.className = 'service-items';
      listBox.appendChild(itemsContainer);

      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'btn btn-secondary';
      addBtn.textContent = '\u30b5\u30fc\u30d3\u30b9\u3092\u8ffd\u52a0';
      addBtn.style.marginTop = '8px';


      const syncServices = () => {
        const services = Array.from(itemsContainer.querySelectorAll('.service-item')).map(row => {
          const type = row.querySelector('.service-type').value;
          const limitVal = row.querySelector('.service-limit').value;
          const parsedLimit = limitVal === '' ? '' : parseFloat(limitVal);
          return {
            type,
            monthlyLimit: Number.isFinite(parsedLimit) ? parsedLimit : ''
          };
        }).filter(svc => svc.type || svc.monthlyLimit !== '');
        hidden.value = JSON.stringify(services);
      };

      const addItemRow = (item = {}) => {
        const row = document.createElement('div');
        row.className = 'service-item';

        const select = document.createElement('select');
        select.className = 'service-type';
        SERVICE_TYPE_OPTIONS.forEach(opt => {
          const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.label;
          select.appendChild(o);
        });
        if (item.type) select.value = item.type;

        const limitInput = document.createElement('input');
        limitInput.type = 'number';
        limitInput.min = '0';
        limitInput.step = '0.5';
        limitInput.placeholder = 'æœˆé–“æ”¯çµ¦é‡ï¼ˆæ™‚é–“ï¼‰';
        limitInput.className = 'service-limit';
        if (item.monthlyLimit !== undefined && item.monthlyLimit !== '') limitInput.value = item.monthlyLimit;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = 'å‰Šé™¤';

        [select, limitInput].forEach(el => el.addEventListener('input', () => syncServices()));
        removeBtn.addEventListener('click', () => {
          row.remove();
          if (itemsContainer.children.length === 0) {
            addItemRow();
          }
          syncServices();
        });

        row.appendChild(select);
        row.appendChild(limitInput);
        row.appendChild(removeBtn);
        itemsContainer.appendChild(row);
      };

      const initialServices = normalizeSupportServices(values[field.id]);
      if (initialServices.length > 0) {
        initialServices.forEach(item => addItemRow(item));
      } else {
        addItemRow();
      }

      addBtn.addEventListener('click', () => {
        addItemRow();
        syncServices();
      });

      listBox.appendChild(addBtn);
      wrap.appendChild(listBox);

      syncServices();
    }
    /* --- æ›´æ–°æ›¸é¡æç”»ãƒ»ä¿å­˜ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰--- */
    function renderBySchema(schema, values = {}, fileLinks = {}) {
      updateDynamicFields.innerHTML = '';
      const frag = document.createDocumentFragment();
      const currentUserId = document.getElementById('update-clientId').value;

      const fimOpen = window.__fimOpen ?? false;
      const basicOpen = window.__basicOpen ?? false;

      schema.forEach(field => {
        const wrap = document.createElement('div'); wrap.className = 'form-group';

        if (field.type === 'sectionHeader') {
          const label = document.createElement('label'); label.textContent = field.label; label.style.marginBottom = '0';
          wrap.appendChild(label);
          frag.appendChild(wrap);
          return;
        }

        if (field.type === 'toggleButton') {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-secondary';
          btn.textContent = field.id === 'fim_toggle'
            ? (fimOpen ? 'FIMã®è©³ç´°ã‚’é–‰ã˜ã‚‹' : 'FIMã®è©³ç´°ã‚’é–‹ã')
            : (basicOpen ? 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‰ã˜ã‚‹' : 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‹ã');
          btn.style.marginTop = '4px';

          const container = document.createElement('div');
          container.id = (field.id === 'fim_toggle') ? 'fim-section' : 'basiccheck-section';
          container.style.display = (field.id === 'fim_toggle')
            ? (fimOpen ? 'block' : 'none')
            : (basicOpen ? 'block' : 'none');
          container.style.padding = '12px';
          container.style.border = '1px dashed #ddd';
          container.style.borderRadius = '8px';
          container.style.background = '#fcfcfc';
          container.style.marginTop = '10px';

          if (field.id === 'fim_toggle') {
            renderFieldGroup(container, FIM_FIELDS, values);
            btn.addEventListener('click', () => {
              const isOpen = container.style.display !== 'none';
              container.style.display = isOpen ? 'none' : 'block';
              btn.textContent = isOpen ? 'FIMã®è©³ç´°ã‚’é–‹ã' : 'FIMã®è©³ç´°ã‚’é–‰ã˜ã‚‹';
              window.__fimOpen = !isOpen;
            });
          } else {
            renderBasicCheckGroup(container, BASIC_CHECK_FIELDS, values);
            btn.addEventListener('click', () => {
              const isOpen = container.style.display !== 'none';
              container.style.display = isOpen ? 'none' : 'block';
              btn.textContent = isOpen ? 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‹ã' : 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‰ã˜ã‚‹';
              window.__basicOpen = !isOpen;
            });
          }

          wrap.appendChild(btn);
          wrap.appendChild(container);
          frag.appendChild(wrap);
          return;
        }

        if (field.type === 'serviceList') {
          renderServiceListField(wrap, field, values);
          frag.appendChild(wrap);
          return;
        }

        const label = document.createElement('label'); label.htmlFor = `ud_${field.id}`; label.textContent = field.label || field.id;
        wrap.appendChild(label);

        let input;
        if (field.type === 'textarea') {
          input = document.createElement('textarea'); input.rows = field.rows || 3; input.value = values[field.id] || '';
        } else if (field.type === 'select') {
          input = document.createElement('select');
          (field.options || []).forEach(opt => {
            const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.label || opt.value;
            if (values[field.id] === opt.value) o.selected = true;
            input.appendChild(o);
          });
          if (field.id === 'status') {
            input.addEventListener('change', function () { handleModalStatusChange(this, currentUserId); });
          }
        } else if (field.type === 'readonly') {
          input = document.createElement('input'); input.type = 'text'; input.value = values[field.id] || '';
          input.readOnly = true;
        } else {
          input = document.createElement('input'); input.type = field.type || 'text'; input.value = values[field.id] || '';
        }
        input.id = `ud_${field.id}`; input.dataset.udField = field.id; input.classList.add('ud-field');
        wrap.appendChild(input);
        if (field.help) { const h = document.createElement('div'); h.className = 'help'; h.textContent = field.help; wrap.appendChild(h); }
        frag.appendChild(wrap);
      });

      updateDynamicFields.appendChild(frag);
    }

    function renderFieldGroup(container, fields, values) {
      container.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'grid-2';
      fields.forEach(f => {
        const wrap = document.createElement('div'); wrap.className = 'form-group';
        const label = document.createElement('label'); label.htmlFor = `ud_${f.id}`; label.textContent = f.label;
        wrap.appendChild(label);
        let input;
        if (f.type === 'textarea') {
          input = document.createElement('textarea'); input.rows = f.rows || 2; input.value = values[f.id] || '';
        } else if (f.type === 'select') {
          input = document.createElement('select');
          (f.options || []).forEach(opt => {
            const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.label || opt.value;
            if (values[f.id] === opt.value) o.selected = true;
            input.appendChild(o);
          });
        } else if (f.type === 'number') {
          input = document.createElement('input'); input.type = 'number'; input.step = 'any'; input.value = values[f.id] ?? '';
        } else {
          input = document.createElement('input'); input.type = 'text'; input.value = values[f.id] ?? '';
        }
        input.id = `ud_${f.id}`; input.dataset.udField = f.id; input.classList.add('ud-field');
        wrap.appendChild(input);
        grid.appendChild(wrap);
      });
      container.appendChild(grid);
    }

    function renderBasicCheckGroup(container, fields, values) {
      container.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'grid-2';

      fields.forEach(f => {
        const wrap = document.createElement('div'); wrap.className = 'form-group';
        const label = document.createElement('label'); label.htmlFor = `ud_${f.id}`; label.textContent = f.label;
        wrap.appendChild(label);

        if (f.type === 'number') {
          const input = document.createElement('input'); input.type = 'number'; input.step = 'any';
          input.id = `ud_${f.id}`; input.dataset.udField = f.id; input.classList.add('ud-field');
          input.value = (values[f.id] ?? '');
          wrap.appendChild(input);
          grid.appendChild(wrap);
          return;
        }

        if (f.type === 'ynr') {
          const select = document.createElement('select');
          select.id = `ud_${f.id}`; select.dataset.udField = f.id; select.classList.add('ud-field');
          YES_NO_REMARK.forEach(opt => {
            const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.label; select.appendChild(o);
          });
          if (values[f.id]) select.value = values[f.id];

          const noteWrap = document.createElement('div');
          noteWrap.style.marginTop = '8px';
          const note = document.createElement('input');
          note.type = 'text';
          note.placeholder = 'å‚™è€ƒã‚’å…¥åŠ›';
          note.id = `ud_${f.id}_note`;
          note.dataset.udField = `${f.id}_note`;
          note.classList.add('ud-field');
          note.value = values[`${f.id}_note`] ?? '';

          const toggleNote = () => {
            const show = select.value === 'å‚™è€ƒ';
            noteWrap.style.display = show ? 'block' : 'none';
            if (!show) note.value = values[`${f.id}_note`] ?? note.value;
          };
          toggleNote();
          select.addEventListener('change', toggleNote);

          wrap.appendChild(select);
          noteWrap.appendChild(note);
          wrap.appendChild(noteWrap);
          grid.appendChild(wrap);
          return;
        }

        const input = document.createElement('input'); input.type = 'text';
        input.id = `ud_${f.id}`; input.dataset.udField = f.id; input.classList.add('ud-field');
        input.value = values[f.id] ?? '';
        wrap.appendChild(input);
        grid.appendChild(wrap);
      });

      container.appendChild(grid);
    }

    async function openUpdateModal(userId, userName) {
      console.log('[Debug] openUpdateModal called', userId, userName);
      document.getElementById('update-modal-user-name').textContent = userName;
      document.getElementById('update-clientId').value = userId;
      const modal = document.getElementById('update-modal');
      if (modal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒ†ãƒ¼
        modal.style.display = '';
        modal.classList.remove('visible');

        // å°‘ã—å»¶ã•ã›ã¦ç¢ºå®Ÿã«è¡¨ç¤º
        setTimeout(() => {
          modal.style.display = 'flex';
          modal.classList.add('visible');
          console.log('[Debug] Update modal opened');
        }, 10);
      } else {
        console.error('[Debug] Update modal not found!');
      }
      const loader = document.getElementById('update-loader');
      if (loader) loader.style.display = 'block';
      const formBody = document.getElementById('update-form-body');
      if (formBody) formBody.style.display = 'none';
      const dynamicFields = document.getElementById('update-dynamic-fields');
      if (dynamicFields) dynamicFields.innerHTML = '';
      const history = document.getElementById('update-history');
      if (history) history.innerHTML = '';

      try {
        let values = {};
        let history = [];

        if (USE_FIREBASE) {
          // Load from Firestore subcollection: riyousya/data/users/{userId}/updateDoc/data
          const { doc, getDoc, collection } = window.firebaseModules;
          const userDocRef = doc(window.db, 'riyousya', userId);
          const updateDocRef = doc(collection(userDocRef, 'updateDoc'), 'data');
          const updateDocSnapshot = await getDoc(updateDocRef);

          if (updateDocSnapshot.exists()) {
            const updateDocData = updateDocSnapshot.data();
            values = updateDocData.values || {};

            // Convert Firestore Timestamps back to date strings for form display
            const convertedValues = {};
            for (const key in values) {
              if (values[key] && values[key].toDate) {
                // This is a Firestore Timestamp
                convertedValues[key] = timestampToDateString(values[key]);
              } else {
                convertedValues[key] = values[key];
              }
            }
            values = convertedValues;
          }
          // Load history from Firestore (if needed)
          history = await getUserHistoryFromGAS(userId, 'updateDoc');
        } else {
          // Load from GAS
          const savedData = await getUserDataFromGAS(userId, 'updateDoc');
          values = savedData ? savedData.values || {} : {};
          history = await getUserHistoryFromGAS(userId, 'updateDoc');
        }

        renderBySchema(DEFAULT_UPDATE_SCHEMA, values, {});
        renderHistory(history);
        updateForm.dataset.schema = JSON.stringify(DEFAULT_UPDATE_SCHEMA);

      } catch (e) {
        console.warn('æ›´æ–°æ›¸é¡åˆæœŸåŒ–ã«å¤±æ•—', e);
        renderBySchema(DEFAULT_UPDATE_SCHEMA, {}, {});
      } finally {
        updateLoader.style.display = 'none';
        document.getElementById('update-form-body').style.display = 'block';
      }
    }

    function renderHistory(history = []) {
      if (!Array.isArray(history) || history.length === 0) { updateHistory.innerHTML = ''; return; }
      updateHistory.innerHTML = `
    <div class="section-title">ä¿å­˜å±¥æ­´</div>
    <div class="grid-3">
      ${history.map(h => `
        <div style="border:1px solid #eee;border-radius:8px;padding:10px;background:#fafafa;">
          <div style="font-size:12px;color:#666;">${escapeHtml(h.user || 'system')}</div>
          <div style="font-weight:700;">${escapeHtml(h.action || 'æ›´æ–°')}</div>
          <div style="font-size:12px;color:#666;">${escapeHtml(h.ts || '')}</div>
        </div>`).join('')}
    </div>`;
    }
    function escapeHtml(str) { return String(str || '').replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s])); }

    updateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('update-submit-button');
      btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­...';
      try {
        const clientId = document.getElementById('update-clientId').value;
        const values = {};
        for (const el of document.querySelectorAll('#update-form .ud-field')) {
          const key = el.dataset.udField;
          if (el.type !== 'file') {
            let value = el.value;
            if (el.dataset.json === 'true') {
              try {
                value = JSON.parse(value || '[]');
              } catch (err) {
                value = [];
              }
            }
            // ??????????????)imestamp??????
            values[key] = value;
          }
        }
        const statusField = document.getElementById('ud_status');
        if (statusField && statusField.value) handleModalStatusChange(statusField, clientId);

        const saveData = { values, files: {} };
        if (USE_FIREBASE) {
          if (!window.firebaseModules || !window.db) {
            throw new Error('FirebaseæœªåˆæœŸåŒ–ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
          }
          const result = await saveUserDataToFirebase(clientId, 'updateDoc', saveData);
          if (result && result.status === 'error') {
            throw new Error(result.message || 'Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          await saveUserDataToGAS(clientId, 'updateDoc', saveData);
        }

        showToast('æ›´æ–°æ›¸é¡ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        closeModal('update-modal');
      } catch (err) {
        console.error('Update form save error:', err);
        showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'ã“ã®å†…å®¹ã§æ›´æ–°ã™ã‚‹';
      }
    });

    /* ================================================================
       è¨ˆç”»æ›¸(FIM) - é–‹ããƒ»æç”»ãƒ»ä¿å­˜
    ================================================================ */
    const planFimModal = document.getElementById('plan-fim-modal');
    const planFimForm = document.getElementById('plan-fim-form');
    const planFimLoader = document.getElementById('plan-fim-loader');
    const planFimDynamicFields = document.getElementById('plan-fim-dynamic-fields');
    const planFimHistory = document.getElementById('plan-fim-history');

    // è¨ˆç”»æ›¸ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
    function updatePlanFimButtons(serviceTypes) {
      const shogaiBtn = document.getElementById('plan-fim-pdf-shogai-button');
      const kaigoBtn = document.getElementById('plan-fim-pdf-kaigo-button');
      const idoBtn = document.getElementById('plan-fim-pdf-ido-button');

      if (!Array.isArray(serviceTypes) || serviceTypes.length === 0) {
        // æœªè¨­å®šã®å ´åˆã¯ã™ã¹ã¦éè¡¨ç¤º
        if (shogaiBtn) shogaiBtn.style.display = 'none';
        if (kaigoBtn) kaigoBtn.style.display = 'none';
        if (idoBtn) idoBtn.style.display = 'none';
        return;
      }

      // è©²å½“ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º
      if (shogaiBtn) shogaiBtn.style.display = serviceTypes.includes('éšœå®³') ? 'block' : 'none';
      if (kaigoBtn) kaigoBtn.style.display = serviceTypes.includes('ä»‹è­·') ? 'block' : 'none';
      if (idoBtn) idoBtn.style.display = serviceTypes.includes('ç§»å‹•') ? 'block' : 'none';
    }

    async function openPlanFimModal(userId, userName) {
      console.log('[Debug] openPlanFimModal called', userId, userName);
      document.getElementById('plan-fim-modal-user-name').textContent = userName;
      document.getElementById('plan-fim-clientId').value = userId;
      const modal = document.getElementById('plan-fim-modal');
      if (modal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒ†ãƒ¼
        modal.style.display = '';
        modal.classList.remove('visible');

        // å°‘ã—å»¶ã•ã›ã¦ç¢ºå®Ÿã«è¡¨ç¤º
        setTimeout(() => {
          modal.style.display = 'flex';
          modal.classList.add('visible');
          console.log('[Debug] Plan-FIM modal opened');
        }, 10);
      } else {
        console.error('[Debug] Plan-FIM modal not found!');
      }
      const loader = document.getElementById('plan-fim-loader');
      if (loader) loader.style.display = 'block';
      const formBody = document.getElementById('plan-fim-form-body');
      if (formBody) formBody.style.display = 'none';
      const dynamicFields = document.getElementById('plan-fim-dynamic-fields');
      if (dynamicFields) dynamicFields.innerHTML = '';
      const history = document.getElementById('plan-fim-history');
      if (history) history.innerHTML = '';

      try {
        let values = {};
        let serviceTypes = [];

        if (USE_FIREBASE) {
          // Load from Firestore subcollection: riyousya/data/users/{userId}/planFim/data
          const { doc, getDoc, collection } = window.firebaseModules;
          const userDocRef = doc(window.db, 'riyousya', userId);
          const planFimDocRef = doc(collection(userDocRef, 'planFim'), 'data');
          const planFimDocSnapshot = await getDoc(planFimDocRef);

          if (planFimDocSnapshot.exists()) {
            const planFimDocData = planFimDocSnapshot.data();
            values = planFimDocData.values || {};

            // Convert Firestore Timestamps back to date strings for form display
            const convertedValues = {};
            for (const key in values) {
              if (values[key] && values[key].toDate) {
                convertedValues[key] = timestampToDateString(values[key]);
              } else {
                convertedValues[key] = values[key];
              }
            }
            values = convertedValues;
          }

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®service_typesã‚’å–å¾—
          const userDocSnapshot = await getDoc(userDocRef);
          if (userDocSnapshot.exists()) {
            serviceTypes = userDocSnapshot.data().service_types || [];
          }
        } else {
          // GAS load
          const data = await loadUserDataFromGAS(userId, 'planFim');
          values = data?.values || {};
          // GASã®å ´åˆã‚‚allUsersã‹ã‚‰å–å¾—
          const user = allUsers.find(u => u.id === userId);
          if (user) {
            serviceTypes = user.service_types || [];
          }
        }

        renderPlanFimBySchema(DEFAULT_PLAN_FIM_SCHEMA, values);
        planFimForm.dataset.schema = JSON.stringify(DEFAULT_PLAN_FIM_SCHEMA);

        // ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
        updatePlanFimButtons(serviceTypes);

      } catch (e) {
        console.warn('è¨ˆç”»æ›¸(FIM)ã®åˆæœŸåŒ–ã«å¤±æ•—', e);
        renderPlanFimBySchema(DEFAULT_PLAN_FIM_SCHEMA, {});
        updatePlanFimButtons([]);
      } finally {
        planFimLoader.style.display = 'none';
        document.getElementById('plan-fim-form-body').style.display = 'block';
      }
    }

    function renderPlanFimBySchema(schema, values = {}) {
      planFimDynamicFields.innerHTML = '';
      const frag = document.createDocumentFragment();
      const currentUserId = document.getElementById('plan-fim-clientId').value;

      let planOpen = window.__planOpen || false;
      let fimOpen = window.__fimOpen || false;
      let basicOpen = window.__basicOpen || false;

      for (const field of schema) {
        if (field.type === 'sectionHeader') {
          const h = document.createElement('h3');
          h.className = 'section-title';
          h.textContent = field.label;
          h.style.marginTop = '16px';
          frag.appendChild(h);
        }
        else if (field.type === 'toggleButton') {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-secondary';

          if (field.id === 'plan_toggle') {
            btn.textContent = planOpen ? 'è¨ˆç”»æ›¸ã®è©³ç´°ã‚’é–‰ã˜ã‚‹' : 'è¨ˆç”»æ›¸ã®è©³ç´°ã‚’é–‹ã';
          } else if (field.id === 'fim_toggle') {
            btn.textContent = fimOpen ? 'FIMã®è©³ç´°ã‚’é–‰ã˜ã‚‹' : 'FIMã®è©³ç´°ã‚’é–‹ã';
          } else if (field.id === 'basic_toggle') {
            btn.textContent = basicOpen ? 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‰ã˜ã‚‹' : 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‹ã';
          }
          btn.style.marginTop = '4px';

          const container = document.createElement('div');
          container.className = 'toggle-container';
          container.style.marginTop = '10px';
          container.style.padding = '10px';
          container.style.backgroundColor = '#f9f9f9';
          container.style.borderRadius = '6px';

          if (field.id === 'plan_toggle') {
            container.style.display = planOpen ? 'block' : 'none';
          } else if (field.id === 'fim_toggle') {
            container.style.display = fimOpen ? 'block' : 'none';
          } else if (field.id === 'basic_toggle') {
            container.style.display = basicOpen ? 'block' : 'none';
          }

          if (field.id === 'plan_toggle') {
            renderFieldGroup(container, PLAN_FIELDS, values);
            btn.addEventListener('click', () => {
              const isOpen = container.style.display !== 'none';
              container.style.display = isOpen ? 'none' : 'block';
              btn.textContent = isOpen ? 'è¨ˆç”»æ›¸ã®è©³ç´°ã‚’é–‹ã' : 'è¨ˆç”»æ›¸ã®è©³ç´°ã‚’é–‰ã˜ã‚‹';
              window.__planOpen = !isOpen;
            });
          } else if (field.id === 'fim_toggle') {
            renderFieldGroup(container, FIM_FIELDS, values);
            btn.addEventListener('click', () => {
              const isOpen = container.style.display !== 'none';
              container.style.display = isOpen ? 'none' : 'block';
              btn.textContent = isOpen ? 'FIMã®è©³ç´°ã‚’é–‹ã' : 'FIMã®è©³ç´°ã‚’é–‰ã˜ã‚‹';
              window.__fimOpen = !isOpen;
            });
          } else if (field.id === 'basic_toggle') {
            renderFieldGroup(container, BASIC_CHECK_FIELDS, values);
            btn.addEventListener('click', () => {
              const isOpen = container.style.display !== 'none';
              container.style.display = isOpen ? 'none' : 'block';
              btn.textContent = isOpen ? 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‹ã' : 'åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ã‚’é–‰ã˜ã‚‹';
              window.__basicOpen = !isOpen;
            });
          }
          frag.appendChild(btn);
          frag.appendChild(container);
        }
        else {
          const row = createFormField(field, values[field.id], 'plan-fim');
          if (row) frag.appendChild(row);
        }
      }
      planFimDynamicFields.appendChild(frag);
    }

    function renderFieldGroup(container, fields, values) {
      for (const f of fields) {
        const row = createFormField(f, values[f.id], 'plan-fim');
        if (row) container.appendChild(row);
      }
    }

    // Helper function to create a care plan table row
    function createCarePlanRow(rowData, index) {
      const tr = document.createElement('tr');
      tr.className = 'care-plan-row';

      const fields = ['life_needs', 'short_term_goals', 'period', 'support_content', 'required_time', 'frequency'];

      fields.forEach(fieldName => {
        const td = document.createElement('td');
        td.style.border = '1px solid #ddd';
        td.style.padding = '4px';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'care-plan-field';
        input.dataset.field = fieldName;
        input.value = rowData[fieldName] || '';
        input.style.width = '100%';
        input.style.border = 'none';
        input.style.padding = '4px';
        input.style.fontSize = '13px';

        td.appendChild(input);
        tr.appendChild(td);
      });

      // Delete button cell
      const tdDelete = document.createElement('td');
      tdDelete.style.border = '1px solid #ddd';
      tdDelete.style.padding = '4px';
      tdDelete.style.textAlign = 'center';

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.className = 'btn btn-secondary';
      deleteBtn.style.padding = '4px 8px';
      deleteBtn.style.fontSize = '12px';
      deleteBtn.addEventListener('click', () => {
        if (confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          tr.remove();
        }
      });

      tdDelete.appendChild(deleteBtn);
      tr.appendChild(tdDelete);

      return tr;
    }

    function createFormField(field, value, prefix) {
      // Handle section headers
      if (field.type === 'sectionHeader') {
        const header = document.createElement('h3');
        header.className = 'section-title';
        header.textContent = field.label;
        header.style.marginTop = '20px';
        header.style.marginBottom = '10px';
        header.style.fontSize = '16px';
        header.style.fontWeight = '700';
        header.style.color = '#333';
        header.style.borderBottom = '2px solid var(--primary-color)';
        header.style.paddingBottom = '5px';
        return header;
      }

      // Handle care plan table
      if (field.type === 'careTable') {
        const container = document.createElement('div');
        container.style.marginTop = '20px';
        container.style.marginBottom = '20px';

        const header = document.createElement('h3');
        header.textContent = field.label;
        header.style.fontSize = '16px';
        header.style.fontWeight = '700';
        header.style.marginBottom = '10px';
        header.style.color = '#333';
        header.style.borderBottom = '2px solid var(--primary-color)';
        header.style.paddingBottom = '5px';
        container.appendChild(header);

        const tableWrapper = document.createElement('div');
        tableWrapper.style.overflowX = 'auto';
        tableWrapper.style.marginTop = '10px';

        const table = document.createElement('table');
        table.className = 'care-plan-table';
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.border = '1px solid #ddd';

        // Table header
        const thead = document.createElement('thead');
        thead.style.backgroundColor = '#f5f5f5';
        const headerRow = document.createElement('tr');
        const headers = ['ç”Ÿæ´»ä¸Šã®ãƒ‹ãƒ¼ã‚º', 'çŸ­æœŸç›®æ¨™', 'æœŸé–“', 'å…·ä½“çš„ãªæ´åŠ©å†…å®¹ãƒ»æ–¹æ³•', 'æ‰€ç”¨æ™‚é–“', 'é »åº¦', ''];
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          th.style.border = '1px solid #ddd';
          th.style.padding = '8px';
          th.style.textAlign = 'left';
          th.style.fontSize = '13px';
          th.style.fontWeight = '600';
          if (h === '') th.style.width = '60px';
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Table body
        const tbody = document.createElement('tbody');
        tbody.id = 'care-plan-tbody';

        // Load existing data or create empty row
        const existingData = value || [];
        if (existingData.length === 0) {
          existingData.push({});
        }

        existingData.forEach((rowData, index) => {
          const tr = createCarePlanRow(rowData, index);
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        container.appendChild(tableWrapper);

        // Add row button
        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'btn btn-secondary';
        addButton.textContent = '+ è¡Œã‚’è¿½åŠ ';
        addButton.style.marginTop = '10px';
        addButton.addEventListener('click', () => {
          const newRow = createCarePlanRow({}, tbody.children.length);
          tbody.appendChild(newRow);
        });
        container.appendChild(addButton);

        return container;
      }

      const row = document.createElement('div');
      row.className = 'form-row-field';
      row.style.marginBottom = '12px';

      const label = document.createElement('label');
      label.textContent = field.label;
      label.style.display = 'block';
      label.style.marginBottom = '4px';
      label.style.fontWeight = '600';
      row.appendChild(label);

      let input;
      if (field.type === 'select') {
        input = document.createElement('select');
        input.className = 'ud-field';
        input.dataset.udField = field.id;
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
        input.appendChild(defaultOpt);
        for (const opt of (field.options || [])) {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          if (value === opt.value) o.selected = true;
          input.appendChild(o);
        }
      }
      else if (field.type === 'textarea') {
        input = document.createElement('textarea');
        input.className = 'ud-field';
        input.dataset.udField = field.id;
        input.rows = field.rows || 3;
        input.value = value || '';
      }
      else if (field.type === 'date') {
        input = document.createElement('input');
        input.type = 'date';
        input.className = 'ud-field';
        input.dataset.udField = field.id;
        input.value = value || '';
      }
      else if (field.type === 'number') {
        input = document.createElement('input');
        input.type = 'number';
        input.className = 'ud-field';
        input.dataset.udField = field.id;
        input.value = value || '';
      }
      else if (field.type === 'ynr') {
        input = document.createElement('select');
        input.className = 'ud-field';
        input.dataset.udField = field.id;
        [['', 'é¸æŠ'], ['ã¯ã„', 'ã¯ã„'], ['ã„ã„ãˆ', 'ã„ã„ãˆ']].forEach(([v, t]) => {
          const o = document.createElement('option');
          o.value = v; o.textContent = t;
          if (value === v) o.selected = true;
          input.appendChild(o);
        });
      }
      else {
        input = document.createElement('input');
        input.type = 'text';
        input.className = 'ud-field';
        input.dataset.udField = field.id;
        input.value = value || '';
      }

      input.style.width = '100%';
      input.style.padding = '8px';
      input.style.borderRadius = '4px';
      input.style.border = '1px solid #ddd';
      row.appendChild(input);

      // Add help text if provided
      if (field.help) {
        const helpText = document.createElement('small');
        helpText.className = 'help';
        helpText.textContent = field.help;
        helpText.style.display = 'block';
        helpText.style.marginTop = '4px';
        helpText.style.color = '#888';
        helpText.style.fontSize = '12px';
        row.appendChild(helpText);
      }

      return row;
    }

    planFimForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('plan-fim-submit-button');
      btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­...';
      try {
        const clientId = document.getElementById('plan-fim-clientId').value;
        const values = {};

        // Collect regular field values
        for (const el of document.querySelectorAll('#plan-fim-form .ud-field')) {
          const key = el.dataset.udField;
          if (el.type !== 'file') {
            values[key] = el.value;
          }
        }

        // Collect care plan table data
        const carePlanRows = [];
        const tableRows = document.querySelectorAll('.care-plan-row');
        tableRows.forEach(tr => {
          const rowData = {};
          const inputs = tr.querySelectorAll('.care-plan-field');
          inputs.forEach(input => {
            rowData[input.dataset.field] = input.value;
          });
          // Only add non-empty rows
          if (Object.values(rowData).some(v => v.trim() !== '')) {
            carePlanRows.push(rowData);
          }
        });
        values.care_plan_table = carePlanRows;

        if (USE_FIREBASE) {
          const { doc, setDoc, updateDoc, collection, serverTimestamp } = window.firebaseModules;
          const userDocRef = doc(window.db, 'riyousya', clientId);
          const planFimDocRef = doc(collection(userDocRef, 'planFim'), 'data');

          // Save to planFim subcollection
          await setDoc(planFimDocRef, {
            userId: clientId,
            values: values,
            files: {},
            lastUpdated: serverTimestamp(),
            updatedBy: 'system'
          }, { merge: true });

          // Also save office information to main riyousya document
          const mainDocUpdate = {};
          if (values.care_office_number !== undefined) mainDocUpdate.care_office_number = values.care_office_number;
          if (values.office_name !== undefined) mainDocUpdate.office_name = values.office_name;
          if (values.office_address !== undefined) mainDocUpdate.office_address = values.office_address;
          if (values.office_tel !== undefined) mainDocUpdate.office_tel = values.office_tel;
          if (values.care_plan_table !== undefined) mainDocUpdate.care_plan_table = values.care_plan_table;

          if (Object.keys(mainDocUpdate).length > 0) {
            await updateDoc(userDocRef, mainDocUpdate);
          }
        } else {
          // GAS save
          const saveData = { values, files: {} };
          await saveUserDataToGAS(clientId, 'planFim', saveData);
        }

        showToast('è¨ˆç”»æ›¸(FIM)ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        closeModal('plan-fim-modal');
      } catch (err) {
        showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'ä¿å­˜ã™ã‚‹';
      }
    });

    /* ================================================================
       åˆ©ç”¨è€…ãƒªã‚¹ãƒˆå–å¾—ãƒ»æç”»
    ================================================================ */
    let allUsers = [];
    let filteredUsers = [];
    let userStatusMap = {};
    let userDocumentCount = {};
    let isLoadingUsers = false;

    const FALLBACK_USERS = [
      { id: '0001', name: 'é’å±± æ–°ä¸€', kana: 'ã‚¢ã‚ªãƒ¤ãƒ ã‚·ãƒ³ã‚¤ãƒ', manager: 'æ¿±ç”° å¤ªéƒ', address: 'æ±å¤§é˜ªå¸‚æ—­ç”º1-101', notice: '', status: 'åˆ©ç”¨ä¸­' },
      { id: '0002', name: 'ç§‹ç”° ç†æ²™', kana: 'ã‚¢ã‚­ã‚¿ ãƒªã‚µ', manager: 'å¥¥ç¾½ å“²éƒ', address: 'å…«å°¾å¸‚æ „ç”º2-9-202', notice: '', status: 'åˆ©ç”¨ä¸­' },
      { id: '0003', name: 'ä½è—¤ èŠ±å­', kana: 'ã‚µãƒˆã‚¦ ãƒãƒŠã‚³', manager: 'ç”°ä¸­ ä¸€éƒ', address: 'å¤§é˜ªå¸‚ä¸­å¤®åŒºæœ¬ç”º3-4-5', notice: '', status: 'åˆ©ç”¨ä¸­' },
      { id: '0004', name: 'éˆ´æœ¨ å­ä¸€', kana: 'ã‚¹ã‚ºã‚­ ã‚³ã‚¦ã‚¤ãƒ', manager: 'å±±ç”° ç¾å’²', address: 'å¤§é˜ªå¸‚ä½å‰åŒºä½å‰æœ¬ç”º1-2-3', notice: '', status: 'åˆ©ç”¨ä¸­' },
      { id: '0005', name: 'ä¼Šè—¤ ã¿ã©ã‚Š', kana: 'ã‚¤ãƒˆã‚¦ ãƒŸãƒ‰ãƒª', manager: 'ä½è—¤ å¥ä¸€', address: 'ç¥æˆ¸å¸‚ä¸­å¤®åŒºå¾¡å¹¸é€š8-6-7', notice: '', status: 'åˆ©ç”¨ä¸­' }
    ];

    /* ================================================================
       Date Conversion Helpers
    ================================================================ */
    // Convert date string (YYYY-MM-DD) to Firestore Timestamp
    function dateStringToTimestamp(dateString) {
      if (!dateString) return null;
      try {
        return window.firebaseModules.Timestamp.fromDate(new Date(dateString));
      } catch (error) {
        console.error('Error converting date string to timestamp:', dateString, error);
        return null;
      }
    }

    // Convert Firestore Timestamp to date string (YYYY-MM-DD)
    function timestampToDateString(timestamp) {
      if (!timestamp) return '';
      try {
        const date = timestamp.toDate();
        return date.toISOString().split('T')[0];
      } catch (error) {
        console.error('Error converting timestamp to date string:', timestamp, error);
        return '';
      }
    }

    // Convert Date object to date string (YYYY-MM-DD)
    function dateToString(date) {
      if (!date) return '';
      try {
        return date.toISOString().split('T')[0];
      } catch (error) {
        console.error('Error converting date to string:', date, error);
        return '';
      }
    }

    async function initializeClientApplication() {
      console.log('Initializing client application with Firestore...');

      try {
        // Set up real-time listener for users collection in Firestore
        // riyousya â†Edata â†Eusers ã®ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹
        const { collection, doc, onSnapshot } = window.firebaseModules;
        const usersCollectionRef = collection(window.db, 'riyousya');
        // Note: Firestore orderBy on document ID requires special handling
        // We'll fetch all and sort client-side for better control
        const usersQuery = usersCollectionRef;

        // Real-time listener - automatically updates when data changes
        window.firebaseModules.onSnapshot(usersQuery, (snapshot) => {
          allUsers = [];

          snapshot.forEach((doc) => {
            const data = doc.data();
            allUsers.push({
              id: doc.id,
              name: data.name || '',
              kana: data.kana || '',
              manager: data.manager || '',
              address: data.address || '',
              notice: data.notice || '',
              status: data.status || 'active',
              // Convert Firestore Timestamps to Date objects
              birthdate: data.birthdate ? data.birthdate.toDate() : null,
              startDate: data.startDate ? data.startDate.toDate() : null,
              // Include all other fields
              ...data
            });
          });

          // IDé …ç›®ã‚½ãƒ¼ãƒˆï¼ˆæ•°å€¤ã¨ã—ã¦æ¯”è¼ƒï¿½
          allUsers.sort((a, b) => {
            const idA = String(a.id || '');
            const idB = String(b.id || '');
            // æ•°å€¤ã¨ã—ã¦æ¯”è¼ƒãã‚‹å ´åˆæ•°å€¤ã¨ã—ã¦ã€ãã‚Œä»¥å¤–ãªã‚‰å­—ã¨ã—ã¦æ¯”è¼ƒ
            const numA = parseInt(idA, 10);
            const numB = parseInt(idB, 10);
            if (!isNaN(numA) && !isNaN(numB)) {
              return numA - numB;
            }
            return idA.localeCompare(idB);
          });

          console.log(`Loaded ${allUsers.length} users from Firestore (sorted by ID)`);

          // Update UI
          filteredUsers = [...allUsers];

          // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã‚’èª­ã¿è¾¼ã‚€
          loadAllUserDocumentCounts().then(() => {
            renderUserTable();
          });

          if (typeof populateFilters === 'function') {
            populateFilters();
          }
        }, (error) => {
          console.error('Error listening to Firestore:', error);
          showToast('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        });

      } catch (error) {
        console.error('Error initializing application:', error);
        showToast('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }

    async function fetchUsersWithStatusFromGAS() {
      if (isLoadingUsers) return;
      isLoadingUsers = true;
      showLoadingSpinner('åˆ©ç”¨è€…ãƒ‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      try {
        // USE_FIREBASEãƒ•ãƒ©ã‚°ã§Firebaseã¨GASã‚’ã‚Šæ›¿ã„
        if (USE_FIREBASE) {
          const result = await getUserListFromFirebase();
          if (result && result.status === 'success' && Array.isArray(result.users)) {
            allUsers = result.users;
            userStatusMap = result.statusById || {};
            showToast(`${allUsers.length}åã®åˆ©ç”¨è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ (Firebase)`, 'success');
          } else {
            throw new Error('Firebaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™');
          }
        } else {
          // GASç‰ˆ
          const requestUrl = `${GAS_MAIN_URL}?action=getUsersWithStatus`;
          const testResponse = await fetch(requestUrl);
          if (!testResponse.ok) throw new Error(`HTTP ${testResponse.status}: ${testResponse.statusText}`);
          const responseText = await testResponse.text();
          if (!responseText.trim()) throw new Error('GASã‹ã‚‰ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹');
          if (responseText.includes('<!DOCTYPE html>')) throw new Error('GAS Webã‚¢ãƒ—ãƒªãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          const result = JSON.parse(responseText);

          if (result && result.status === 'success' && Array.isArray(result.users)) {
            allUsers = result.users.map(user => ({
              id: user.id || user.ID || user['ID'],
              name: user.name || user.åå‰ || user['åå‰'],
              kana: user.kana || user.ãƒ•ãƒªã‚¬ãƒŠ || user['ãƒ•ãƒªã‚¬ãƒŠ'],
              manager: user.manager || user.ã‚µè²¬ || user['ã‚µè²¬'],
              address: user.address || user.ä½æ‰€ || user['ä½æ‰€'],
              notice: user.notice || user.ãŠçŸ¥ã‚‰ã› || user['ãŠçŸ¥ã‚‰ã›'] || '',
              status: user.status || user.åˆ©ç”¨çŠ¶æ³ || user['åˆ©ç”¨çŠ¶æ³'] || 'åˆ©ç”¨ä¸­'
            }));

            userStatusMap = result.statusById || {};
            showToast(`${allUsers.length}åã®åˆ©ç”¨è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`, 'success');
          } else {
            throw new Error(result?.message || 'ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™');
          }
        }
      } catch (error) {
        console.error('åˆ©ç”¨è€…ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—', error);
        showToast(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error', 8000);
        allUsers = [...FALLBACK_USERS];
        userStatusMap = {};
        allUsers.forEach(u => { userStatusMap[u.id] = { basicInfoComplete: false, updateDocsComplete: false, planFimComplete: false, googleDriveUrl: '' }; });
        showToast('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™', 'warning', 3000);
      } finally {
        isLoadingUsers = false;
        hideLoadingSpinner();
        filteredUsers = [...allUsers];
        fetchAllUserDocumentCounts();
        renderUserTable();
      }
    }

    async function fetchAllUserDocumentCounts() {
      try {
        const promises = allUsers.map(user =>
          fetch(`${GAS_MAIN_URL}?action=getUserDocuments&userId=${encodeURIComponent(user.id)}`)
            .then(res => res.json())
            .then(result => { userDocumentCount[user.id] = (result.status === 'success' && result.documents) ? result.documents.length : 0; })
            .catch(() => { userDocumentCount[user.id] = 0; })
        );
        await Promise.all(promises.slice(0, 10));
        renderUserTable();
        await Promise.all(promises.slice(10));
        renderUserTable();
      } catch (e) { console.warn('Failed to fetch document counts:', e); }
    }

    /* --- 500äººè¦æ¨¡ã®æç”»/ãƒšãƒ¼ã‚¸ãƒ³ã‚° --- */
    let currentPage = 1;
    let itemsPerPage = 1000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºä»¶æ•°ã‚’1000ä»¶ã«è¨­å®š
    const UPDATE_TO_USAGE = { 'åˆ©ç”¨ä¸­': 'åˆ©ç”¨ä¸­', 'çµ‚äº†': 'çµ‚äº†', 'ä¸­æ–­ä¸­': 'ä¸­æ–­ä¸­', 'æ›¸é¡æå‡ºæ¸ˆ': 'åˆ©ç”¨ä¸­', 'ä¸€æ™‚ä¸­æ–­ç”³è«‹': 'ä¸­æ–­ä¸­', 'çµ‚äº†æ‰‹ç¶šå®Œäº†': 'çµ‚äº†' };

    // ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹HTMLç”Ÿæˆé–¢æ•°
    function generateServiceTypesHtml(serviceTypes) {
      if (!serviceTypes || !Array.isArray(serviceTypes) || serviceTypes.length === 0) {
        return '<span style="color: #999;">æœªè¨­å®š</span>';
      }

      const colors = {
        'éšœå®³': '#dc3545',
        'ä»‹è­·': '#28a745',
        'ç§»å‹•': '#007bff'
      };

      return serviceTypes.map(type => {
        const color = colors[type] || '#6c757d';
        return `<span style="display: inline-block; padding: 2px 6px; margin: 2px; background-color: ${color}; color: white; border-radius: 3px; font-size: 11px;">${type}</span>`;
      }).join('');
    }

    function renderUserTable() {
      // Populate filter dropdowns when data is available
      populateFilterDropdowns();

      const tbody = document.getElementById('user-table-body');
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageUsers = filteredUsers.slice(startIndex, endIndex);

      tbody.innerHTML = pageUsers.map(user => {
        const userStatus = userStatusMap[user.id] || { basicInfoComplete: false, updateDocsComplete: false, planFimComplete: false, googleDriveUrl: '' };
        const noticeHtml = generateNoticeHtml(user.notice, userStatus);
        const basicInfoBadge = userStatus.basicInfoComplete ? '' : '<span class="icon-badge" aria-label="åŸºæœ¬æƒ…å ±æœªå…¥åŠ›"></span>';
        const planFimBadge = userStatus.planFimComplete ? '' : '<span class="icon-badge" aria-label="è¨ˆç”»æ›¸æœªå…¥åŠ›"></span>';
        const updateDocBadge = userStatus.updateDocsComplete ? '' : '<span class="icon-badge" aria-label="æ›´æ–°æ›¸é¡æœªå…¥åŠ›"></span>';
        const usageStatus = user.status || 'åˆ©ç”¨ä¸­';
        const statusBadgeClass = getStatusBadgeClass(usageStatus);
        const googleDriveUrl = userStatus.googleDriveUrl || '';
        console.log(`[ãƒ†ãƒ¼ãƒ–ãƒ«æç”»] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${user.id}, Google Drive URL: "${googleDriveUrl}"`);
        const folderIconColor = googleDriveUrl ? '#28a745' : '#6c757d';
        const folderIconStyle = `color: ${folderIconColor}; font-size: 18px;`;

        return `
      <tr data-id="${user.id}" data-name="${user.name}" data-name-kana="${user.kana}" data-status="${usageStatus}" data-notice="${user.notice}" data-manager="${user.manager}" data-address="${user.address}">
        <td>${user.id}</td>
        <td>${googleDriveUrl ? `<a href="${googleDriveUrl}" target="_blank" rel="noopener noreferrer" class="action-icon" aria-label="Google Driveã‚’é–‹ã" title="Google Driveãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã"><i class="fas fa-folder" style="${folderIconStyle}"></i></a>` : `<a href="#" class="action-icon" onclick="alert('Google Driveã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åŸºæœ¬æƒ…å ±ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚'); return false;" aria-label="Google Driveæœªè¨­å®š" title="URLæœªè¨­å®š"><i class="fas fa-folder" style="${folderIconStyle}"></i></a>`}</td>
        <td class="cell-name">${user.name}<br><span class="cell-kana" style="font-size: 12px; color: #888;">${user.kana}</span></td>
        <td>${user.manager}</td>
        <td class="cell-usage" onclick="filterByUsageStatus('${usageStatus}')" style="cursor: pointer;" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ${usageStatus}"><span class="${statusBadgeClass}">${usageStatus}</span></td>
        <td>
          ${user.address}
          ${user.address ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(user.address)}" target="_blank" rel="noopener noreferrer" style="margin-left: 8px;"><button style="padding: 4px 8px; background-color: #fb923c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">åœ°å›³</button></a>` : ''}
        </td>
        <td class="content-cell">${generateServiceTypesHtml(user.service_types)}</td>
        <td class="notice-cell">${noticeHtml}</td>
        <td><a href="#" class="action-icon" onclick="openWeeklyCareplan('${user.id}','${user.name}'); return false;" aria-label="é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã‚’é–‹ã"><i class="fas fa-calendar-alt"></i></a></td>
        <td>
          <a href="#" class="action-icon" onclick="openBasicInfoModal('${user.id}','${user.name}'); return false;" aria-label="åŸºæœ¬æƒ…å ±ã‚’ç·¨é›†">
            <i class="fas fa-user"></i>
            ${basicInfoBadge}
          </a>
        </td>
        <td>
          <a href="#" class="action-icon" onclick="openPlanFimModal('${user.id}','${user.name}'); return false;" aria-label="è¨ˆç”»æ›¸(FIM)ã‚’ç·¨é›†">
            <i class="fas fa-clipboard-list"></i>
            ${planFimBadge}
          </a>
        </td>
        <td class="cell-update-status">
          <a href="#" class="action-icon" onclick="openUpdateModal('${user.id}','${user.name}'); return false;" aria-label="æ›´æ–°æ›¸é¡ã‚’ç·¨é›†" style="font-size: 16px;">
            <i class="fas fa-file-alt"></i>
            ${updateDocBadge}
          </a>
        </td>
        <td>
          <a href="#" class="action-icon" onclick="openServiceHistoryModal('${user.id}','${user.name}'); return false;" aria-label="ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½å±¥æ­´ã‚’è¡¨ç¤º" title="ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½å±¥æ­´">
            <i class="fas fa-history"></i>
          </a>
        </td>
      </tr>
    `;
      }).join('');

      applyFilters();
      updatePaginationInfo();
    }

    function updatePaginationInfo() {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage + 1;
      const endIndex = Math.min(currentPage * itemsPerPage, filteredUsers.length);
      const paginationInfo = document.getElementById('pagination-info'); if (paginationInfo) paginationInfo.textContent = `${startIndex}-${endIndex} / ${filteredUsers.length}ä»¶`;
      const paginationInfoTop = document.getElementById('pagination-info-top'); if (paginationInfoTop) paginationInfoTop.textContent = `${startIndex}-${endIndex} / ${filteredUsers.length}ä»¶`;

      const firstBtn = document.getElementById('first-page-btn');
      const prevBtn = document.getElementById('prev-page-btn');
      const nextBtn = document.getElementById('next-page-btn');
      const lastBtn = document.getElementById('last-page-btn');
      if (firstBtn) firstBtn.disabled = currentPage === 1;
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      if (lastBtn) lastBtn.disabled = currentPage === totalPages || totalPages === 0;

      const firstBtnTop = document.getElementById('first-page-btn-top');
      const prevBtnTop = document.getElementById('prev-page-btn-top');
      const nextBtnTop = document.getElementById('next-page-btn-top');
      const lastBtnTop = document.getElementById('last-page-btn-top');
      if (firstBtnTop) firstBtnTop.disabled = currentPage === 1;
      if (prevBtnTop) prevBtnTop.disabled = currentPage === 1;
      if (nextBtnTop) nextBtnTop.disabled = currentPage === totalPages || totalPages === 0;
      if (lastBtnTop) lastBtnTop.disabled = currentPage === totalPages || totalPages === 0;

      renderPageNumbers(totalPages, 'page-numbers');
      renderPageNumbers(totalPages, 'page-numbers-top');
    }
    function renderPageNumbers(totalPages, containerId = 'page-numbers') {
      const pageNumbersContainer = document.getElementById(containerId);
      if (!pageNumbersContainer) return;
      pageNumbersContainer.innerHTML = '';
      let startPage = Math.max(1, currentPage - 3);
      let endPage = Math.min(totalPages, currentPage + 3);
      if (currentPage <= 3) endPage = Math.min(7, totalPages);
      else if (currentPage >= totalPages - 3) startPage = Math.max(1, totalPages - 6);
      if (startPage > 1) {
        pageNumbersContainer.appendChild(createPageButton(1));
        if (startPage > 2) { const e = document.createElement('span'); e.textContent = '...'; e.style.padding = '0 5px'; e.style.color = '#666'; pageNumbersContainer.appendChild(e); }
      }
      for (let i = startPage; i <= endPage; i++) pageNumbersContainer.appendChild(createPageButton(i));
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) { const e = document.createElement('span'); e.textContent = '...'; e.style.padding = '0 5px'; e.style.color = '#666'; pageNumbersContainer.appendChild(e); }
        pageNumbersContainer.appendChild(createPageButton(totalPages));
      }
    }
    function createPageButton(pageNum) {
      const btn = document.createElement('button');
      btn.textContent = pageNum;
      btn.className = pageNum === currentPage ? 'btn btn-primary' : 'btn btn-secondary';
      btn.style.padding = '6px 12px'; btn.style.fontSize = '13px'; btn.style.minWidth = '40px';
      if (pageNum === currentPage) { btn.disabled = true; btn.style.opacity = '1'; }
      btn.onclick = () => goToPage(pageNum);
      return btn;
    }
    function goToPage(pageNum) {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      if (pageNum < 1 || pageNum > totalPages) return;
      currentPage = pageNum; renderUserTable();
      const tableContainer = document.querySelector('.table-container'); if (tableContainer) tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /* --- Old dropdown filter functions removed - now using filter row --- */

    /* --- ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚¹é€£å‹•--- */
    function handleModalStatusChange(selectElement, userId) {
      const newStatus = selectElement.value;
      const newUsageStatus = UPDATE_TO_USAGE[newStatus] || newStatus || 'åˆ©ç”¨ä¸­';
      const row = document.querySelector(`tr[data-id="${userId}"]`);
      if (row) {
        row.setAttribute('data-status', newUsageStatus);
        const usageCell = row.querySelector('.cell-usage');
        if (usageCell) {
          const badgeClass = getStatusBadgeClass(newUsageStatus);
          usageCell.innerHTML = `<span class="${badgeClass}">${newUsageStatus}</span>`;
          usageCell.onclick = () => filterByUsageStatus(newUsageStatus);
          usageCell.title = `ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ${newUsageStatus}`;
        }
      }
      const idx = allUsers.findIndex(u => String(u.id) === String(userId)); if (idx !== -1) allUsers[idx].status = newUsageStatus;
      const fidx = filteredUsers.findIndex(u => String(u.id) === String(userId)); if (fidx !== -1) filteredUsers[fidx].status = newUsageStatus;
      applyFilters();
      showToast(`åˆ©ç”¨çŠ¶æ³ã‚’ã€Œ{newUsageStatus}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success', 2000);
    }

    /* ================================================================
       é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ãƒ»åŸºæœ¬æƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ (æ—¢å­˜è£œåŠ©)
    ================================================================ */
    function openWeeklyCareplan(userId, userName) {
      window.open(`weeklycareplan.html?userId=${encodeURIComponent(userId)}&userName=${encodeURIComponent(userName)}`, '_blank');
    }

    /* ================================================================
       æ›¸é¡ãƒ•ã‚©ãƒ«ãƒ€
    ================================================================ */
    let currentDocumentUserId = null;
    let currentDocumentUserName = null;
    async function openDocumentsModal(userId, userName) {
      console.log('[Debug] openDocumentsModal called', userId, userName);
      currentDocumentUserId = userId; currentDocumentUserName = userName;
      const modal = document.getElementById('documents-modal');
      if (modal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒ†ãƒ¼
        modal.style.display = '';
        modal.classList.remove('visible');

        // å°‘ã—å»¶ã•ã›ã¦ç¢ºå®Ÿã«è¡¨ç¤º
        setTimeout(() => {
          modal.style.display = 'flex';
          modal.classList.add('visible');
          console.log('[Debug] Documents modal opened');
        }, 10);
      } else {
        console.error('[Debug] Documents modal not found!');
      }
      document.getElementById('documents-userId').textContent = userId;
      document.getElementById('documents-userName').textContent = userName;
      document.getElementById('document-category').value = 'contract';
      document.getElementById('document-file').value = '';
      document.getElementById('document-memo').value = '';
      await loadUserDocuments(userId);
    }
    async function loadUserDocuments(userId) {
      const loader = document.getElementById('documents-loader');
      const content = document.getElementById('documents-content');
      const documentsList = document.getElementById('documents-list');
      const emptyMessage = document.getElementById('documents-empty');

      try {
        loader.style.display = 'block';
        content.style.display = 'none';

        // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—
        const { doc, collection, getDocs, query, orderBy } = window.firebaseModules;
        const userIdStr = String(userId);
        const userDocRef = doc(window.db, 'riyousya', userIdStr);
        const documentsRef = collection(userDocRef, 'documents');

        // uploadDateã§é™é …ç›®ã‚½ãƒ¼ã¦
        const q = query(documentsRef, orderBy('uploadDate', 'desc'));
        const snapshot = await getDocs(q);

        const docs = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          docs.push({
            fileId: docSnap.id,
            fileName: data.fileName,
            fileType: data.fileType,
            fileUrl: data.fileUrl,
            filePath: data.filePath,
            category: data.category,
            memo: data.memo || '',
            uploadDate: data.uploadDate?.toDate?.() || new Date()
          });
        });

        console.log('Loaded documents from Firestore:', docs.length);

        if (docs.length === 0) {
          documentsList.innerHTML = '';
          documentsList.style.display = 'none';
          emptyMessage.style.display = 'block';
        } else {
          documentsList.innerHTML = docs.map(doc => createDocumentCard(doc)).join('');
          documentsList.style.display = 'flex';
          emptyMessage.style.display = 'none';
        }

      } catch (error) {
        console.error('Failed to load documents:', error);
        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        documentsList.innerHTML = '';
        documentsList.style.display = 'none';
        emptyMessage.style.display = 'block';
      } finally {
        loader.style.display = 'none';
        content.style.display = 'block';
      }
    }
    function createDocumentCard(doc) {
      const categoryNames = { 'contract': 'å¥‘ç´„', 'medical': 'è¨ºæ–­æ›¸ãƒ»åŒ»ç™‚æƒ…å ±', 'certificate': 'å—çµ¦è¨¼', 'plan': 'æ”¯æ´è¨ˆç”»æ›¸', 'report': 'å ±å‘Šæ›¸', 'photo': 'å†™çœŸ', 'other': 'ãã®ä»–' };
      const categoryName = categoryNames[doc.category] || 'ãã®ä»–';
      const uploadDate = doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString('ja-JP') : 'ä¸æ˜';
      let fileIcon = 'fa-file';
      if (doc.fileType && doc.fileType.includes('image')) fileIcon = 'fa-file-image';
      else if (doc.fileType && doc.fileType.includes('pdf')) fileIcon = 'fa-file-pdf';
      else if (doc.fileType && (doc.fileType.includes('word') || doc.fileType.includes('document'))) fileIcon = 'fa-file-word';
      else if (doc.fileType && (doc.fileType.includes('excel') || doc.fileType.includes('spreadsheet'))) fileIcon = 'fa-file-excel';
      return `
    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; background-color: #fff;">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <i class="fas ${fileIcon}" style="font-size: 24px; color: #007bff;"></i>
            <div>
              <div style="font-weight: bold; font-size: 14px;">${doc.fileName || 'ãƒ•ã‚¡ã‚¤ãƒ«'}</div>
              <div style="font-size: 12px; color: #666;">
                <span style="background-color: #e9ecef; padding: 2px 8px; border-radius: 3px; margin-right: 8px;">${categoryName}</span>
                ${uploadDate}
              </div>
            </div>
          </div>
          ${doc.memo ? `<p style="font-size: 13px; color: #666; margin: 8px 0 0 0;">${doc.memo}</p>` : ''}
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="viewDocument('${doc.fileId}', '${doc.fileUrl}')" style="padding: 6px 12px; font-size: 13px;" title="ç¢ºèª">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-secondary" onclick="deleteDocument('${doc.fileId}', '${currentDocumentUserId}')" style="padding: 6px 12px; font-size: 13px; background-color: #dc3545; border-color: #dc3545;" title="å‰Šé™¤">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>`;
    }
    async function uploadDocumentFile() {
      const fileInput = document.getElementById('document-file');
      const category = document.getElementById('document-category').value;
      const memo = document.getElementById('document-memo').value.trim();

      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const file = fileInput.files[0];
      if (file.size > 10 * 1024 * 1024) {
        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      try {
        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info', 3000);

        // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;
        const timestamp = new Date().getTime();
        const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
        const filePath = `${STORAGE_PATHS.DOCUMENTS}/${currentDocumentUserId}/${category}/${timestamp}_${sanitizedFileName}`;
        const storageRef = ref(window.storage, filePath);

        console.log('Uploading to:', filePath);
        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        console.log('File uploaded successfully:', downloadURL);

        // Firestoreã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æœŸ
        const { doc, collection, addDoc, serverTimestamp } = window.firebaseModules;
        const userIdStr = String(currentDocumentUserId);
        const userDocRef = doc(window.db, 'riyousya', userIdStr);
        const documentsRef = collection(userDocRef, 'documents');

        await addDoc(documentsRef, {
          fileName: file.name,
          fileType: file.type,
          fileUrl: downloadURL,
          filePath: filePath,
          category: category,
          memo: memo,
          uploadDate: serverTimestamp(),
          userId: currentDocumentUserId,
          userName: currentDocumentUserName
        });

        console.log('Document metadata saved to Firestore');
        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒ†ãƒ¼
        fileInput.value = '';
        document.getElementById('document-memo').value = '';

        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªãƒªãƒªã‚¹ãƒˆã‚’æ›´æ–°
        await loadUserDocuments(currentDocumentUserId);
        await updateUserDocumentCount(currentDocumentUserId);

      } catch (error) {
        console.error('Upload error:', error);
        showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }
    function viewDocument(fileId, fileUrl) { if (fileUrl) window.open(fileUrl, '_blank'); else showToast('ãƒ•ã‚¡ã‚¤ãƒ«URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error'); }
    async function updateUserDocumentCount(userId) {
      try {
        // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã‚’å–å¾—
        const { doc, collection, getDocs } = window.firebaseModules;
        const userIdStr = String(userId);
        const userDocRef = doc(window.db, 'riyousya', userIdStr);
        const documentsRef = collection(userDocRef, 'documents');

        const snapshot = await getDocs(documentsRef);
        userDocumentCount[userId] = snapshot.size;

        console.log(`Document count for user ${userId}:`, snapshot.size);

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
        renderUserTable();
      } catch (e) {
        console.warn('Failed to update document count:', e);
      }
    }

    // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã‚’ä¸¦è¡Œã—ã¦èª­ã¿è¾¼ã‚€
    async function loadAllUserDocumentCounts() {
      try {
        const { doc, collection, getDocs } = window.firebaseModules;

        // åãƒ¼ã‚¶ãƒ¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã‚’ä¸¦è¡Œå–å¾—
        const promises = allUsers.map(async (user) => {
          try {
            const userId = String(user.id);
            const userDocRef = doc(window.db, 'riyousya', userId);
            const documentsRef = collection(userDocRef, 'documents');
            const snapshot = await getDocs(documentsRef);
            userDocumentCount[user.id] = snapshot.size;
          } catch (e) {
            console.warn(`Failed to load document count for user ${user.id}:`, e);
            userDocumentCount[user.id] = 0;
          }
        });

        await Promise.all(promises);
        console.log('All user document counts loaded:', userDocumentCount);
      } catch (error) {
        console.error('Failed to load all user document counts:', error);
      }
    }
    async function deleteDocument(fileId, userId) {
      if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) return;

      try {
        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­...', 'info');

        // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
        const { doc, collection, getDoc, deleteDoc } = window.firebaseModules;
        const userIdStr = String(userId);
        const userDocRef = doc(window.db, 'riyousya', userIdStr);
        const documentRef = doc(collection(userDocRef, 'documents'), fileId);

        const documentSnap = await getDoc(documentRef);
        if (!documentSnap.exists()) {
          throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        const documentData = documentSnap.data();
        const filePath = documentData.filePath;

        // Firebase Storageã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        if (filePath) {
          const { ref, deleteObject } = window.firebaseModules;
          const storageRef = ref(window.storage, filePath);
          await deleteObject(storageRef);
          console.log('File deleted from Storage:', filePath);
        }

        // Firestoreã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        await deleteDoc(documentRef);
        console.log('Document metadata deleted from Firestore');

        showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');

        // ãƒªãƒªãƒªã‚¹ãƒˆã‚’æ›´æ–°
        await loadUserDocuments(userId);
        await updateUserDocumentCount(userId);

      } catch (error) {
        console.error('Delete error:', error);
        showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }

    /* ================================================================
       GAS I/O
    ================================================================ */
    // ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å¯¾å¿œ USE_FIREBASEãƒ•ãƒ©ã‚°ã§åˆ‡ã‚Šæ›¿ãˆ
    async function saveUserDataToGAS(userId, dataType, data) {
      if (USE_FIREBASE) {
        return await saveUserDataToFirebase(userId, dataType, data);
      }

      // GASç‰ˆï¼ˆå¾“æ¥ã®å®Ÿå™¨ï¿½
      const payload = { action: 'saveUserData', userId, dataType, data: { ...data, lastUpdated: new Date().toISOString(), userId } };
      const response = await fetch(GAS_MAIN_URL, { method: 'POST', body: JSON.stringify(payload) });
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      const text = await response.text();
      let result; try { result = JSON.parse(text); } catch { throw new Error('GASã‹ã‚‰ã®å¿œç­”ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); }
      if (result.status !== 'success') throw new Error(result.message || 'ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return result;
    }

    async function getUserDataFromGAS(userId, dataType) {
      if (USE_FIREBASE) {
        return await getUserDataFromFirebase(userId, dataType);
      }

      // GASç‰ˆï¼ˆå¾“æ¥ã®å®Ÿå™¨ï¿½
      const url = `${GAS_MAIN_URL}?action=getUserData&userId=${encodeURIComponent(userId)}&dataType=${encodeURIComponent(dataType)}`;
      const response = await fetch(url); if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      const text = await response.text();
      let result; try { result = JSON.parse(text); } catch { throw new Error('GASã‹ã‚‰ã®å¿œç­”ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); }
      if (result.status === 'success') return { values: result.values || {}, files: result.files || {} };
      if (result.status === 'not_found') return null;
      throw new Error(result.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    async function getUserHistoryFromGAS(userId, dataType) {
      // USE_FIREBASEãƒ•ãƒ©ã‚°ã§Firebaseã¨GASã‚’ã‚Šæ›¿ã„
      if (USE_FIREBASE) {
        return await getUserHistoryFromFirebase(userId, dataType);
      }

      // GASç‰ˆ
      const url = `${GAS_MAIN_URL}?action=getUserHistory&userId=${encodeURIComponent(userId)}&dataType=${encodeURIComponent(dataType)}`;
      const response = await fetch(url); if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      const text = await response.text();
      try {
        const result = JSON.parse(text);
        if (result.status === 'success') return result.history || [];
        return [];
      } catch { return []; }
    }

    /* ================================================================
       è£œåŠ©(ä½æ‰€åŒæœŸãªã©(æ—¢å­˜)
    ================================================================ */
    // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠã‚’è¨­å®š
    const newUserButton = document.getElementById('new-user-btn');
    if (newUserButton) {
      console.log('[Debug] New user button found, adding listener');
      newUserButton.addEventListener('click', function (e) {
        console.log('[Debug] New user button clicked');
        e.preventDefault();
        e.stopPropagation();
        openNewUserModal();
      });
    } else {
      console.warn('[Debug] New user button not found, trying DOMContentLoaded');
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«å†è©¦è¡Œ
      document.addEventListener('DOMContentLoaded', function () {
        const newUserButton = document.getElementById('new-user-btn');
        if (newUserButton) {
          console.log('[Debug] New user button found on DOMContentLoaded');
          newUserButton.addEventListener('click', function (e) {
            console.log('[Debug] New user button clicked (DOMContentLoaded)');
            e.preventDefault();
            e.stopPropagation();
            openNewUserModal();
          });
        } else {
          console.error('[Debug] New user button still not found!');
        }
      });
    }
    function openNewUserModal() {
      console.log('[Debug] openNewUserModal called');
      const modal = document.getElementById('new-user-modal');
      if (modal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒ†ãƒ¼
        modal.style.display = '';
        modal.classList.remove('visible');

        // å°‘ã—å»¶ã•ã›ã¦ç¢ºå®Ÿã«è¡¨ç¤º
        setTimeout(() => {
          modal.classList.add('visible');
          console.log('[Debug] Modal opened with visible class');
        }, 10);
      } else {
        console.error('[Debug] Modal not found!');
      }
      const form = document.getElementById('new-user-form');
      if (form) {
        form.reset();
      }
      generateNextUserId();
    }
    function generateNextUserId() {
      let maxId = 0;
      allUsers.forEach(u => {
        const id = parseInt(u.id);
        if (!isNaN(id) && id > maxId) maxId = id;
      });
      const nextId = (maxId + 1).toString(); // 598ãªã‚99ã«ãªã‚‹)åŸ‹ã‚ãªã—)
      document.getElementById('new-user-id').value = nextId;
    }
    document.getElementById('new-user-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const submitButton = document.getElementById('new-user-submit-button');
      const loader = document.getElementById('new-user-loader');
      const formBody = document.getElementById('new-user-form-body');
      try {
        const formData = {
          id: document.getElementById('new-user-id').value.trim(),
          name: document.getElementById('new-user-name').value.trim(),
          kana: document.getElementById('new-user-kana').value.trim(),
          manager: document.getElementById('new-user-manager').value.trim(),
          address: document.getElementById('new-user-address').value.trim(),
          notice: document.getElementById('new-user-notice').value.trim(),
          status: 'åˆ©ç”¨ä¸­'
        };
        if (!formData.id || !formData.name || !formData.kana || !formData.manager || !formData.address) { showToast('å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
        const dup = allUsers.find(u => u.id === formData.id); if (dup) { showToast('ã“ã®åˆ©ç”¨è€…IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error'); return; }
        submitButton.disabled = true; submitButton.textContent = 'ä½œæˆä¸­...'; loader.style.display = 'block'; formBody.style.display = 'none';

        if (USE_FIREBASE) {
          // Add to Firestore
          const newUserData = {
            ...formData,
            createdAt: window.firebaseModules.serverTimestamp(),
            createdBy: 'system',
            lastUpdated: window.firebaseModules.serverTimestamp(),
            updatedBy: 'system'
          };
          // Use the correct path structure: riyousya/{userId}
          const { doc, setDoc } = window.firebaseModules;
          const userDocRef = doc(window.db, 'riyousya', formData.id);
          await setDoc(userDocRef, newUserData);
          console.log('New user created in Firestore with ID:', formData.id);
        } else {
          // Add to local data and GAS
          addUserToLocalData(formData);
        }

        showToast('æ–°è¦åˆ©ç”¨è€…ã€Œ' + formData.name + 'ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        closeModal('new-user-modal'); document.getElementById('new-user-form').reset();
      } catch (error) {
        console.error('æ–°è¦åˆ©ç”¨è€…è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error); showToast('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        submitButton.disabled = false; submitButton.textContent = 'åˆ©ç”¨è€…è¿½åŠ '; loader.style.display = 'none'; formBody.style.display = 'block';
      }
    });
    function addUserToLocalData(userData) {
      allUsers.push(userData);
      userStatusMap[userData.id] = { basicInfoComplete: false, updateDocsComplete: false, planFimComplete: false, googleDriveUrl: '' };
      renderUserTable(); populateManagerOptions(); populateNoticeOptions(); sendUserToGAS(userData);
    }
    function sendUserToGAS(userData) {
      try {
        let iframe = document.getElementById('gas-submit-iframe');
        if (!iframe) { iframe = document.createElement('iframe'); iframe.id = 'gas-submit-iframe'; iframe.name = 'gas-submit-iframe'; iframe.style.display = 'none'; document.body.appendChild(iframe); }
        const form = document.createElement('form'); form.method = 'POST'; form.action = GAS_MAIN_URL; form.target = 'gas-submit-iframe'; form.style.display = 'none';
        const a = document.createElement('input'); a.type = 'hidden'; a.name = 'action'; a.value = 'addNewUser'; form.appendChild(a);
        const d = document.createElement('input'); d.type = 'hidden'; d.name = 'userData'; d.value = JSON.stringify(userData); form.appendChild(d);
        document.body.appendChild(form); form.submit(); setTimeout(() => { document.body.removeChild(form); }, 1000);
      } catch (e) { console.warn('Failed to send user to GAS:', e); }
    }
    function syncAddressFromBasicInfo() {
      const currentUserId = document.getElementById('basic-clientId')?.value;
      const addressField = document.querySelector('[data-field="address"]');
      if (currentUserId && addressField) {
        const newAddress = addressField.value;
        const idx = allUsers.findIndex(u => u.id === currentUserId);
        if (idx !== -1) {
          allUsers[idx].address = newAddress;
          const row = document.querySelector('tr[data-id="' + currentUserId + '"]');
          if (row) {
            row.setAttribute('data-address', newAddress);
            const addressCell = row.querySelector('.address-cell'); if (addressCell) addressCell.textContent = newAddress;
          }
        }
      }
    }

    /* ================================================================
       ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’é–‹)nclickå±æ€§ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ï¿½
    ================================================================ */
    window.openBasicInfoModal = openBasicInfoModal;
    window.openUpdateModal = openUpdateModal;
    window.openPlanFimModal = openPlanFimModal;
    window.openDocumentsModal = openDocumentsModal;
    window.closeModal = closeModal;
    window.openWeeklyCareplan = openWeeklyCareplan;
    window.uploadDocumentFile = uploadDocumentFile;
    window.viewDocument = viewDocument;
    window.deleteDocument = deleteDocument;
    window.filterByUsageStatus = filterByUsageStatus;

    /**
     * PDFå‡ºåŠ›æ©Ÿ(è¨ˆç”»æ›¸(FIM)ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆçµŒç”±ã§PDFã‚’ç”Ÿæˆ
     */
    async function exportPlanFimToPDF(planType = 'shogai') {
      try {
        console.log('[PDF Export] Starting... Type:', planType);

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³IDã‚’å‹•çš„ã«é¸æŠï¼‰
        let buttonId;
        if (planType === 'kaigo') {
          buttonId = 'plan-fim-pdf-kaigo-button';
        } else if (planType === 'ido') {
          buttonId = 'plan-fim-pdf-ido-button';
        } else {
          buttonId = 'plan-fim-pdf-shogai-button';
        }
        const pdfButton = document.getElementById(buttonId);
        const originalButtonText = pdfButton.innerHTML;
        pdfButton.disabled = true;
        pdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PDFç”Ÿæˆä¸­...';

        // åˆ©ç”¨è€…IDã‚’å–å¾—
        const userId = document.getElementById('plan-fim-clientId').value;
        if (!userId) {
          alert('åˆ©ç”¨è€…IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          pdfButton.disabled = false;
          pdfButton.innerHTML = originalButtonText;
          return;
        }

        // ä»‹è­·è¨ˆç”»æ›¸ã®å ´åˆã¯å°‚ç”¨ã®GASã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
        if (planType === 'kaigo') {
          if (KAIGO_PLAN_GAS_URL === 'YOUR_GAS_DEPLOY_URL_HERE') {
            alert('ä»‹è­·è¨ˆç”»æ›¸ã®GASã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nKAIGO_PLAN_GAS_URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            pdfButton.disabled = false;
            pdfButton.innerHTML = originalButtonText;
            return;
          }

          try {
            showLoadingSpinner('ä»‹è­·è¨ˆç”»æ›¸ã‚’ç”Ÿæˆä¸­...');

            // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½¿ç”¨ï¼ˆCORSå•é¡Œã‚’å›é¿ï¼‰
            const url = `${KAIGO_PLAN_GAS_URL}?userId=${encodeURIComponent(userId)}`;
            const response = await fetch(url, {
              method: 'GET'
            });

            const result = await response.json();

            if (result.success) {
              showToast('ä»‹è­·è¨ˆç”»æ›¸PDFã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼', 'success');
              // PDFã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
              window.open(result.pdfUrl, '_blank');
            } else {
              throw new Error(result.error || 'PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } catch (error) {
            console.error('Kaigo PDF generation error:', error);
            showToast('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
          } finally {
            hideLoadingSpinner();
            pdfButton.disabled = false;
            pdfButton.innerHTML = originalButtonText;
          }
          return;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¨ˆç”»æ›¸(FIM)ã®å…¥åŠ›å€¤ã‚’åé›†ï¼ˆéšœå®³ãƒ»ç§»å‹•è¨ˆç”»æ›¸ç”¨ï¼‰
        const planFimData = {};
        document.querySelectorAll('#plan-fim-dynamic-fields input, #plan-fim-dynamic-fields textarea, #plan-fim-dynamic-fields select').forEach(input => {
          if (input.id) {
            planFimData[input.id] = input.value || '';
          }
        });

        console.log('[PDF Export] Collected plan FIM data:', planFimData);

        if (!USE_FIREBASE || !window.db) {
          alert('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          pdfButton.disabled = false;
          pdfButton.innerHTML = originalButtonText;
          return;
        }

        // Firestoreã‹ã‚‰è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const { doc, getDoc, collection } = window.firebaseModules;
        const userDocRef = doc(window.db, 'riyousya', userId);

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬ãƒ‡ãƒ¼ã‚¿(åå‰ãªã©(ã‚’å–å¾—
        const userSnapshot = await getDoc(userDocRef);
        const userData = userSnapshot.exists() ? userSnapshot.data() : {};
        console.log('[PDF Export] User data loaded:', userData);

        // 2. åŸºæœ¬æƒ…å ±ã‚’å–å¾—
        const basicInfoDocRef = doc(collection(userDocRef, 'basicInfo'), 'data');
        const basicInfoSnapshot = await getDoc(basicInfoDocRef);
        const basicInfo = basicInfoSnapshot.exists() ? (basicInfoSnapshot.data().values || {}) : {};
        console.log('[PDF Export] Basic info loaded:', basicInfo);

        // Timestampã‚’æ–‡å­—ã«å¤‰æ›
        if (basicInfo.birthdate && basicInfo.birthdate.toDate) {
          basicInfo.birthdate = timestampToDateString(basicInfo.birthdate);
        }

        // 3. è¨ˆç”»æ›¸(FIM)ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const planFimDocRef = doc(collection(userDocRef, 'planFim'), 'data');
        const planFimSnapshot = await getDoc(planFimDocRef);
        const planFimValues = planFimSnapshot.exists() ? (planFimSnapshot.data().values || {}) : {};
        console.log('[PDF Export] Plan FIM values loaded:', planFimValues);

        // 4. é€±é–“ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã‚’å–å¾—
        const weeklyCarePlan = userSnapshot.exists() ? (userSnapshot.data().carePlan || {}) : {};
        console.log('[PDF Export] Weekly care plan loaded:', weeklyCarePlan);

        // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
        const userName = userData.name || basicInfo.name || '';
        if (!userName) {
          const modalUserName = document.getElementById('plan-fim-modal-user-name');
          if (modalUserName && modalUserName.textContent) {
            userData.name = modalUserName.textContent;
          } else {
            const confirmed = confirm('åˆ©ç”¨è€…ã®åå‰ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãã‚Œã§ã‚‚PDFã‚’ç”Ÿæˆã—ã¾ã™ã‹?');
            if (!confirmed) {
              pdfButton.disabled = false;
              pdfButton.innerHTML = originalButtonText;
              return;
            }
          }
        }

        // GASã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ (JSONPæ–¹å¼ã§CORSã‚’å›é¿)
        // file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‹ã‚‰ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€scriptã‚¿ã‚°ã‚’ä½¿ç”¨ã—ãŸJSONPæ–¹å¼ã‚’æ¡ç”¨
        // ãƒ‡ãƒ¼ã‚¿é‡ã‚’å‰Šæ¸›ã™ã‚‹ãŸã‚ã€userIdã®ã¿ã‚’é€ä¿¡ã—ã€GASå´ã§Firestoreã‹ã‚‰å–å¾—ã™ã‚‹æ–¹å¼ã«å¤‰æ›´
        const GAS_ENDPOINT = GAS_MAIN_URL;

        console.log('[PDF Export] GAS Endpoint URL:', GAS_ENDPOINT);
        console.log('[PDF Export] Sending data to GAS endpoint via JSONP...');

        // PDFç”Ÿæˆã«è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡(ãƒ‡ãƒ‡ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–)
        // family_environmentã‹ã‚‰é›»è©±ç•ªå·ã®ã¿æŠ½å‡º
        let familyPhone = '';
        if (userData.family_environment && Array.isArray(userData.family_environment) &&
          userData.family_environment.length > 0 && userData.family_environment[0].phone) {
          familyPhone = userData.family_environment[0].phone;
        }

        // carePlanã‹ã‚‰è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
        const minimalServices = [];
        if (weeklyCarePlan.services && Array.isArray(weeklyCarePlan.services)) {
          weeklyCarePlan.services.forEach(service => {
            const minService = {
              type: service.type || '',
              schedule: {}
            };

            // åæ—¥ã®startTimeã¨endTimeã®ã¿æŠ½å‡º
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            days.forEach(day => {
              if (service.schedule && service.schedule[day]) {
                minService.schedule[day] = {
                  startTime: service.schedule[day].startTime || '',
                  endTime: service.schedule[day].endTime || ''
                };
              }
            });

            minimalServices.push(minService);
          });
        }

        const requestPayload = {
          action: 'generatePlanPDF',
          planType: planType,  // 'shogai' ã¾ãŸã¯ 'kaigo' ã‚’è¿½åŠ 
          userId: userId,
          userData: {
            name: userData.name || '',
            address: userData.address || '',
            birthdate: basicInfo.birthdate || '',
            division: basicInfo.division || '',
            familyPhone: familyPhone  // é…ã§ã¯ãªãæ–‡å­—
          },
          planFimValues: {
            comprehensive_support_policy: planFimValues.comprehensive_support_policy || '',
            client_family_wishes: planFimValues.client_family_wishes || '',
            long_term_goal: planFimValues.long_term_goal || '',
            medical_advice_physical: planFimValues.medical_advice_physical || '',
            medical_advice_lifestyle: planFimValues.medical_advice_lifestyle || '',
            care_procedure: planFimValues.care_procedure || '',
            plan_remarks: planFimValues.plan_remarks || '',
            explanation_date: planFimValues.explanation_date || '',
            explainer_name: planFimValues.explainer_name || ''
          },
          carePlan: {
            services: minimalServices  // æœ€å°åŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ã¿
          }
        };

        const payloadJson = JSON.stringify(requestPayload);
        console.log('[PDF Export] Request payload:', requestPayload);
        console.log('[PDF Export] Payload JSON:', payloadJson);
        console.log('[PDF Export] Payload size:', payloadJson.length, 'bytes');
        console.log('[PDF Export] userData details:', {
          name: requestPayload.userData.name,
          address: requestPayload.userData.address,
          birthdate: requestPayload.userData.birthdate,
          division: requestPayload.userData.division,
          familyPhone: requestPayload.userData.familyPhone
        });

        // JSONPæ–¹å¼ã§GASã‚’å‘¼ã³å‡ºã™ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ã)
        const result = await new Promise((resolve, reject) => {
          const callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const timeoutMs = 60000; // 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ã¦
          let timeoutId;
          let scriptElement;

          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
          timeoutId = setTimeout(() => {
            cleanup();
            reject(new Error('GASã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (30ç§’)ã€‚GASå´ã®å‡¦ç†æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'));
          }, timeoutMs);

          // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
          const cleanup = () => {
            if (timeoutId) clearTimeout(timeoutId);
            if (window[callbackName]) delete window[callbackName];
            if (scriptElement && scriptElement.parentNode) {
              scriptElement.parentNode.removeChild(scriptElement);
            }
          };

          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
          window[callbackName] = function (response) {
            cleanup();
            console.log('[PDF Export] Received response from GAS:', response);

            if (response && response.status === 'success') {
              resolve(response);
            } else {
              reject(new Error(response?.message || 'PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          };

          // scriptã‚¿ã‚°ã‚’ä½œæˆã—ã¦JSONPãƒªã‚¯ã‚¨ãƒªãƒªã‚¹ãƒˆã‚’é€ä¿¡
          scriptElement = document.createElement('script');
          const dataParam = encodeURIComponent(payloadJson);
          scriptElement.src = `${GAS_ENDPOINT}?callback=${callbackName}&data=${dataParam}`;

          console.log('[PDF Export] JSONP URL length:', scriptElement.src.length, 'characters');

          // URLé•·ãƒã‚§ãƒƒã‚¯ (8000å­—ç¨‹åº¦ã¾ã§ã«åˆ¶é™)
          if (scriptElement.src.length > 8000) {
            cleanup();
            reject(new Error('é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã¾ã™ (URLé•·: ' + scriptElement.src.length + 'æ–‡å­—)ã€‚\n\nè¨ˆç”»æ›¸ã®ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆãŒé•·ã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'));
            return;
          }

          // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          scriptElement.onerror = function (event) {
            cleanup();
            console.error('[PDF Export] Script load error:', event);
            reject(new Error('GASã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã¾ãŸã¯GASã®URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'));
          };

          scriptElement.onload = function () {
            console.log('[PDF Export] Script loaded successfully');
          };

          document.body.appendChild(scriptElement);
          console.log('[PDF Export] JSONP request sent, waiting for response...');
        });

        console.log('[PDF Export] GAS response:', result);

        if (result.status === 'success') {
          const planTypeName = planType === 'kaigo' ? 'ä»‹è­·è¨ˆç”»æ›¸' : 'éšœå®³è¨ˆç”»æ›¸';
          alert(planTypeName + 'ã®PDFã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚\n\nãƒ•ã‚¡ã‚¤ãƒ«å: ' + result.fileName + '\n\nGoogle Driveã§é–‹ãã¾ã™ã‹?');

          // PDFã‚’Google Driveã§é–‹ã
          if (confirm('Google Driveã§é–‹ãã¾ã™ã‹?')) {
            window.open(result.pdfUrl, '_blank');
          }

          console.log('[PDF Export] PDF generated successfully');
          console.log('[PDF Export] PDF URL:', result.pdfUrl);
        } else {
          throw new Error(result.message || 'PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        pdfButton.disabled = false;
        pdfButton.innerHTML = originalButtonText;

      } catch (error) {
        console.error('[PDF Export] Error:', error);
        console.error('[PDF Export] Error name:', error.name);
        console.error('[PDF Export] Error stack:', error.stack);

        let errorMessage = 'PDFå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n';
        errorMessage += 'ã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘\n';
        errorMessage += error.message + '\n\n';

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage += 'ã€è¨¼ã‚‰ã‚Œã‚‹åŸå› ã€‘\n';
          errorMessage += 'ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå•é¡Œ\n';
          errorMessage += 'ãƒ»GASã‚¨ãƒ³ãƒ‰ã‚¤ãƒ³ãƒˆURLãŒç„¡åŠ¹\n';
          errorMessage += 'ãƒ»CORSè¨­å®šå•é¡Œ\n\n';
          errorMessage += 'ã€ç¢ºèªäº‹é …ç›®\n';
          errorMessage += '1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\n';
          errorMessage += '2. GASã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„\n';
          errorMessage += '3. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
        }

        alert(errorMessage);

        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™ï¼ˆä¸¡æ–¹ã®ãƒœã‚¿ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
        const shogaiButton = document.getElementById('plan-fim-pdf-shogai-button');
        const kaigoButton = document.getElementById('plan-fim-pdf-kaigo-button');
        if (shogaiButton) {
          shogaiButton.disabled = false;
          shogaiButton.innerHTML = '<i class="fas fa-file-pdf"></i> éšœå®³è¨ˆç”»æ›¸ä½œæˆ';
        }
        if (kaigoButton) {
          kaigoButton.disabled = false;
          kaigoButton.innerHTML = '<i class="fas fa-file-pdf"></i> ä»‹è­·è¨ˆç”»æ›¸ä½œæˆ';
        }
      }
    }

    window.exportPlanFimToPDF = exportPlanFimToPDF;

    /* --- è¨ˆç”»æ›¸PDFå‡ºåŠ›æ©Ÿèƒ½ (JSONPç‰ˆ) --- */
    async function generatePlanPDF(userId, userName) {
      console.log(`[ç°¡æ˜“PDFç”Ÿæˆ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}, åå‰: ${userName}`);

      try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        const loadingMsg = `${userName}ã•ã‚“ã®è¨ˆç”»æ›¸PDFã‚’ç”Ÿæˆä¸­...`;
        showToast(loadingMsg, 'info');

        // Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const { doc, getDoc, collection } = window.firebaseModules;

        // åŸºæœ¬æƒ…å ±ã‚’å–å¾—
        const userDocRef = doc(window.db, 'riyousya', userId);
        const userSnapshot = await getDoc(userDocRef);

        if (!userSnapshot.exists()) {
          throw new Error('åˆ©ç”¨è€…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        const userData = userSnapshot.data();

        // åŸºæœ¬æƒ…å ±ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const basicInfoRef = doc(collection(userDocRef, 'basicInfo'), 'data');
        const basicInfoSnapshot = await getDoc(basicInfoRef);

        let birthdate = '';
        let address = userData.address || '';
        let contact = '';

        if (basicInfoSnapshot.exists()) {
          const basicInfoData = basicInfoSnapshot.data();
          const values = basicInfoData.values || {};

          // ç”Ÿå¹´æœˆæ—¥ã®å–å¾—)imestampã¾ãŸå­—)
          if (values.birthdate) {
            if (values.birthdate.toDate) {
              birthdate = timestampToDateString(values.birthdate);
            } else {
              birthdate = values.birthdate;
            }
          }

          // ä½æ‰€ã®æ›´æ–°(åŸºæœ¬æƒ…å ±ã«ã‚ã‚Œã°å„ªå…ˆ)
          if (values.address) {
            address = values.address;
          }

          // é€£çµ¡å…ˆå–å¾—ï¼ˆç·Šæ€¥é€£çµ¡å…ˆã¾ãŸå®¶æ—é€£çµ¡å…ˆ)
          contact = values.emergency_contact || values.family_contact || '';
        }

        console.log('[ç°¡æ˜“PDFç”Ÿæˆ] ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†', {
          æ°å: userName,
          ä½æ‰€: address,
          é€£çµ¡å…: contact,
          ç”Ÿå¹´æœˆæ—¥: birthdate
        });

        // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦PDFã‚’ç”Ÿæˆ)SONPæ–¹å¼)
        const payload = {
          action: 'generatePlanPDF',
          userId: userId,
          userData: {
            name: userName,
            address: address,
            contact: contact,
            birthdate: birthdate
          }
        };

        console.log('[ç°¡æ˜“PDFç”Ÿæˆ] GASã«POSTãƒªã‚¯ã‚¨ãƒªãƒªã‚¹ãƒˆé€ä¿¡:', payload);

        // é€šå¸¸ã®fetch POSTãƒªã‚¯ã‚¨ãƒªãƒªã‚¹ãƒˆã§GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        const response = await fetch(GAS_MAIN_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
        }

        const result = await response.json();
        console.log('[ç°¡æ˜“PDFç”Ÿæˆ] GASã‹ã‚‰ã®å¿œç­E', result);

        if (result.status === 'success') {
          showToast('PDFç”ŸæˆãŒå®Œäº†ã¾ã—ãŸ', 'success');

          // PDFã®URLãŒã‚ã‚Œæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
          if (result.pdfUrl) {
            window.open(result.pdfUrl, '_blank');
          } else if (result.message) {
            alert(result.message);
          }
        } else {
          throw new Error(result.message || 'PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('[ç°¡æ˜“PDFç”Ÿæˆ] ã‚¨ãƒ©ãƒ¼:', error);
        showToast('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        alert('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€Œn\nã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message);
      }
    }

    /* ================================================================
       ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½å±¥æ­´æ©Ÿ
    ================================================================ */

    // ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„
    async function openServiceHistoryModal(userId, userName) {
      console.log('Opening service history modal for:', userId, userName);

      const modal = document.getElementById('service-history-modal');
      const loader = document.getElementById('service-history-loader');
      const historyList = document.getElementById('service-history-list');
      const emptyMessage = document.getElementById('service-history-empty');

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒ†ãƒ¼
      modal.style.display = '';
      modal.classList.remove('visible');

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
      historyList.innerHTML = '';
      emptyMessage.style.display = 'none';
      loader.style.display = 'none';

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
      document.getElementById('service-history-modal-user-name').textContent = userName;
      document.getElementById('service-history-userId').textContent = userId;
      document.getElementById('service-history-userName').textContent = userName;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º(å°‘ã—å»¶ã•ã›ã¦ç¢ºå®Ÿã«è¡¨ç¤º)
      setTimeout(() => {
        modal.classList.add('visible');
      }, 10);

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      loader.style.display = 'block';

      try {
        // Firebase Realtime Databaseã‹ã‚‰å±¥æ­´ã‚’å–å¾—
        const records = await getServiceRecordsForUser(userName);

        loader.style.display = 'none';

        if (records.length === 0) {
          emptyMessage.style.display = 'block';
          return;
        }

        // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã—ã¦è¡¨ç¤º
        records.forEach(record => {
          const historyItem = createHistoryItem(record);
          historyList.appendChild(historyItem);
        });

      } catch (error) {
        console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        loader.style.display = 'none';
        showToast('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }

    // Firestoreã‹ã‚‰ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ¼ãƒ“ã‚¹è¨˜éŒ²ã‚’å–å¾—ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½ç”»é¢ã¨åŒã˜ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰)
    async function getServiceRecordsForUser(userName, limit = 200) {
      console.log('[å±¥æ­´å–å¾—] é–‹å§E', userName);

      if (!window.db) {
        console.error('[å±¥æ­´å–å¾—] FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        throw new Error('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }

      try {
        console.log('[å±¥æ­´å–å¾—] Firestoreã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­...');

        const { collection, query, where, orderBy, getDocs, limit: limitFn } = window.firebaseModules;

        // ã‚µãƒ¼ãƒ“ã‚¹å®Ÿæ–½ç”»é¢ã¨åŒã˜ã‚¯ã‚¨ãƒª: serviceRecordsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
        const q = query(
          collection(window.db, 'serviceRecords'),
          where('customer', '==', userName),
          orderBy('date', 'desc'),
          orderBy('start', 'desc'),
          limitFn(limit)
        );

        const snapshot = await getDocs(q);

        console.log('[å±¥æ­´å–å¾—] ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº† size:', snapshot.size);

        if (snapshot.empty) {
          console.log('[å±¥æ­´å–å¾—] ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          return [];
        }

        const allRecords = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          allRecords.push({
            id: docSnap.id,
            customerName: data.customerName || data.customer,
            customer: data.customer,
            date: data.date,
            serviceType: data.serviceType || data.type,
            startActual: data.startTime || data.start,
            endActual: data.endTime || data.end,
            actualDuration: data.actualDuration || '',
            notes: data.notes,
            details: data.details,
            userEmail: data.userEmail || data.helperEmail,
            ...data
          });
        });

        console.log('[å±¥æ­´å–å¾—] çµæœ:', allRecords.length, 'ä»¶');

        return allRecords;
      } catch (error) {
        console.error('[å±¥æ­´å–å¾—] ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        console.error('[å±¥æ­´å–å¾—] ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰', error.code);
        console.error('[å±¥æ­´å–å¾—] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
        throw error;
      }
    }

    // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
    function createHistoryItem(record) {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.onclick = () => showHistoryDetail(record);

      const header = document.createElement('div');
      header.className = 'history-header';

      const date = document.createElement('div');
      date.className = 'history-date';
      date.textContent = record.date || new Date(parseInt(record.id || record.timestamp)).toLocaleDateString('ja-JP');

      const serviceType = document.createElement('div');
      serviceType.className = 'history-service-type';
      serviceType.textContent = record.serviceType || 'ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥ä¸';

      header.appendChild(date);
      header.appendChild(serviceType);

      const info = document.createElement('div');
      info.className = 'history-info';

      const timeTag = document.createElement('span');
      timeTag.className = 'info-tag';
      timeTag.textContent = `${record.startActual || '--:--'} ã€Œ${record.endActual || '--:--'}`;
      info.appendChild(timeTag);

      div.appendChild(header);
      div.appendChild(info);

      return div;
    }

    // å±¥æ­´è©³ç´°ã‚’è¡¨ç¤º
    function showHistoryDetail(record) {
      const modalTitle = `${record.customerName || record.customer || 'ä¸'} - ${record.date || ''}`;

      const escapeHtml = (str) => {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
      };

      let detailHTML = `
    <div class="history-detail-section">
      <h3>åŸºæœ¬æƒ…å ±</h3>
      <p><strong>é¡§å®¢å</strong> ${escapeHtml(record.customerName || record.customer || 'ä¸')}</p>
      <p><strong>ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥:</strong> ${escapeHtml(record.serviceType || record.type || 'ä¸')}</p>
      <p><strong>æ—¥ä»–</strong> ${escapeHtml(record.date || '')}</p>
    </div>

    <div class="history-detail-section">
      <h3>æ™‚åˆ»</h3>
      <p><strong>é–‹å§E</strong> ${escapeHtml(record.startActual || record.startTime || record.start || '--:--')}</p>
      <p><strong>çµ‚äº†</strong> ${escapeHtml(record.endActual || record.endTime || record.end || '--:--')}</p>
      ${record.actualDuration ? `<p><strong>å®Ÿç¸¾æ™‚é–“:</strong> <span style="color:#059669;font-weight:600">${escapeHtml(record.actualDuration)}</span></p>` : ''}
    </div>
  `;

      // è¨˜éŒ²)otes)
      if (record.notes) {
        detailHTML += `
      <div class="history-detail-section">
        <h3>è¨˜éŒ²</h3>
        <div style="white-space: pre-wrap; background: #f9fafb; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
          ${escapeHtml(record.notes)}
        </div>
      </div>
    `;
      }

      // è©³ç´°)etails)
      if (record.details) {
        detailHTML += `
      <div class="history-detail-section">
        <h3>è©³ç´°</h3>
        <div style="white-space: pre-wrap; background: #f9fafb; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
          ${escapeHtml(record.details)}
        </div>
      </div>
    `;
      }

      // ã‚µãƒ¼ãƒ“ã‚¹è¨˜éŒ²è©³ç´°
      if (record.detailSelections && Object.keys(record.detailSelections).length > 0) {
        detailHTML += '<div class="history-detail-section"><h3>ã‚µãƒ¼ãƒ“ã‚¹è¨˜éŒ²</h3>';

        Object.entries(record.detailSelections).forEach(([category, items]) => {
          if (items && items.length > 0) {
            const displayCategory = category.replace(/-/g, ' > ');
            const itemList = items.map(item => {
              if (typeof item === 'object') {
                if (item.item === 'çŒ®ç«‹' && item.text) {
                  return `${item.item}(${item.text})`;
                } else if (item.value) {
                  return `${item.item}(${item.value})`;
                } else {
                  return item.item;
                }
              }
              return item;
            }).join(', ');

            detailHTML += `<p><strong>${escapeHtml(displayCategory)}:</strong><br>${escapeHtml(itemList)}</p>`;
          }
        });

        detailHTML += '</div>';
      }

      // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªãƒ¼
      if (record.logEntries) {
        detailHTML += `
      <div class="history-detail-section">
        <h3>ä½ç½®æƒ…å ±ãƒ­ã‚°</h3>
        <div class="service-detail">${escapeHtml(record.logEntries)}</div>
      </div>
    `;
      }

      // è¨˜éŒ²è€…
      if (record.userEmail || record.helperEmail) {
        detailHTML += `
      <div class="history-detail-section">
        <p style="font-size:0.9rem;color:#6b7280;"><strong>è¨˜éŒ²è€…</strong> ${escapeHtml(record.userEmail || record.helperEmail)}</p>
      </div>
    `;
      }

      // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
      showCustomModal(modalTitle, detailHTML);
    }

    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°
    function showCustomModal(title, content) {
      // æ—¢å­˜ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œå‰Šé™¤
      const existingModal = document.getElementById('custom-detail-modal');
      if (existingModal) {
        existingModal.remove();
      }

      // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
      const modal = document.createElement('div');
      modal.id = 'custom-detail-modal';
      modal.className = 'modal-backdrop visible';
      modal.style.zIndex = '1001';

      modal.innerHTML = `
    <div class="modal-content history-detail-modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 style="margin: 0;">${title}</h2>
        <button class="modal-close" onclick="document.getElementById('custom-detail-modal').remove()">&times;</button>
      </div>
      <div>${content}</div>
    </div>
  `;

      // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹"
      modal.onclick = () => modal.remove();

      document.body.appendChild(modal);
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–E
    window.generatePlanPDF = generatePlanPDF;
    window.openServiceHistoryModal = openServiceHistoryModal;

    console.log('All functions exposed to global scope');
    console.log('Function check:', {
      openBasicInfoModal: typeof window.openBasicInfoModal,
      openUpdateModal: typeof window.openUpdateModal,
      openDocumentsModal: typeof window.openDocumentsModal,
      closeModal: typeof window.closeModal,
      generatePlanPDF: typeof window.generatePlanPDF,
      openServiceHistoryModal: typeof window.openServiceHistoryModal
    });
  </script>

  <!-- App Initialization -->
  <script>
    // èªè¨¼ãªã—ã§ç›´æ¥ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
    window.addEventListener('DOMContentLoaded', () => {
      console.log('[DEMO] App starting without authentication');
      initializeApp();
    });

    // App initialization function
    function initializeApp() {
      console.log('[DEMO] App initialized');
      initializeClientApplication();
    }

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
    function initializeClientApplication() {
      console.log('[DEMO] Initializing client application with demo data');

      const users = window.DEMO_USERS || [];

      // åˆå›æç”»
      renderUserTable(users);

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°(åˆå›)
      updatePaginationInfo(users);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
      initializeFilters(users);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupFilterListeners();

      console.log('[DEMO] Loaded', users.length, 'demo users');
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»ã™ã‚‹
     */
    function renderUserTable(users) {
      const tbody = document.querySelector('#user-table-body');
      if (!tbody) {
        console.error('[DEMO] Table body not found');
        return;
      }

      tbody.innerHTML = '';

      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding: 20px;">è©²å½“ã™ã‚‹åˆ©ç”¨è€…ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>';
        updateListCount(0);
        return;
      }

      users.forEach(user => {
        const row = document.createElement('tr');

        let statusClass = 'status-active';
        if (user.status === 'ä¼‘æ­¢ä¸­') statusClass = 'status-paused';
        if (user.status === 'åˆ©ç”¨çµ‚äº†') statusClass = 'status-ended';

        const noticeBadge = user.notice ?
          `<span class="badge-danger">${user.notice}</span>` :
          '<span style="color:#999;">-</span>';

        const weeklyCarePlanUrl = `../weekly-care-plan/index.html?user=${user.id}`;

        row.innerHTML = `
          <td>${user.id}</td>
          <td><button class="icon-btn" title="æ›¸é¡" onclick="openDocumentsModal('${user.id}')">ğŸ“</button></td>
          <td><strong>${user.name}</strong><br><small style="color:#888;">${user.kana}</small></td>
          <td>${user.manager}</td>
          <td><span class="status-badge ${statusClass}">${user.status}</span></td>
          <td>${user.address}</td>
          <td>${user.content || '-'}</td>
          <td>${noticeBadge}</td>
          <td>
            <a href="${weeklyCarePlanUrl}" class="btn btn-outline-primary" style="font-size:11px; padding:4px 8px; display:inline-flex; align-items:center; gap:4px; text-decoration:none; border: 1px solid #0d6efd; color: #0d6efd; background: white; border-radius: 4px;">
                <i class="fas fa-calendar-alt"></i> é€±ã‚±ã‚¢
            </a>
          </td>
          <td><button class="icon-btn" title="åŸºæœ¬æƒ…å ±" onclick="openBasicInfoModal('${user.id}')">ğŸ“‹</button></td>
          <td><button class="icon-btn" title="è¨ˆç”»æ›¸" onclick="openPlanFimModal('${user.id}')">ğŸ“</button></td>
          <td><button class="icon-btn" title="æ›´æ–°æ›¸é¡" onclick="openUpdateModal('${user.id}')">ğŸ“„</button></td>
          <td><button class="icon-btn" title="å±¥æ­´" onclick="openServiceHistoryModal('${user.id}')">ğŸ•’</button></td>
        `;

        tbody.appendChild(row);
      });

      updateListCount(users.length);
    }

    function updateListCount(count) {
      const listCount = document.getElementById('listCount');
      if (listCount) {
        const total = window.DEMO_USERS ? window.DEMO_USERS.length : 0;
        listCount.textContent = `è¡¨ç¤ºä¸­: ${count}ä»¶ / ç·æ•°: ${total}ä»¶`;
      }
    }

    function updatePaginationInfo(users) {
      const paginationInfo = document.getElementById('pagination-info');
      const paginationInfoTop = document.getElementById('pagination-info-top');
      const count = users.length;
      const paginationText = count > 0 ? `1-${count} / ${count}ä»¶` : `0ä»¶`;

      if (paginationInfo) paginationInfo.textContent = paginationText;
      if (paginationInfoTop) paginationInfoTop.textContent = paginationText;
    }

    function setupFilterListeners() {
      const inputs = ['filter-id', 'filter-name', 'filter-manager', 'filter-usage', 'filter-address', 'filter-content', 'filter-notice'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', debounce(applyFilters, 300));
          el.addEventListener('change', applyFilters);
        }
      });
    }

    function applyFilters() {
      const users = window.DEMO_USERS || [];

      const idVal = document.getElementById('filter-id')?.value.toLowerCase().trim();
      const nameVal = document.getElementById('filter-name')?.value.toLowerCase().trim();
      const managerVal = document.getElementById('filter-manager')?.value;
      const usageVal = document.getElementById('filter-usage')?.value;
      const addressVal = document.getElementById('filter-address')?.value;
      const contentVal = document.getElementById('filter-content')?.value;
      const noticeVal = document.getElementById('filter-notice')?.value;

      const filtered = users.filter(user => {
        if (idVal && !user.id.toLowerCase().includes(idVal)) return false;

        if (nameVal) {
          const nameInfo = (user.name + user.kana).toLowerCase();
          if (!nameInfo.includes(nameVal)) return false;
        }

        if (managerVal && user.manager !== managerVal) return false;
        if (usageVal && user.status !== usageVal) return false;
        if (addressVal && !user.address.includes(addressVal)) return false;
        if (contentVal && user.content !== contentVal) return false;

        if (noticeVal) {
          const hasNotice = !!user.notice;
          if (noticeVal === 'ã‚ã‚Š' && !hasNotice) return false;
          if (noticeVal === 'ãªã—' && hasNotice) return false;
        }

        return true;
      });

      renderUserTable(filtered);
      updatePaginationInfo(filtered);
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆæœŸåŒ–
    function initializeFilters(users) {
      // ã‚µè²¬ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const managerFilter = document.getElementById('filter-manager');
      if (managerFilter) {
        const managers = [...new Set(users.map(u => u.manager))];
        managerFilter.innerHTML = '<option value="">å…¨ã¦</option>' +
          managers.map(m => `<option value="${m}">${m}</option>`).join('');
      }

      // åˆ©ç”¨çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const usageFilter = document.getElementById('filter-usage');
      if (usageFilter) {
        const statuses = [...new Set(users.map(u => u.status))];
        usageFilter.innerHTML = '<option value="">å…¨ã¦</option>' +
          statuses.map(s => `<option value="${s}">${s}</option>`).join('');
      }

      // ä½æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const addressFilter = document.getElementById('filter-address');
      if (addressFilter) {
        const addresses = [...new Set(users.map(u => u.address))];
        addressFilter.innerHTML = '<option value="">å…¨ã¦</option>' +
          addresses.map(a => `<option value="${a}">${a}</option>`).join('');
      }

      // å†…å®¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const contentFilter = document.getElementById('filter-content');
      if (contentFilter) {
        const contents = [...new Set(users.map(u => u.content).filter(c => c))];
        contentFilter.innerHTML = '<option value="">å…¨ã¦</option>' +
          contents.map(c => `<option value="${c}">${c}</option>`).join('');
      }

      // ãŠçŸ¥ã‚‰ã›ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const noticeFilter = document.getElementById('filter-notice');
      if (noticeFilter) {
        noticeFilter.innerHTML = '<option value="">å…¨ã¦</option><option value="ã‚ã‚Š">ã‚ã‚Š</option><option value="ãªã—">ãªã—</option>';
      }
    }
  </script>


  <!-- PDF Generator Script -->
  <script src="pdf-generator.js"></script>

</body>

</html>