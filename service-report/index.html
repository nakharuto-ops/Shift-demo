<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
    <title>サービス管理システム</title>

    <!-- Tailwind CSS (preflightをOFFで既存CSSに影響なし) -->
    <script>tailwind.config = { corePlugins: { preflight: false } }</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (JSX変換) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --blue: #0D47A1;
            --orange: #FF9800;
            --light-blue: #E3F2FD;
            --teal: #03A9F4;
            --bg: #f6f8fa;
            --card: #fff;
            --muted: #6b7280;
            --line: #e5e7eb;
            --shadow: 0 1px 2px rgba(0, 0, 0, .06);
            --navy: #263238;
            --navy-2: #455A64;
            --menu-h: 84px;
            --accent-current: #78C6F6;
            /* 開いている強調 */
            --accent-selected: #00ACC1;
            /* 選択済み強調 */
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            color: #111827;
            padding: 8px;
            font-size: 16px;
            line-height: 1.35
        }

        .container {
            max-width: 440px;
            margin: 0 auto;
            padding-bottom: calc(var(--menu-h) + env(safe-area-inset-bottom, 0px))
        }

        h1,
        h2 {
            color: var(--blue);
            text-align: center;
            border-bottom: 2px solid var(--orange);
            padding: 6px 0 8px;
            margin: 0;
            font-size: 1rem;
            font-weight: 600
        }

        .screen {
            background: var(--card);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--line);
            box-shadow: var(--shadow);
            margin-top: 8px
        }

        .hidden {
            display: none !important
        }

        .shift-item {
            border: 2px solid #cfd8dc;
            border-left: 6px solid #03A9F4;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            background: #fff;
            transition: .15s
        }

        .shift-item:active {
            background: #E3F2FD
        }

        .shift-item.selected {
            border-color: #FFCC80;
            border-left-color: #FF9800;
            background: #FFF3E0;
            font-weight: 600;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, .2) inset
        }

        .shift-item.completed {
            opacity: 0.5;
            background: #f5f5f5;
            border-color: #bdbdbd;
            cursor: not-allowed
        }

        .shift-item.completed:active {
            background: #f5f5f5
        }

        .shift-item .name {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .shift-item .time {
            white-space: nowrap;
            font-size: 0.95rem;
            color: #4b5563
        }

        .shift-item .type {
            background: #03A9F4;
            color: #fff;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: .82rem;
            white-space: nowrap
        }

        .action-button {
            display: block;
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
            background: #FF9800;
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow)
        }

        .action-button:active {
            transform: translateY(1px)
        }

        .bottom-menu-bar {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .menu-btn {
            flex: 1;
            padding: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #fff;
            cursor: pointer;
            text-align: center;
            color: var(--navy);
            text-decoration: none;
        }

        .menu-btn:active {
            background: #f0f0f0;
        }

        .link-item {
            display: block;
            padding: 16px;
            margin-bottom: 10px;
            background: #f9fafb;
            border: 1px solid var(--line);
            border-radius: 10px;
            text-decoration: none;
            color: var(--blue);
            font-weight: 600;
            text-align: center;
        }

        .salary-display {
            margin: 20px 0;
            padding: 16px;
            background: #f9fafb;
            border-radius: 10px;
            text-align: center;
        }

        .salary-display p {
            margin: 0 0 8px;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .salary-display h3 {
            margin: 0;
            color: var(--blue);
            font-size: 1.8rem;
        }

        #service-exec-screen {
            display: flex;
            flex-direction: column;
            height: 100dvh
        }

        .basic-info {
            position: sticky;
            top: 0;
            background: var(--card);
            z-index: 10;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 6px 8px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .info-layout {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 96px;
            grid-template-rows: auto auto;
            grid-template-areas: "name instruction-btn" "times end-btn";
            align-items: stretch;
            column-gap: 8px;
            row-gap: 6px;
        }

        .name-row {
            grid-area: name;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-width: 0
        }

        #customer-name {
            font-size: 1rem;
            font-weight: 700;
            margin: 0
        }

        .pill {
            display: inline-block;
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 2px 8px;
            font-size: .78rem;
            background: #f9fafb
        }

        .times-row {
            grid-area: times;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start
        }

        .time-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            border: 1px solid var(--line);
            border-radius: 8px;
            background: #f9fafb;
            font-size: .86rem;
            line-height: 1;
            box-shadow: var(--shadow)
        }

        .time-chip .tag {
            font-weight: 700;
            background: #eef5ff;
            border-radius: 6px;
            padding: 2px 6px
        }

        .btn {
            padding: 10px 8px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            font-size: .82rem
        }

        .btn-task {
            background: #90A4AE;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #btn-end {
            grid-area: end-btn;
            background: #90A4AE;
            width: 96px;
        }

        #btn-task-check {
            grid-area: instruction-btn;
            background: #90A4AE;
            width: 96px;
        }

        .record-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            padding: 4px 0 6px
        }

        .record-title {
            color: var(--blue);
            border-bottom: 2px solid var(--orange);
            padding-bottom: 6px;
            margin: 0 0 10px
        }

        .record-grid-main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px
        }

        .category-card {
            border: 2px solid var(--line);
            border-radius: 16px;
            background: #fff;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: .2s
        }

        .category-card[aria-expanded="true"] {
            border-color: var(--accent-current);
            box-shadow: 0 0 0 3px rgba(120, 198, 246, .25) inset, 0 8px 24px rgba(0, 0, 0, .12)
        }

        .category-card.has-selection {
            border-color: var(--accent-selected);
            box-shadow: 0 0 0 3px rgba(0, 172, 193, .18) inset
        }

        .category-header {
            width: 100%;
            border: none;
            background: transparent;
            padding: 14px 18px;
            font-size: 1.05rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            color: var(--navy);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 44px
        }

        .category-header:hover {
            background: rgba(3, 169, 244, .04)
        }

        .category-header::after {
            content: "\25BC";
            font-size: .8rem;
            opacity: .7;
            transition: .2s
        }

        .category-card[aria-expanded="true"] .category-header::after {
            transform: rotate(180deg)
        }

        .category-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height .25s ease, padding .25s ease;
            background: linear-gradient(to bottom, #fafbfc, #fff)
        }

        .category-card[aria-expanded="true"] .category-body {
            max-height: 2000px;
            padding: 0 20px 20px;
            border-top: 1px solid rgba(229, 231, 235, .5)
        }

        .category-body .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px
        }

        .record-btn {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #fff;
            padding: 12px 10px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .06);
            font-size: .9rem;
            transition: .15s
        }

        .record-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px)
        }

        .record-btn.selected {
            border-color: var(--accent-selected);
            background: #E0F7FA;
            color: #07464b;
            font-weight: 700;
            box-shadow: 0 0 0 3px rgba(0, 172, 193, .18) inset
        }

        .input-field,
        .menu-textarea {
            grid-column: 1/-1;
            margin-top: 12px;
            background: rgba(249, 250, 251, .8);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 12px;
        }

        .input-field label,
        .menu-textarea label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: .9rem;
            color: var(--navy)
        }

        .notes-card {
            grid-column: 1/-1;
            margin-top: 8px;
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px;
            box-shadow: var(--shadow)
        }

        .notes-card textarea {
            width: 100%;
            min-height: 110px;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px;
            font-size: 1rem;
            background: #f9fafb
        }

        .menu {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--card);
            border-top: 1px solid var(--line);
            padding-top: 6px;
            padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            z-index: 20
        }

        .menu .inner {
            max-width: 440px;
            margin: 0 auto;
            padding: 0 10px
        }

        .dock {
            display: flex;
            justify-content: space-around;
            align-items: center
        }

        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            flex: 1
        }

        .dot {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--line);
            background: #f3f4f6;
            box-shadow: var(--shadow);
            font-size: 20px
        }

        .dock-item.active .dot {
            outline: 3px solid var(--teal)
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            display: none;
            background: rgba(0, 0, 0, 0.4);
        }

        .modal.is-open {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal .sheet {
            position: relative;
            max-width: 400px;
            width: 90%;
            padding: 20px;
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .2)
        }

        .modal .close {
            position: absolute;
            right: 12px;
            top: 10px;
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer
        }

        /* 報告バッジ（黄色い！マーク） */
        #shift-report-btn,
        #dock-report {
            position: relative;
        }

        .report-badge-exclamation {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            border-radius: 9999px;
            background: #facc15;
            color: #111827;
            border: 2px solid #ffffff;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 900;
            line-height: 1;
        }

        @media (min-width:480px) {
            .container {
                max-width: 580px
            }
        }

        @media (min-width:768px) {
            .container {
                max-width: 720px
            }
        }

        .history-notes {
            white-space: pre-wrap
        }

        /* タブUI */
        .tab-container {
            display: flex;
            flex-direction: column;
            height: calc(100dvh - 140px);
        }

        .tab-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            background: #fff;
            border-bottom: 2px solid var(--line);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            flex: 1;
            min-width: 80px;
            padding: 12px 8px;
            border: none;
            background: transparent;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: .2s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--teal);
            border-bottom-color: var(--teal);
        }

        .tab-content-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px;
        }

        .tab-content.active {
            display: block;
        }

        /* チェックボックスグリッド */
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 8px;
            border: 1.5px solid var(--line);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: .15s;
            min-height: 44px;
            touch-action: manipulation;
        }

        .checkbox-item:active {
            background: #f0f9ff;
        }

        .checkbox-item.checked {
            border-color: var(--teal);
            background: #E0F7FA;
        }

        .checkbox-item.full-width {
            grid-column: 1/-1;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
            pointer-events: none;
        }

        .checkbox-item label {
            font-size: 0.9rem;
            cursor: pointer;
            flex: 1;
            user-select: none;
            pointer-events: none;
            line-height: 1.3;
        }

        /* 特記事項 */
        .notes-section {
            margin-top: 20px;
        }

        .notes-label {
            display: block;
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 10px;
            color: var(--navy);
        }

        .notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 14px;
            border: 2px solid var(--line);
            border-radius: 10px;
            font-size: 1rem;
            background: #f9fafb;
            resize: vertical;
            font-family: inherit;
        }

        /* バイタル入力 */
        .vital-section {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 16px;
            background: #f9fafb;
            border: 2px solid var(--line);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .vital-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vital-label {
            font-weight: 600;
            min-width: 80px;
        }

        .vital-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--line);
            border-radius: 8px;
            font-size: 1rem;
        }

        .vital-unit {
            color: var(--muted);
        }

        /* 確認画面 */
        #confirmation-screen {
            padding: 20px;
        }

        .confirm-section {
            margin-bottom: 24px;
        }

        .confirm-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--blue);
            border-bottom: 2px solid var(--orange);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .confirm-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .confirm-tag {
            display: inline-block;
            padding: 8px 14px;
            background: #E0F7FA;
            border: 1px solid var(--teal);
            border-radius: 20px;
            font-size: 0.95rem;
        }

        .confirm-notes {
            background: #f9fafb;
            padding: 14px;
            border-radius: 10px;
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .confirm-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #fff3e0;
            border: 2px solid var(--orange);
            border-radius: 12px;
            margin: 20px 0;
        }

        .confirm-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .confirm-checkbox label {
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .confirm-buttons button {
            flex: 1;
            padding: 16px;
            font-size: 1.05rem;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }

        /* アコーディオン */
        .accordion-header {
            transition: background-color .2s;
        }

        .accordion-header:hover {
            background-color: #f9fafb !important;
        }

        .accordion-header:active {
            background-color: #f3f4f6 !important;
        }

        .accordion-icon {
            transition: transform .3s ease;
        }

        .accordion-header[aria-expanded="true"] .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            transition: max-height .3s ease;
            overflow: hidden;
        }

        /* スマホ最適化 */
        @media (max-width: 480px) {
            body {
                font-size: 15px;
            }

            .tab-btn {
                font-size: 0.95rem;
                padding: 12px 8px;
            }

            .checkbox-item {
                padding: 12px 10px;
            }

            .checkbox-item label {
                font-size: 0.95rem;
            }
        }
    </style>
</head>

<body>


    <div id="login-container" class="container">
        <div class="screen">
            <h1>ログイン</h1>
            <div style="padding: 20px;">
                <p style="text-align: center; color: var(--muted); margin-bottom: 20px;">Googleアカウントでログインしてください。</p>
                <button id="google-login-btn" class="action-button"
                    style="background-color: #4285F4; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20">
                        <path
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                            fill="#4285F4" />
                        <path
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                            fill="#34A853" />
                        <path
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                            fill="#FBBC05" />
                        <path
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                            fill="#EA4335" />
                        <path d="M1 1h22v22H1z" fill="none" />
                    </svg>
                    <span style="color: white;">Googleでログイン</span>
                </button>
                <p id="login-error" style="color: #b91c1c; text-align: center; margin-top: 10px; min-height: 1.2em;">
                </p>
            </div>
        </div>
    </div>


    <div id="app-container" class="container hidden">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 0 4px;">
            <span id="user-email" style="font-size: 0.8rem; color: var(--muted);"></span>
            <button id="logout-btn"
                style="padding: 6px 10px; border-radius: 8px; border: 1px solid var(--line); background: #fff; cursor: pointer;">ログアウト</button>
        </div>


        <div id="shift-screen" class="screen">
            <h1>本日のシフト</h1>
            <div id="shift-list"></div>
            <div id="precautions-section" class="hidden" style="margin-top:8px">
                <h3 style="font-size:1rem;font-weight:600">[サービス提供責任者]</h3>
                <div id="user-instructions-display"
                    style="background:#fff3e0;padding:12px;border-radius:8px;margin-bottom:12px;white-space:pre-wrap;font-size:.95rem;line-height:1.5;">
                </div>
                <button id="start-service-btn" class="action-button">サービス開始</button>
            </div>
        </div>
        <div id="service-exec-screen" class="screen hidden" aria-live="polite">
            <div class="basic-info">
                <div class="info-layout">
                    <div class="name-row">
                        <h2 id="customer-name">—</h2>
                        <span id="service-type" class="pill">—</span>
                    </div>
                    <button class="btn btn-task" id="btn-end">作業終了</button>
                    <div class="times-row">
                        <div class="time-chip"><span class="tag">開始</span><span
                                id="start-plan">--:--</span><span>/</span><span id="start-actual">未実行</span></div>
                        <div class="time-chip"><span class="tag">終了</span><span
                                id="end-plan">--:--</span><span>/</span><span id="end-actual">未実行</span></div>
                    </div>
                    <button class="btn btn-task" id="btn-task-check">指示</button>
                </div>
            </div>
            <div class="tab-container">
                <div class="tab-bar">
                    <button class="tab-btn active" data-tab="body">身体</button>
                    <button class="tab-btn" data-tab="housework">家事</button>
                    <button class="tab-btn" data-tab="required">必須</button>
                    <button class="tab-btn" data-tab="condition">様子</button>
                </div>
                <div class="tab-content-wrapper">
                    <div class="tab-content active" id="tab-body"></div>
                    <div class="tab-content" id="tab-housework"></div>
                    <div class="tab-content" id="tab-required">
                        <div class="checkbox-grid" id="required-grid"></div>
                        <div class="notes-section">
                            <label for="special-notes-new" class="notes-label">特記事項</label>
                            <textarea id="special-notes-new" class="notes-textarea"
                                placeholder="自由記述（例：服薬状況、家族からの伝言、ヒヤリハット等）"></textarea>
                        </div>
                    </div>
                    <div class="tab-content" id="tab-condition"></div>
                </div>
            </div>
        </div>
        <div id="others-screen" class="screen hidden">
            <h2>その他</h2>
            <div style="margin-top:10px;">
                <a href="https://docs.google.com/forms/" target="_blank" class="link-item">有給申請フォーム</a>
                <a href="https://docs.google.com/forms/" target="_blank" class="link-item">ヒヤリハット報告フォーム</a>
            </div>
            <!-- 戻るボタンを削除 -->
        </div>

        <div id="checklist-screen" class="screen hidden">
            <div id="confirmation-screen">
                <h2 style="text-align:center;color:var(--blue);margin-bottom:20px;">作業内容の確認</h2>
                <div id="confirmation-body"></div>
                <div class="confirm-checkbox">
                    <input type="checkbox" id="user-confirmed-checkbox">
                    <label for="user-confirmed-checkbox">利用者様に確認していただきました</label>
                </div>
                <div class="confirm-buttons">
                    <button id="back-to-service" style="background:#90A4AE;color:#fff;">戻る</button>
                    <button id="complete-btn" style="background:#FF9800;color:#fff;">完了</button>
                </div>
            </div>
        </div>
        <div id="summary-screen" class="screen hidden">
            <h2>サービス完了</h2>
            <div style="margin:12px 0">
                <p id="start-time-summary" style="margin:8px 0">サービス開始時刻： --:--</p>
                <p id="end-time-summary" style="margin:8px 0">サービス終了時刻： --:--</p>
                <div id="service-summary"
                    style="margin:12px 0;padding:12px;background:#f9fafb;border-radius:10px;font-size:.95rem;white-space:pre-wrap;">
                </div>
            </div>
            <button id="finish-btn" class="btn" style="width:100%;background:#0288D1">終了</button>
        </div>
        <div id="history-screen" class="screen hidden">
            <h2>サービス履歴</h2>
            <div style="margin:12px 0">
                <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;position:relative;">
                    <input type="text" id="history-customer-search" placeholder="利用者名で検索"
                        style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px">
                    <div id="customer-search-results"
                        style="position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid var(--line); border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 100; display:none;">
                    </div>
                    <input type="date" id="history-date-filter"
                        style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px">
                </div>
                <div id="history-list"></div>
            </div>
        </div>
        <div id="contract-screen" class="screen hidden">
            <h2>利用者情報</h2>
            <div style="margin:12px 0">
                <div style="margin-bottom:12px;padding:12px;background:#f9fafb;border-radius:10px">
                    <h3 id="contract-customer-name" style="margin:0 0 8px;font-size:1.02rem;font-weight:600">—</h3>
                    <div style="font-size:.95rem;color:#4b5563">
                        <p style="margin:4px 0">サービス種別: <span id="contract-service-type">—</span></p>
                    </div>
                </div>

                <!-- 家族を含む環境 -->
                <div class="info-accordion"
                    style="margin-bottom:12px;background:#fff;border:1px solid var(--line);border-radius:10px;overflow:hidden">
                    <button class="accordion-header" data-target="family-env-content"
                        style="width:100%;padding:14px;background:#fff;border:none;text-align:left;font-size:1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <span>家族を含む環境</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div id="family-env-content" class="accordion-content"
                        style="display:none;padding:0 14px 14px;font-size:.95rem;color:#4b5563">
                        <div id="family-env-data">データを読み込み中...</div>
                    </div>
                </div>

                <!-- FIM -->
                <div class="info-accordion"
                    style="margin-bottom:12px;background:#fff;border:1px solid var(--line);border-radius:10px;overflow:hidden">
                    <button class="accordion-header" data-target="fim-content"
                        style="width:100%;padding:14px;background:#fff;border:none;text-align:left;font-size:1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <span>FIM</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div id="fim-content" class="accordion-content"
                        style="display:none;padding:0 14px 14px;font-size:.95rem;color:#4b5563">
                        <div id="fim-data">データを読み込み中...</div>
                    </div>
                </div>

                <!-- ケア手順 -->
                <div class="info-accordion"
                    style="margin-bottom:12px;background:#fff;border:1px solid var(--line);border-radius:10px;overflow:hidden">
                    <button class="accordion-header" data-target="care-procedure-content"
                        style="width:100%;padding:14px;background:#fff;border:none;text-align:left;font-size:1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <span>ケア手順</span>
                        <span class="accordion-icon">▼</span>
                    </button>
                    <div id="care-procedure-content" class="accordion-content"
                        style="display:none;padding:0 14px 14px;font-size:.95rem;color:#4b5563">
                        <div id="care-procedure-data">データを読み込み中...</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="report-screen" class="screen hidden">
            <div id="report-root"></div>
        </div>
        <div id="log-container" class="hidden">
            <h3>記録ログ</h3>
            <div id="log-entries"></div>
        </div>
    </div>


    <div id="shift-screen-bottom-menu" class="menu hidden">
        <div class="inner">
            <div class="bottom-menu-bar">
                <button id="top-page-btn" class="menu-btn">トップ</button>
                <button id="monthly-shift-btn" class="menu-btn">月間シフト</button>
                <button id="others-btn" class="menu-btn">その他</button>
                <button id="shift-report-btn" class="menu-btn">報告<span class="report-badge-exclamation"
                        aria-hidden="true">!</span></button>
            </div>
        </div>
    </div>
    <div id="global-menu" class="menu hidden">
        <div class="inner">
            <div class="dock">
                <div class="dock-item active" id="dock-exec">
                    <div class="dot">実施</div>
                    <div class="dock-name">実施</div>
                </div>
                <div class="dock-item" id="dock-history">
                    <div class="dot">履歴</div>
                    <div class="dock-name">履歴</div>
                </div>
                <div class="dock-item" id="dock-contract">
                    <div class="dot">情報</div>
                    <div class="dock-name">情報</div>
                </div>
                <div class="dock-item" id="dock-report">
                    <div class="dot">報告</div>
                    <div class="dock-name">報告</div>
                    <span class="report-badge-exclamation" aria-hidden="true">!</span>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-task" class="modal" role="dialog" aria-modal="true" aria-label="指示タスク確認"
        style="display:none;position:fixed;inset:0;z-index:1000;justify-content:center;align-items:center;background:rgba(0,0,0,.4);">
        <div class="sheet"
            style="position:relative;width:90%;max-width:500px;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,.3);max-height:80vh;overflow:hidden;display:flex;flex-direction:column;">
            <button class="close" data-close
                style="position:absolute;right:12px;top:10px;background:transparent;border:none;font-size:28px;cursor:pointer;color:#888;z-index:10;">&times;</button>
            <h3 style="margin:0 0 16px;font-size:1.1rem;font-weight:600;color:var(--blue);padding-right:30px;">
                サービス提供責任者からの指示</h3>
            <div class="content" style="flex:1;overflow-y:auto;overflow-x:hidden;">
                <div id="modal-user-instructions"
                    style="background:#fff3e0;padding:16px;border-radius:8px;white-space:pre-wrap;font-size:1rem;line-height:1.6;min-height:100px;border:2px solid #ffedd5;">
                </div>
            </div>
        </div>
    </div>
    <div id="selection-modal" class="modal">
        <div class="backdrop" data-close-modal="selection-modal"></div>
        <div class="sheet">
            <button class="close" data-close-modal="selection-modal">&times;</button>
            <h3 id="modal-title">詳細を選択</h3>
            <div id="modal-options" class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        </div>
    </div>
    <div id="input-modal" class="modal">
        <div class="backdrop" data-close-modal="input-modal"></div>
        <div class="sheet">
            <button class="close" data-close-modal="input-modal">&times;</button>
            <h3 id="input-modal-title">内容を入力</h3>
            <div id="input-modal-form" style="display:flex; flex-direction:column; gap:12px; margin: 16px 0;"></div>
            <div id="input-modal-footer" style="display:flex; gap: 8px; justify-content:flex-end;"></div>
        </div>
    </div>
    <div id="monthly-shift-modal" class="modal">
        <div class="sheet"
            style="position:relative;width:90%;max-width:600px;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,.3);max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
            <button class="close" id="close-monthly-shift"
                style="position:absolute;right:12px;top:10px;background:transparent;border:none;font-size:28px;cursor:pointer;color:#888;z-index:10;">&times;</button>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h3 style="margin:0;font-size:1.2rem;font-weight:600;color:var(--blue);">月間シフト</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button id="prev-month-btn"
                        style="padding:8px 12px;background:var(--blue);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">◀</button>
                    <span id="current-month-display"
                        style="font-size:1rem;font-weight:600;min-width:100px;text-align:center;">-</span>
                    <button id="next-month-btn"
                        style="padding:8px 12px;background:var(--blue);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">▶</button>
                </div>
            </div>
            <div id="monthly-shift-loading" style="text-align:center;padding:40px;color:var(--muted);">読み込み中...</div>
            <div id="monthly-shift-content" class="content"
                style="flex:1;overflow-y:auto;overflow-x:hidden;display:none;">
                <div id="monthly-shift-list"></div>
            </div>
        </div>
    </div>



    <!-- DEMO VERSION: Firebase SDK無効化 - ダミーデータを使用 -->
    <!-- デモバナー -->
    <div
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; text-align: center; font-weight: 600; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;">
        ⚠️ デモ版 - すべてのデータは架空のものです
    </div>
    <style>
        body {
            padding-top: 45px !important;
        }

        #login-container {
            display: none !important;
        }
    </style>

    <script>
        // DEMO VERSION: Mock Firebase - ログインをスキップしてダミーデータを使用
        console.log('[DEMO] Firebase SDKをモックに置換しました');

        // ダミーシフトデータ（本日のシフト）
        const DEMO_SHIFTS = [
            { customerName: '山本 一夫', customerId: 'USR001', startTime: '09:00', endTime: '11:00', serviceType: '身体', date: new Date().toISOString().slice(0, 10), staff: '佐藤 花子' },
            { customerName: '小林 幸子', customerId: 'USR002', startTime: '13:00', endTime: '15:00', serviceType: '家事', date: new Date().toISOString().slice(0, 10), staff: '佐藤 花子' },
            { customerName: '加藤 正男', customerId: 'USR003', startTime: '16:00', endTime: '18:00', serviceType: '身体', date: new Date().toISOString().slice(0, 10), staff: '佐藤 花子' }
        ];

        // Mock firebase auth
        const mockAuth = {
            currentUser: { uid: 'demo-user-001', email: 'demo@example.com' },
            onAuthStateChanged: function (callback) {
                // 即座に認証済みユーザーを返す
                setTimeout(() => callback(mockAuth.currentUser), 100);
                return function () { };
            },
            getRedirectResult: function () { return Promise.resolve({ user: null }); },
            signOut: function () { return Promise.resolve(); },
            signInWithPopup: function () { return Promise.resolve({ user: mockAuth.currentUser }); }
        };

        // Mock firebase firestore
        const mockFirestore = {
            collection: function (name) {
                return {
                    doc: function (id) {
                        return mockFirestore.doc(name + '/' + id);
                    },
                    get: function () {
                        return Promise.resolve({
                            empty: true,
                            docs: [],
                            forEach: function () { }
                        });
                    },
                    where: function () { return this; },
                    limit: function () { return this; }
                };
            },
            doc: function (path) {
                return {
                    get: function () {
                        // allowedEmailsの場合はダミーデータを返す
                        if (path.includes('allowedEmails')) {
                            return Promise.resolve({
                                exists: true,
                                data: function () { return { name: '佐藤 花子' }; }
                            });
                        }
                        return Promise.resolve({
                            exists: false,
                            data: function () { return null; }
                        });
                    },
                    set: function (data) {
                        console.log('[DEMO] Firestore set (無効化):', path, data);
                        return Promise.resolve();
                    },
                    update: function (data) {
                        console.log('[DEMO] Firestore update (無効化):', path, data);
                        return Promise.resolve();
                    },
                    collection: function (subPath) {
                        return mockFirestore.collection(path + '/' + subPath);
                    }
                };
            }
        };

        // Mock firebase realtime database
        const mockRealtimeDB = {
            ref: function (path) {
                return {
                    once: function () { return Promise.resolve({ val: function () { return null; } }); },
                    on: function () { },
                    off: function () { },
                    set: function () { return Promise.resolve(); }
                };
            }
        };

        // Mock firebase global object
        window.firebase = {
            apps: [{}],
            app: function () {
                return { options: { projectId: 'demo-project' } };
            },
            initializeApp: function () { return {}; },
            auth: function () { return mockAuth; },
            firestore: function () { return mockFirestore; },
            database: function () { return mockRealtimeDB; }
        };
        firebase.auth.GoogleAuthProvider = function () { };

        // 初期化
        const auth = mockAuth;
        const db = mockFirestore;
        const realtimeDB = mockRealtimeDB;
    </script>

    <script>
        // DOMコンテンツ読み込み後にデモモードを初期化
        document.addEventListener('DOMContentLoaded', function () {
            // ログイン画面を非表示、アプリコンテナを表示
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const userEmailDisplay = document.getElementById('user-email');

            if (loginContainer) loginContainer.classList.add('hidden');
            if (appContainer) appContainer.classList.remove('hidden');
            if (userEmailDisplay) userEmailDisplay.textContent = 'demo@example.com';

            // ダミーシフトを表示
            const shiftList = document.getElementById('shift-list');
            if (shiftList) {
                let shiftsHtml = '';
                DEMO_SHIFTS.forEach(shift => {
                    shiftsHtml += `
                    <div class="shift-item"
                         data-service="${shift.serviceType}"
                         data-name="${shift.customerName}"
                         data-customer-id="${shift.customerId}"
                         data-time="${shift.startTime} - ${shift.endTime}"
                         data-staff="${shift.staff}"
                         data-date="${shift.date}">
                        <span class="name">${shift.customerName}</span>
                        <span class="time">${shift.startTime} - ${shift.endTime}</span>
                        <span class="type" style="background-color:${shift.serviceType === '身体' ? '#03A9F4' : '#FF9800'}">${shift.serviceType}</span>
                    </div>`;
                });
                shiftList.innerHTML = shiftsHtml;
            }

            console.log('[DEMO] サービス報告画面を初期化しました');
        });

        // 認証状態監視をオーバーライド（元のコードが実行されても問題ないように）
        const originalOnAuthStateChanged = auth.onAuthStateChanged;
    </script>

    <script>
        // 以下のコードは元のまま維持（auth変数は上で定義済み）
        const googleProvider = { providerId: 'google.com' };
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const userEmailDisplay = document.getElementById('user-email');
        const shiftList = document.getElementById('shift-list');


        // auth.onAuthStateChanged は上のモックで処理済み


        async function checkAuthorization(user) {
            const project = (firebase.app().options && firebase.app().options.projectId) || 'unknown-project';
            const email = (user.email || '').trim();
            const emailPath = `allowedEmails/${email}`;
            console.log('[auth] projectId=', project, 'email=', email);
            // 1) メール許可リスト
            try {
                console.log('[auth] checking', emailPath);
                const emailDoc = await db.doc(emailPath).get();
                console.log('[auth] result', emailPath, 'exists=', emailDoc.exists);
                if (emailDoc.exists) return true;
            } catch (e) {
                console.error('[auth] allowedEmails get error', emailPath, e && (e.code || e.message || e));
            }
            // 2) 互換: uid ベース
            const uidPath = `authorizedUsers/${user.uid}`;
            try {
                console.log('[auth] checking', uidPath);
                const uidDoc = await db.doc(uidPath).get();
                console.log('[auth] result', uidPath, 'exists=', uidDoc.exists);
                if (uidDoc.exists) return true;
            } catch (e) {
                console.error('[auth] authorizedUsers get error', uidPath, e && (e.code || e.message || e));
            }
            return false;
        }


        googleLoginBtn.addEventListener('click', async () => {
            console.log('Googleログインボタンがクリックされました');
            loginError.textContent = '';
            try {
                console.log('signInWithPopup を開始します...');
                const result = await auth.signInWithPopup(googleProvider);
                console.log('ログイン成功:', result.user.email);
            } catch (error) {
                console.error('Googleログインエラー:', error);
                console.error('エラーコード:', error.code);
                console.error('エラーメッセージ:', error.message);
                if (error.code === 'auth/popup-closed-by-user') {
                    loginError.textContent = 'ログインがキャンセルされました。';
                } else if (error.code === 'auth/popup-blocked') {
                    loginError.textContent = 'ポップアップがブロックされました。ブラウザの設定を確認してください。';
                } else {
                    loginError.textContent = 'ログインに失敗しました: ' + (error.message || error.code);
                }
            }
        });
        console.log('Googleログインボタンのイベントリスナーを設定しました');


        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });


        // 完了済みシフトをチェックする関数
        async function checkIfShiftCompleted(shift) {
            try {
                // date と customerName で検索し、クライアント側でさらにフィルタリング
                const querySnapshot = await db.collection('serviceRecords')
                    .where('date', '==', shift.date)
                    .where('customerName', '==', shift.customerName)
                    .get();

                // サービス種別、開始時刻、終了時刻が一致するものを検索
                for (const doc of querySnapshot.docs) {
                    const record = doc.data();
                    if (record.serviceType === shift.serviceType &&
                        record.startPlan === shift.startTime &&
                        record.endPlan === shift.endTime) {
                        return true;
                    }
                }

                return false;
            } catch (error) {
                console.error('[checkIfShiftCompleted] エラー:', error);
                return false;
            }
        }

        async function fetchAndDisplayShifts(uid) {
            shiftList.innerHTML = '<p style="text-align:center;color:var(--muted);">シフトを読み込み中...</p>';
            const today = new Date().toISOString().slice(0, 10);
            const userEmail = auth.currentUser ? auth.currentUser.email : '';
            console.log('[fetchShifts] uid=', uid, 'email=', userEmail, 'today=', today);

            try {
                // ログインユーザーの担当者名を取得
                let staffName = null;
                try {
                    console.log('[fetchShifts] allowedEmails取得開始:', userEmail);
                    const allowedEmailDoc = await db.collection('allowedEmails').doc(userEmail).get();
                    console.log('[fetchShifts] allowedEmailDoc.exists=', allowedEmailDoc.exists);
                    if (allowedEmailDoc.exists) {
                        const data = allowedEmailDoc.data();
                        staffName = data.name; // Use 'name' field
                        console.log('[fetchShifts] allowedEmailsから取得したデータ:', data);
                        console.log('[fetchShifts] staffName=', staffName);
                    } else {
                        console.warn('[fetchShifts] allowedEmailsに登録されていません:', userEmail);
                    }
                } catch (error) {
                    console.error('[fetchShifts] allowedEmailsの取得エラー:', error);
                }

                if (!staffName) {
                    shiftList.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px 0;">担当者情報が見つかりません。</p>';
                    initShift();
                    return;
                }

                // magnet_placementsから取得（月間シフトアプリのデータのみ使用）
                const uniqueShifts = [];
                const MAGNET_PLACEMENTS = 'magnet_placements'; // アンダースコア形式に修正

                // 日付フォーマット: YYYY-MM-DD から YYYY-MM と DD を抽出
                const yearMonth = today.substring(0, 7); // YYYY-MM (例: 2024-11)
                const dayStr = today.substring(8, 10); // DD (例: 12)

                console.log('[fetchShifts] ===== シフト取得開始 =====');
                console.log('[fetchShifts] 今日の日付（生データ）:', today);
                console.log('[fetchShifts] 抽出された yearMonth:', yearMonth);
                console.log('[fetchShifts] 抽出された dayStr:', dayStr);
                console.log('[fetchShifts] 検索条件:', {
                    today,
                    yearMonth,
                    dayStr,
                    staffName,
                    path: `${MAGNET_PLACEMENTS}/${yearMonth}/days/${dayStr}`
                });

                // デバッグ: 利用可能なすべてのmagnetPlacementsドキュメントを列挙
                console.log('[fetchShifts] magnetPlacementsコレクション全体を確認中...');
                const allMagnetDocs = await db.collection(MAGNET_PLACEMENTS).limit(10).get();
                console.log('[fetchShifts] magnetPlacementsドキュメント数:', allMagnetDocs.size);
                allMagnetDocs.forEach(doc => {
                    console.log('[fetchShifts] 利用可能なドキュメントID:', doc.id);
                });

                // 月間シフト表示と同じアプローチ: daysサブコレクション全体を取得
                const daysCollectionRef = db.collection(MAGNET_PLACEMENTS).doc(yearMonth).collection('days');
                const daysSnapshot = await daysCollectionRef.get();

                console.log('[fetchShifts] daysサブコレクション内のドキュメント数:', daysSnapshot.size);

                if (daysSnapshot.empty) {
                    console.log('[fetchShifts] daysサブコレクションが空です');
                }

                // 各dayドキュメントを確認
                daysSnapshot.forEach((dayDoc) => {
                    console.log('[fetchShifts] dayDoc.id:', dayDoc.id);
                    const data = dayDoc.data();
                    console.log('[fetchShifts] dayDoc data:', data);

                    if (data.placements && Array.isArray(data.placements)) {
                        console.log('[fetchShifts] placements配列の長さ:', data.placements.length);

                        data.placements.forEach((placement, index) => {
                            console.log(`[fetchShifts] placement[${index}]:`, placement);

                            // 担当者と日付が一致するシフトのみ取得
                            const placementStaff = placement.staff || placement.staffName;
                            const placementDate = placement.date;

                            console.log(`[fetchShifts] 比較:`, {
                                placementStaff,
                                staffName,
                                placementDate,
                                today,
                                '担当者一致': placementStaff === staffName,
                                '日付一致': placementDate === today
                            });

                            // 担当者と日付が一致する場合のみ追加
                            if (placementStaff === staffName && placementDate === today) {
                                // 時間の処理: timeフィールドが "HH:MM-HH:MM" 形式の場合は分割
                                let startTime, endTime;
                                if (placement.time && placement.time.includes('-')) {
                                    const timeParts = placement.time.split('-');
                                    startTime = timeParts[0].trim();
                                    endTime = timeParts[1].trim();
                                } else {
                                    startTime = placement.startTime || '--:--';
                                    endTime = placement.endTime || '--:--';
                                }

                                const shift = {
                                    customerName: placement.userName || placement.customerName,
                                    customerId: placement.userId || '', // ユーザーIDを追加
                                    startTime: startTime,
                                    endTime: endTime,
                                    serviceType: placement.serviceType || '身体',
                                    date: today,
                                    staff: placementStaff
                                };
                                console.log('[fetchShifts] シフト追加:', shift);
                                uniqueShifts.push(shift);
                            }
                        });
                    } else {
                        console.log('[fetchShifts] placementsが配列ではないか、存在しません');
                    }
                });

                console.log('[fetchShifts] フィルタ後のシフト数:', uniqueShifts.length);
                console.log('[fetchShifts] ===== シフト取得終了 =====');

                if (uniqueShifts.length === 0) {
                    shiftList.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px 0;">本日のシフトはありません。</p>';
                    initShift();
                    return;
                }

                // 開始時刻でソート
                uniqueShifts.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));

                // グローバル変数に保存（連続サービス検知用）
                shiftsData = uniqueShifts;

                // 各シフトの完了状態をチェック
                let shiftsHtml = '';
                for (const shift of uniqueShifts) {
                    const displayName = shift.customerName || '不明';
                    const serviceType = shift.serviceType || '身体';
                    const staffNameDisplay = shift.staff || staffName || '不明';
                    const dateStr = shift.date || today;

                    // 完了済みかチェック
                    const isCompleted = await checkIfShiftCompleted(shift);
                    const completedClass = isCompleted ? ' completed' : '';
                    const completedAttr = isCompleted ? ' data-completed="true"' : '';

                    shiftsHtml += `
                    <div class="shift-item${completedClass}"
                         data-service="${serviceType}"
                         data-name="${displayName}"
                         data-customer-id="${shift.customerId || ''}"
                         data-time="${shift.startTime} - ${shift.endTime}"
                         data-staff="${staffNameDisplay}"
                         data-date="${dateStr}"${completedAttr}>
                        <span class="name">${displayName}</span>
                        <span class="time">${shift.startTime} - ${shift.endTime}</span>
                        <span class="type" style="background-color:${serviceType === '身体' ? '#03A9F4' : '#FF9800'}">${serviceType}</span>
                    </div>`;
                }
                shiftList.innerHTML = shiftsHtml;
                initShift();
            } catch (error) {
                console.error("シフト取得エラー:", error);
                console.error("エラーコード:", error.code);
                console.error("エラーメッセージ:", error.message);
                let errorMsg = 'シフトの読み込みに失敗しました。';
                if (error.code === 'permission-denied') {
                    errorMsg += '<br><small>権限エラー: Firestoreのセキュリティルールを確認してください。</small>';
                } else if (error.code === 'failed-precondition') {
                    errorMsg += '<br><small>インデックスエラーが解決されました（再試行してください）</small>';
                } else if (error.message) {
                    errorMsg += `<br><small>詳細: ${error.message}</small>`;
                }
                shiftList.innerHTML = `<p style="text-align:center;color:#b91c1c;">${errorMsg}</p>`;
            }
        }
        let selectedShiftInfo = null;
        let shiftsData = []; // 全シフトデータを保存
        const recordState = { detailSelections: new Map(), vitalData: new Map(), specialNotes: '' };
        let userCheckedItems = []; // 週間ケアプランから読み込んだチェック項目
        let userInstructions = ''; // 週間ケアプランから読み込んだ指示内容

        // デフォルトのカテゴリー定義（利用者のチェック項目がない場合のフォールバック）
        const defaultMainCategories = ['身体', '家事', '必須'];
        const defaultCategoryDetails = {
            '身体': [
                'トイレ介助', 'Pトイレ介助', '尿器介助', 'オムツ介助', 'パッド交換',
                '食事介助（全）', '食事介助（一部）', '水分補給', '服薬介助・確認', '全身清拭', '部分清拭',
                '洗髪', '洗面', '整容', '部分浴', '陰部・腎部洗浄', '入浴介助', 'シャワー浴', '口腔ケア',
                '更衣介助', '体位変換', '移動・移乗介助', '起床介助', '就寝介助', '軟膏',
                '通院・外出介助', '共に行う支援', '見守り的援助', '迎え入れ介助'
            ],
            '家事': [
                '清掃', '調理', '配下膳', '後片付け', '洗濯', 'ベッドメーキング', '衣類整理', '買物', '薬の受取'
            ],
            '必須': [
                '健康チェック', '環境整備', '相談援助', '情報収集・提供', '記録', '安否確認', '育児支援',
                '本日提供したサービス内容について、利用者ご本人またはご家族に説明を行い、了承を得ました。'
            ]
        };

        // 長い項目（全幅表示が必要な項目）- 本当に長い項目のみ
        const longItems = [
            '本日提供したサービス内容について、利用者ご本人またはご家族に説明を行い、了承を得ました。'
        ];

        // 動的に生成されるカテゴリー（週間ケアプランから読み込み）
        let mainCategories = defaultMainCategories;
        let categoryDetails = defaultCategoryDetails;

        const subCategoryDetails = { '顔色': ['良', '不良'], '発汗': ['有', '無'], '排泄': ['服薬確認', 'トイレ介助', 'Pトイレ介助', 'おむつ交換', 'パッド交換', '汚れた衣服やリネン等の交換処理', '陰部・臀部の清拭・洗浄', '排尿・尿処理（　）回　（　）㏄', '排便　回（性状　　）'], '食事': ['姿勢の確保', 'メニュー・材料の説明', '摂食介助', '食事量・完食・残量（ / )', '水分補給（　）㏄', '献立'], '清拭・入浴': ['清拭', '部分浴', '洗髪'], '身体整容': ['全身浴', '洗面', '口腔ケア', '整容', '更衣介助', '機器介助'], '移動': ['体位変換', '移乗介助', '移動介助', '歩行介助', '外出準備介助', '帰宅受入介助', '通院介助', '買物介助'], '起床就寝': ['起床介助', '就寝介助'], '清掃': ['居室・トイレ・卓上・台所・浴室・Pトイレ・洗面所・廊下・寝室', '環境整備', 'ゴミ出し'], '洗濯': ['洗濯', '乾燥（物干し）', '取入れ・収納'], 'ベッドメイク': ['シーツ交換', '整理・整頓'], '衣類・寝具': ['衣類の整理', '布団干し'], '調理': ['調理', '配・下膳', '献立'], '買物等': ['日常品等の買物', '薬の受取り'], '服薬': ['服薬解除・確認・補充', '薬の塗布', '点眼'], '医療行為': ['痰の吸引', '浣腸', '医療行為の準備・後片付け'] };
        const thirdLevelDetails = { '清拭': ['全身', '部分'], '部分浴': ['手', '足'], '全身浴': ['入浴', 'シャワー浴'], '整容': ['爪', '耳', '髭', '髪', '化粧'] };
        const itemsNeedingInput = ['排尿・尿処理（　）回　（　）㏄', '排便　回（性状　　）', '食事量・完食・残量（ / )', '水分補給（　）㏄'];


        // Firebaseから利用者のチェック項目を読み込む関数
        async function loadUserCheckItems(userName, userId = null) {
            try {
                console.log('[loadCheckItems] 利用者名:', userName, 'ユーザーID:', userId);

                let userDoc = null;
                let userData = null;

                // userIdが指定されている場合は直接取得
                if (userId) {
                    console.log('[loadCheckItems] userIdで直接検索:', userId);
                    const userDocRef = db.collection('riyousya').doc(userId);
                    const docSnap = await userDocRef.get();
                    if (docSnap.exists) {
                        userDoc = docSnap;
                        userData = docSnap.data();
                        console.log('[loadCheckItems] ユーザードキュメント取得成功');
                    }
                }

                // userIdで見つからない場合は名前で検索
                if (!userData) {
                    console.log('[loadCheckItems] 名前で検索:', userName);

                    // 名前を正規化する関数（全角スペースと半角スペースを統一）
                    const normalizeName = (name) => {
                        if (!name) return '';
                        return name.replace(/\u3000/g, ' ').replace(/\s+/g, ' ').trim();
                    };

                    const normalizedSearchName = normalizeName(userName);
                    console.log('[loadCheckItems] 正規化された検索名:', normalizedSearchName);

                    // まず完全一致で検索
                    const usersRef = db.collection('riyousya');
                    let querySnapshot = await usersRef.where('name', '==', userName).get();

                    if (querySnapshot.empty) {
                        console.log('[loadCheckItems] 完全一致で見つからず、全ドキュメントから検索');
                        // 完全一致で見つからない場合、全ドキュメントを取得して正規化した名前で比較
                        const allDocsSnapshot = await usersRef.get();

                        for (const doc of allDocsSnapshot.docs) {
                            const docData = doc.data();
                            const docName = normalizeName(docData.name);
                            console.log('[loadCheckItems] 比較: "' + docName + '" vs "' + normalizedSearchName + '"');

                            if (docName === normalizedSearchName) {
                                console.log('[loadCheckItems] 正規化名で一致! ドキュメントID:', doc.id);
                                userDoc = doc;
                                userData = docData;
                                break;
                            }
                        }
                    } else {
                        userDoc = querySnapshot.docs[0];
                        userData = userDoc.data();
                    }

                    if (!userData) {
                        console.warn('[loadCheckItems] 利用者が見つかりません:', userName);
                        // デフォルトのカテゴリーを使用
                        mainCategories = defaultMainCategories;
                        categoryDetails = defaultCategoryDetails;
                        return;
                    }
                }

                const foundUserId = userDoc.id || userId;
                console.log('[loadCheckItems] ユーザーID:', foundUserId);

                // carePlanが存在するか確認
                if (!userData.carePlan || !userData.carePlan.services) {
                    console.warn('[loadCheckItems] carePlanが見つかりません');
                    // デフォルトのカテゴリーを使用
                    mainCategories = defaultMainCategories;
                    categoryDetails = defaultCategoryDetails;
                    return;
                }

                // 全サービスのcheckItemsを統合
                const allCheckItems = [];
                userData.carePlan.services.forEach(service => {
                    if (service.checkItems && Array.isArray(service.checkItems)) {
                        allCheckItems.push(...service.checkItems);
                    }
                });

                console.log('[loadCheckItems] チェック項目:', allCheckItems);

                // グローバル変数に保存（重複を除去）
                userCheckedItems = [...new Set(allCheckItems)];
                console.log('[loadCheckItems] 保存されたチェック項目:', userCheckedItems);

                // 指示内容を読み込む（サービス開始時用）
                userInstructions = userData.carePlan.instructions || '';
                console.log('[loadCheckItems] 指示内容:', userInstructions);

                // モーダルの指示内容を更新
                const modalInstructions = document.getElementById('modal-user-instructions');
                if (modalInstructions) {
                    modalInstructions.textContent = userInstructions || '指示はありません';
                }

                if (allCheckItems.length === 0) {
                    console.warn('[loadCheckItems] チェック項目がありません');
                    // デフォルトのカテゴリーを使用
                    mainCategories = defaultMainCategories;
                    categoryDetails = defaultCategoryDetails;
                    return;
                }

                // 週間ケアプランからのチェック項目は userCheckedItems に保存済み
                // カテゴリー構造はデフォルトを維持（動的に置き換えない）
                // これにより、全てのタブに項目が表示され、週間ケアプランで設定した項目は事前にチェックされる

                console.log('[loadCheckItems] 完了 - userCheckedItems:', userCheckedItems.length, '件');

            } catch (error) {
                console.error('[loadCheckItems] エラー:', error);
                // エラー時はデフォルトのカテゴリーを使用
                mainCategories = defaultMainCategories;
                categoryDetails = defaultCategoryDetails;
            }
        }

        function showScreen(name) {
            ['shift', 'service-exec', 'checklist', 'summary', 'history', 'contract', 'others', 'salary', 'report'].forEach(k => {
                const el = document.getElementById(k + '-screen'); if (el) el.classList.add('hidden');
            });
            const screenToShow = document.getElementById(name + '-screen');
            if (screenToShow) screenToShow.classList.remove('hidden');

            const globalMenu = document.getElementById('global-menu');
            const shiftMenu = document.getElementById('shift-screen-bottom-menu');
            if (name === 'shift') {
                if (shiftMenu) shiftMenu.classList.remove('hidden');
                if (globalMenu) globalMenu.classList.add('hidden');
                // シフト画面に戻った時、シフトデータを再取得
                if (auth.currentUser) {
                    console.log('[showScreen] シフト画面表示 - データを再取得します');
                    fetchAndDisplayShifts(auth.currentUser.uid);
                }
            } else if (['service-exec', 'history', 'contract', 'report'].includes(name)) {
                if (shiftMenu) shiftMenu.classList.add('hidden');
                if (globalMenu) globalMenu.classList.remove('hidden');
            } else if (name === 'others') {
                // その他画面ではシフトメニューを維持
                if (shiftMenu) shiftMenu.classList.remove('hidden');
                if (globalMenu) globalMenu.classList.add('hidden');
            } else {
                if (shiftMenu) shiftMenu.classList.add('hidden');
                if (globalMenu) globalMenu.classList.add('hidden');
            }
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            if (name === 'service-exec') document.getElementById('dock-exec')?.classList.add('active');
            if (name === 'history') document.getElementById('dock-history')?.classList.add('active');
            if (name === 'report') document.getElementById('dock-report')?.classList.add('active');

            // 画面遷移時にバッジ状態を更新
            if (typeof updateReportBadge === 'function') {
                updateReportBadge();
            }
        }

        // 報告バッジの表示/非表示を切り替える
        function updateReportBadge() {
            const hasDraft = localStorage.getItem('reportDraftInProgress') === '1';
            document.querySelectorAll('.report-badge-exclamation').forEach(el => {
                el.style.display = hasDraft ? 'flex' : 'none';
            });
        }

        // 初期表示時にバッジを更新
        updateReportBadge();

        // 別タブからのlocalStorage変更を同期
        window.addEventListener('storage', (e) => {
            if (e.key === 'reportDraftInProgress') updateReportBadge();
        });

        // iframeや別コンポーネントからの通知を同期
        window.addEventListener('message', (e) => {
            if (e && e.data && e.data.type === 'REPORT_DRAFT_FLAG_CHANGED') {
                updateReportBadge();
            }
        });

        window.addEventListener('REPORT_DRAFT_FLAG_CHANGED', () => {
            updateReportBadge();
        });

        // 連続サービスを検知する関数
        function checkContinuousService() {
            if (!selectedShiftInfo || !shiftsData || shiftsData.length === 0) {
                console.log('[checkContinuousService] データなし');
                return null;
            }

            console.log('[checkContinuousService] selectedShiftInfo:', selectedShiftInfo);
            console.log('[checkContinuousService] shiftsData:', shiftsData);

            // 現在のサービスの終了時刻を取得
            const currentEndTime = selectedShiftInfo.time.split(' - ')[1];
            const currentCustomerName = selectedShiftInfo.name;

            console.log('[checkContinuousService] 現在の終了時刻:', currentEndTime);
            console.log('[checkContinuousService] 現在の利用者名:', currentCustomerName);

            // 同じ利用者に対する次のサービスを探す
            // 条件：利用者名が同じ && 次のサービスの開始時刻が現在の終了時刻と一致
            const nextService = shiftsData.find(shift => {
                const shiftCustomerName = shift.customerName || '不明';
                const shiftStartTime = shift.startTime;

                console.log('[checkContinuousService] チェック中:', {
                    shiftCustomerName,
                    shiftStartTime,
                    '利用者一致': shiftCustomerName === currentCustomerName,
                    '時刻一致': shiftStartTime === currentEndTime
                });

                return shiftCustomerName === currentCustomerName && shiftStartTime === currentEndTime;
            });

            if (nextService) {
                console.log('[checkContinuousService] 連続サービス検出:', nextService);
            } else {
                console.log('[checkContinuousService] 連続サービスなし');
            }

            return nextService;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initService(); initChecklist(); initSummary(); initHistory(); initMenu(); initModals(); initShiftScreenMenu();
        });


        function initShiftScreenMenu() {
            document.getElementById('top-page-btn')?.addEventListener('click', () => showScreen('shift'));
            document.getElementById('monthly-shift-btn').addEventListener('click', () => openModal('monthly-shift-modal'));
            document.getElementById('others-btn').addEventListener('click', () => showScreen('others'));
            const reportBtn = document.getElementById('shift-report-btn');
            if (reportBtn) {
                reportBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[本日のシフト] 報告ボタンがクリックされました - report画面を開きます（フッター維持）');
                    showReportFromShift();
                });
            }
        }
        function calculateAndDisplaySalary() {
            const hourlyRate = 1500, hoursWorkedToday = 5, estimatedMonthlyHours = 120;
            const provisional = hoursWorkedToday * hourlyRate;
            const estimated = estimatedMonthlyHours * hourlyRate;
            document.getElementById('provisional-salary').textContent = `¥${provisional.toLocaleString()}`;
            document.getElementById('estimated-salary').textContent = `¥${estimated.toLocaleString()}`;
        }


        // 指示内容のみを読み込む関数（シフト選択時用）
        async function loadUserInstructions(userName) {
            try {
                console.log('[loadInstructions] 利用者名:', userName);

                // riyousya直下から検索
                const usersRef = db.collection('riyousya');
                const querySnapshot = await usersRef.where('name', '==', userName).get();

                if (querySnapshot.empty) {
                    console.warn('[loadInstructions] 利用者が見つかりません');
                    userInstructions = '';
                } else {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();

                    if (userData.carePlan && userData.carePlan.instructions) {
                        userInstructions = userData.carePlan.instructions;
                    } else {
                        userInstructions = '';
                    }
                }

                // 指示内容を表示
                const instructionsDisplay = document.getElementById('user-instructions-display');
                const modalInstructions = document.getElementById('modal-user-instructions');
                if (instructionsDisplay) {
                    instructionsDisplay.textContent = userInstructions || '指示はありません';
                }
                if (modalInstructions) {
                    modalInstructions.textContent = userInstructions || '指示はありません';
                }

                console.log('[loadInstructions] 指示内容:', userInstructions);
            } catch (error) {
                console.error('[loadInstructions] エラー:', error);
                userInstructions = '';
            }
        }

        function initShift() {
            const items = document.querySelectorAll('.shift-item');
            const startBtn = document.getElementById('start-service-btn');
            items.forEach(item => {
                item.addEventListener('click', async function () {
                    // 完了済みシフトの場合は警告を表示して処理を中断
                    if (this.dataset.completed === 'true') {
                        alert('すでに完了したサービスです。');
                        return;
                    }

                    items.forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedShiftInfo = {
                        service: this.dataset.service,
                        name: this.dataset.name,
                        customerId: this.dataset.customerId || '', // ユーザーIDを追加
                        time: this.dataset.time,
                        staff: this.dataset.staff,
                        date: this.dataset.date
                    };

                    // シフト選択時に指示を読み込む
                    console.log('[Debug] Loading instructions...');
                    try {
                        await loadUserInstructions(this.dataset.name);
                        console.log('[Debug] Instructions loaded.');
                    } catch (e) {
                        console.error('[Debug] loadUserInstructions failed:', e);
                    }

                    // 自動的にサービス開始ボタンの処理を実行（遷移）
                    console.log('[Debug] Triggering startBtn click...');
                    if (startBtn) {
                        // verify button exists
                        console.log('[Debug] startBtn found, clicking. Hidden?', startBtn.offsetParent === null);
                        startBtn.click();
                    } else {
                        console.error('[Debug] startBtn NOT found');
                    }
                }, { passive: true });
            });

            console.log('[Debug] initShift: Listeners attached to ' + items.length + ' items.');

            if (startBtn && !startBtn.dataset.listenerAttached) {
                console.log('[Debug] Attaching listener to startBtn');
                startBtn.addEventListener('click', async () => {
                    console.log('[Debug] startBtn clicked!');
                    if (!selectedShiftInfo) {
                        console.error('[Debug] No selectedShiftInfo');
                        return;
                    }

                    // ... existing logic ...

                    // 選択されたシフトアイテムが完了済みかチェック
                    const selectedItem = document.querySelector('.shift-item.selected');
                    if (selectedItem && selectedItem.dataset.completed === 'true') {
                        alert('すでに完了したサービスです。');
                        return;
                    }

                    // 利用者のチェック項目を読み込む（userIdがあれば直接検索）
                    await loadUserCheckItems(selectedShiftInfo.name, selectedShiftInfo.customerId);

                    const [st, et] = selectedShiftInfo.time.split(' - ');
                    setText('customer-name', selectedShiftInfo.name);
                    setText('service-type', selectedShiftInfo.service);
                    setText('start-plan', st || '--:--'); setText('end-plan', et || '--:--');
                    const t = new Date(); setText('start-actual', formatHM(t)); logStamp('サービス開始', t);
                    setText('contract-customer-name', selectedShiftInfo.name);
                    setText('contract-service-type', (selectedShiftInfo.service === '身体') ? '身体介護' : '生活援助');
                    showScreen('service-exec');

                    // サービス記録を再レンダリング
                    initService();
                });
                startBtn.dataset.listenerAttached = 'true';
            }
        }
        // 新しいタブベースのサービス記録システム
        const newRecordState = {
            body: new Set(),
            housework: new Set(),
            required: new Set(),
            condition: new Set(),
            vital: { temperature: '', systolic: '', diastolic: '' },
            notes: ''
        };

        function validateSelections() { return true; }
        function initService() {
            setupTabs();
            setupTabSwipe();
            renderAllTabs();
            // 特記事項のイベント（新しいID）
            const specialNotesNew = document.getElementById('special-notes-new');
            if (specialNotesNew && !specialNotesNew.dataset.listenerAttached) {
                specialNotesNew.addEventListener('input', e => {
                    newRecordState.notes = e.target.value;
                });
                specialNotesNew.dataset.listenerAttached = 'true';
            }

            const btnTaskCheck = document.getElementById('btn-task-check');
            if (btnTaskCheck && !btnTaskCheck.dataset.listenerAttached) {
                btnTaskCheck.addEventListener('click', () => openModal('modal-task'));
                btnTaskCheck.dataset.listenerAttached = 'true';
            }

            const btnEnd = document.getElementById('btn-end');
            if (btnEnd && !btnEnd.dataset.listenerAttached) {
                btnEnd.addEventListener('click', async () => {
                    if (!validateSelections()) return;
                    const t = new Date(); setText('end-actual', formatHM(t)); logStamp('サービス終了', t);

                    // 連続サービスをチェック
                    const nextService = checkContinuousService();
                    if (nextService) {
                        // 連続サービスがある場合、確認ポップアップを表示
                        const nextServiceType = nextService.serviceType || '身体';
                        const nextTime = `${nextService.startTime} - ${nextService.endTime}`;
                        if (confirm(`連続サービスです。
次のサービス（${nextServiceType}：${nextTime}）を続けて行いますか？`)) {
                            // 「はい」の場合、次のサービスを開始
                            // まず現在のサービスを保存
                            try {
                                await saveServiceRecord();
                                alert('現在のサービス記録を保存しました');
                            } catch (error) {
                                console.error('保存エラー:', error);
                                alert('保存に失敗しました: ' + error.message);
                                return;
                            }

                            // 次のサービスの情報をselectedShiftInfoに設定
                            const displayName = nextService.customerName || nextService.staff || '不明';
                            const staffName = nextService.staff || '不明';
                            const dateStr = nextService.date || new Date().toISOString().split('T')[0];
                            selectedShiftInfo = {
                                service: nextServiceType,
                                name: displayName,
                                time: nextTime,
                                staff: staffName,
                                date: dateStr
                            };
                            // サービス実施画面をリセットして新しいサービスを開始
                            resetServiceScreen();
                            const startTime = new Date();
                            setText('start-actual', formatHM(startTime));
                            logStamp('サービス開始', startTime);
                            setText('contract-customer-name', displayName);
                            setText('contract-service-type', (nextServiceType === '身体') ? '身体介護' : '生活援助');
                            showScreen('service-exec');
                            initService();
                            return;
                        }
                    }

                    // 連続サービスがない場合、または「いいえ」の場合は確認画面へ
                    buildNewConfirmation(); showScreen('checklist');
                });
                btnEnd.dataset.listenerAttached = 'true';
            }
        }

        // タブ切り替え機能
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;

                    // タブボタンの切り替え
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // タブコンテンツの切り替え
                    tabContents.forEach(content => {
                        if (content.id === `tab-${targetTab}`) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });
        }

        // スワイプ機能（改善版：スクロールと競合しない）
        function setupTabSwipe() {
            const wrapper = document.querySelector('.tab-content-wrapper');
            if (!wrapper) return;

            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;
            let isSwiping = false;

            wrapper.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isSwiping = false;
            }, { passive: true });

            wrapper.addEventListener('touchmove', e => {
                if (!isSwiping) {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;

                    const diffX = Math.abs(currentX - startX);
                    const diffY = Math.abs(currentY - startY);

                    // 横方向の動きが縦方向より大きければスワイプと判定
                    if (diffX > diffY && diffX > 10) {
                        isSwiping = true;
                    }
                }
            }, { passive: true });

            wrapper.addEventListener('touchend', () => {
                if (isSwiping) {
                    const diff = startX - currentX;
                    if (Math.abs(diff) > 60) { // しきい値を60pxに増加
                        const activeBtn = document.querySelector('.tab-btn.active');
                        const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
                        const currentIndex = tabBtns.indexOf(activeBtn);

                        if (diff > 0 && currentIndex < tabBtns.length - 1) {
                            // 左スワイプ→次のタブ
                            tabBtns[currentIndex + 1].click();
                        } else if (diff < 0 && currentIndex > 0) {
                            // 右スワイプ→前のタブ
                            tabBtns[currentIndex - 1].click();
                        }
                    }
                }
                isSwiping = false;
            }, { passive: true });
        }

        // 全タブのコンテンツをレンダリング
        function renderAllTabs() {
            renderBodyTab();
            renderHouseworkTab();
            renderRequiredTab();
            renderConditionTab();
            // チェックボックスのクリックイベントを設定
            setupCheckboxListeners();
            // 週間ケアプランのチェック項目を初期状態に設定
            applyPreCheckedItems();
        }

        // チェックボックスのクリックイベントハンドラを設定
        function setupCheckboxListeners() {
            document.querySelectorAll('.checkbox-item').forEach(item => {
                if (item.dataset.listenerAttached) return;
                item.addEventListener('click', function (e) {
                    // 直接inputをクリックした場合は何もしない（pointer-events: noneなので通常発生しない）
                    if (e.target.tagName === 'INPUT') return;

                    const checkbox = this.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        this.classList.toggle('checked', checkbox.checked);

                        // 状態をnewRecordStateに保存
                        const category = checkbox.dataset.category;
                        const value = checkbox.value;
                        if (category && newRecordState[category]) {
                            if (checkbox.checked) {
                                newRecordState[category].add(value);
                            } else {
                                newRecordState[category].delete(value);
                            }
                        }
                        console.log('[checkbox] ' + category + ': ' + value + ' = ' + checkbox.checked);
                    }
                });
                item.dataset.listenerAttached = 'true';
            });
        }

        // 週間ケアプランで設定されたチェック項目を初期状態に反映
        function applyPreCheckedItems() {
            if (!userCheckedItems || userCheckedItems.length === 0) {
                console.log('[applyPreCheckedItems] 事前チェック項目なし');
                return;
            }
            console.log('[applyPreCheckedItems] 事前チェック項目を適用:', userCheckedItems);

            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(checkbox => {
                if (userCheckedItems.includes(checkbox.value)) {
                    checkbox.checked = true;
                    checkbox.closest('.checkbox-item').classList.add('checked');

                    // 状態をnewRecordStateにも保存
                    const category = checkbox.dataset.category;
                    if (category && newRecordState[category]) {
                        newRecordState[category].add(checkbox.value);
                    }
                    console.log('[applyPreCheckedItems] チェック適用: ' + checkbox.value);
                }
            });
        }

        // 身体タブ（身体介護）
        function renderBodyTab() {
            const tabBody = document.getElementById('tab-body');
            if (!tabBody) return;
            tabBody.innerHTML = '<h3>身体介護</h3><div class="checkbox-grid"></div>';
            const grid = tabBody.querySelector('.checkbox-grid');
            const bodyItems = categoryDetails['身体'] || [];
            bodyItems.forEach(item => {
                const itemEl = document.createElement('div');
                const isLong = longItems.includes(item) || item.length > 8;
                itemEl.className = 'checkbox-item' + (isLong ? ' full-width' : '');
                itemEl.innerHTML = `<input type="checkbox" id="body-${item}" data-category="body" value="${item}">
                                    <label for="body-${item}">${item}</label>`;
                grid.appendChild(itemEl);
            });
        }

        // 家事タブ
        function renderHouseworkTab() {
            const tabHousework = document.getElementById('tab-housework');
            if (!tabHousework) return;
            tabHousework.innerHTML = '<h3>家事</h3><div class="checkbox-grid"></div>';
            const grid = tabHousework.querySelector('.checkbox-grid');
            const houseworkItems = categoryDetails['家事'] || [];
            houseworkItems.forEach(item => {
                const itemEl = document.createElement('div');
                const isLong = longItems.includes(item) || item.length > 8;
                itemEl.className = 'checkbox-item' + (isLong ? ' full-width' : '');
                itemEl.innerHTML = `<input type="checkbox" id="housework-${item}" data-category="housework" value="${item}">
                                    <label for="housework-${item}">${item}</label>`;
                grid.appendChild(itemEl);
            });
        }

        // 必須タブ
        function renderRequiredTab() {
            const requiredGrid = document.getElementById('required-grid');
            if (!requiredGrid) return;
            requiredGrid.innerHTML = ''; // Clear previous content
            const requiredItems = categoryDetails['必須'] || [];
            requiredItems.forEach(item => {
                const itemEl = document.createElement('div');
                const isLong = longItems.includes(item) || item.length > 10;
                itemEl.className = 'checkbox-item' + (isLong ? ' full-width' : '');
                itemEl.innerHTML = `<input type="checkbox" id="required-${item}" data-category="required" value="${item}">
                                    <label for="required-${item}">${item}</label>`;
                requiredGrid.appendChild(itemEl);
            });
        }

        function renderConditionTab() {
            // Placeholder for condition tab rendering logic
            const tabCondition = document.getElementById('tab-condition');
            if (!tabCondition) return;
            tabCondition.innerHTML = `<h3>利用者の様子・バイタル</h3>
                                      <div class="vital-section">
                                          <div class="vital-row">
                                              <span class="vital-label">体温</span>
                                              <input type="number" step="0.1" id="vital-temperature" class="vital-input" placeholder="例: 36.5">
                                              <span class="vital-unit">℃</span>
                                          </div>
                                          <div class="vital-row">
                                              <span class="vital-label">血圧(上)</span>
                                              <input type="number" id="vital-systolic" class="vital-input" placeholder="例: 120">
                                              <span class="vital-unit">mmHg</span>
                                          </div>
                                          <div class="vital-row">
                                              <span class="vital-label">血圧(下)</span>
                                              <input type="number" id="vital-diastolic" class="vital-input" placeholder="例: 80">
                                              <span class="vital-unit">mmHg</span>
                                          </div>
                                      </div>`;
            // Attach event listeners for vital inputs
            tabCondition.querySelectorAll('.vital-input').forEach(input => {
                input.addEventListener('input', e => {
                    newRecordState.vital[e.target.id.replace('vital-', '')] = e.target.value;
                });
            });
        }


        // --- Utility Functions (Missing definitions) ---
        function logStamp(message, time) {
            console.log(`[${formatHM(time)}] ${message}`);
            // You might want to display this in a UI log as well
            const logEntries = document.getElementById('log-entries');
            if (logEntries) {
                const entry = document.createElement('p');
                entry.textContent = `[${formatHM(time)}] ${message}`;
                logEntries.prepend(entry); // Add to the top
            }
        }

        function formatHM(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function setText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function resetAll() {
            // Reset state or hide/show elements as needed on logout
            selectedShiftInfo = null;
            shiftsData = [];
            newRecordState.body.clear();
            newRecordState.housework.clear();
            newRecordState.required.clear();
            newRecordState.condition.clear();
            newRecordState.vital = { temperature: '', systolic: '', diastolic: '' };
            newRecordState.notes = '';
            userCheckedItems = [];
            userInstructions = '';

            // Clear displayed shift list
            const shiftList = document.getElementById('shift-list');
            if (shiftList) {
                shiftList.innerHTML = '';
            }

            // Hide precautions section
            document.getElementById('precautions-section')?.classList.add('hidden');

            // Reset service execution screen elements
            setText('customer-name', '—');
            setText('service-type', '—');
            setText('start-plan', '--:--');
            setText('end-plan', '--:--');
            setText('start-actual', '未実行');
            setText('end-actual', '未実行');
            setText('contract-customer-name', '—');
            setText('contract-service-type', '—');

            // Reset special notes textarea
            const specialNotesNew = document.getElementById('special-notes-new');
            if (specialNotesNew) {
                specialNotesNew.value = '';
            }

            // Hide all screens except login
            ['shift', 'service-exec', 'checklist', 'summary', 'history', 'contract', 'others', 'salary', 'report'].forEach(k => {
                const el = document.getElementById(k + '-screen'); if (el) el.classList.add('hidden');
            });
            document.getElementById('shift-screen-bottom-menu')?.classList.add('hidden');
            document.getElementById('global-menu')?.classList.add('hidden');

            console.log('resetAll executed.');
        }

        // ===== 完了ボタン処理を関数化 =====
        function getTodayShiftUrl() {
            // 1) URLパラメータで returnUrl が渡っていれば最優先
            const p = new URLSearchParams(location.search);
            const ru = p.get('returnUrl');
            if (ru) return ru;

            // 2) localStorage の returnUrl があればそれ
            const saved = localStorage.getItem('returnUrl');
            if (saved) return saved;

            // 3) リファラがあれば戻す（本日のシフト画面から来ている想定）
            if (document.referrer) return document.referrer;

            // 4) 最後の保険（シフト画面表示で戻る）
            return null;
        }

        function onCompleteSuccess() {
            alert('サービスが正常に終了されました');
            // alertが閉じた後に遷移
            const returnUrl = getTodayShiftUrl();
            if (returnUrl) {
                location.href = returnUrl;
            } else {
                // 内部遷移
                showScreen('shift');
            }
        }

        async function handleCompleteClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('[complete] clicked');

            // 利用者確認チェック
            const userConfirmed = document.getElementById('user-confirmed-checkbox')?.checked;
            if (!userConfirmed) {
                alert('利用者様による確認が必要です。');
                return;
            }

            try {
                // サービス記録を保存
                await saveServiceRecord();
                console.log('[complete] saveServiceRecord success');

                // 実績終了時間を記録（存在すれば）
                if (typeof recordActualTimeEnd === 'function') {
                    await recordActualTimeEnd();
                }

                // 成功処理
                onCompleteSuccess();
            } catch (err) {
                console.error('[complete] error', err);
                alert('完了処理に失敗しました: ' + (err?.message || err));
            }
        }

        function bindCompleteButton() {
            const btn = document.getElementById('complete-btn');
            if (!btn) {
                console.warn('[complete] complete-btn not found');
                return;
            }
            // 既存リスナーを削除して再設定（確実にバインド）
            btn.removeEventListener('click', handleCompleteClick);
            btn.addEventListener('click', handleCompleteClick);
            console.log('[complete] button bound');
        }

        // DOMContentLoadedでも必ずバインド（保険）
        document.addEventListener('DOMContentLoaded', bindCompleteButton);

        function initChecklist() {
            // 完了ボタンをバインド（initChecklistからも呼ぶ）
            bindCompleteButton();

            const backToServiceBtn = document.getElementById('back-to-service');
            if (backToServiceBtn && !backToServiceBtn.dataset.listenerAttached) {
                backToServiceBtn.addEventListener('click', () => showScreen('service-exec'));
                backToServiceBtn.dataset.listenerAttached = 'true';
            }
        }

        function initSummary() {
            // Placeholder for summary initialization
            const finishBtn = document.getElementById('finish-btn');
            if (finishBtn && !finishBtn.dataset.listenerAttached) {
                finishBtn.addEventListener('click', () => {
                    // Reset selected shift info and other states before returning to shift screen
                    selectedShiftInfo = null;
                    document.getElementById('precautions-section').classList.add('hidden');
                    // Reset service exec screen
                    resetServiceScreen();
                    showScreen('shift');
                });
                finishBtn.dataset.listenerAttached = 'true';
            }
        }

        function initHistory() {
            // Placeholder for history initialization
            const historyListEl = document.getElementById('history-list');
            const customerSearchInput = document.getElementById('history-customer-search');
            const dateFilterInput = document.getElementById('history-date-filter');

            // Dummy data for history for now
            const dummyHistory = [
                { id: '1', date: '2025-11-20', customerName: '山田太郎', serviceType: '身体介護', startTime: '09:00', endTime: '10:00', staff: '田中', summary: '入浴介助、着替え' },
                { id: '2', date: '2025-11-20', customerName: '鈴木花子', serviceType: '生活援助', startTime: '10:30', endTime: '11:30', staff: '田中', summary: '買い物代行、昼食準備' },
            ];

            function renderHistoryList(records) {
                if (!historyListEl) return;
                historyListEl.innerHTML = '';
                if (records.length === 0) {
                    historyListEl.innerHTML = '<p style="text-align:center;color:var(--muted);">履歴はありません。</p>';
                    return;
                }
                records.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'shift-item'; // Re-use shift-item style
                    item.style.cursor = 'default';
                    item.innerHTML = `
                        <span class="name">${record.customerName}</span>
                        <span class="time">${record.date} ${record.startTime}-${record.endTime}</span>
                        <span class="type" style="background-color:#03A9F4">${record.serviceType}</span>
                        <p style="grid-column: 1 / -1; font-size:0.85rem; color:var(--muted); margin-top:8px;">${record.summary}</p>
                    `;
                    historyListEl.appendChild(item);
                });
            }

            renderHistoryList(dummyHistory); // Initial render

            // Event listeners for filters
            if (customerSearchInput) {
                customerSearchInput.addEventListener('input', () => {
                    const searchTerm = customerSearchInput.value.toLowerCase();
                    const filtered = dummyHistory.filter(record =>
                        record.customerName.toLowerCase().includes(searchTerm)
                    );
                    renderHistoryList(filtered);
                });
            }
            if (dateFilterInput) {
                dateFilterInput.addEventListener('change', () => {
                    const selectedDate = dateFilterInput.value;
                    const filtered = dummyHistory.filter(record =>
                        record.date === selectedDate
                    );
                    renderHistoryList(filtered);
                });
            }
        }

        // 報告モーダルを開く（月間シフトと同じ方式）
        function openReportModal() {
            const frame = document.getElementById('reportFrame');

            const params = new URLSearchParams();
            // 取得できる情報をクエリパラメータで渡す
            if (selectedShiftInfo) {
                if (selectedShiftInfo.name) params.set('userName', selectedShiftInfo.name);
                if (selectedShiftInfo.staff) params.set('staffName', selectedShiftInfo.staff);
                if (selectedShiftInfo.service) params.set('serviceType', selectedShiftInfo.service);
                if (selectedShiftInfo.date) params.set('date', selectedShiftInfo.date);
            }
            if (auth.currentUser && auth.currentUser.email) {
                params.set('staffEmail', auth.currentUser.email);
            }

            const qs = params.toString();
            frame.src = `./業務報告.html${qs ? '?' + qs : ''}`;

            openModal('report-modal');
            console.log('[報告] モーダルを開きました');
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal');
            const frame = document.getElementById('reportFrame');

            if (modal) modal.classList.remove('is-open');
            frame.src = '';
            console.log('[報告] モーダルを閉じました');
        }

        // 報告画面を開く（タブ切り替え方式）
        function openReportScreen() {
            // reportContextを設定
            window.reportContext = {
                userName: selectedShiftInfo?.name || '',
                staffName: selectedShiftInfo?.staff || '',
                serviceType: selectedShiftInfo?.service || '',
                date: selectedShiftInfo?.date || '',
                staffEmail: auth.currentUser?.email || ''
            };
            window.dispatchEvent(new CustomEvent('reportContextChanged', { detail: window.reportContext }));
            console.log('[報告] reportContextを設定しました:', window.reportContext);

            // Firebaseデータをロード
            loadFirebaseDataForReport();

            // 画面表示
            showScreen('report');
            console.log('[報告] report画面を表示しました');
        }

        // シフト画面から報告画面を開く（フッター維持版）
        function showReportFromShift() {
            // reportContextを設定
            window.reportContext = {
                userName: selectedShiftInfo?.name || '',
                staffName: selectedShiftInfo?.staff || '',
                serviceType: selectedShiftInfo?.service || '',
                date: selectedShiftInfo?.date || '',
                staffEmail: auth.currentUser?.email || ''
            };
            window.dispatchEvent(new CustomEvent('reportContextChanged', { detail: window.reportContext }));
            console.log('[報告] reportContextを設定しました:', window.reportContext);

            // Firebaseデータをロード
            loadFirebaseDataForReport();

            // 全画面を非表示にする
            ['shift', 'service-exec', 'checklist', 'summary', 'history', 'contract', 'others', 'salary', 'report'].forEach(k => {
                const el = document.getElementById(k + '-screen');
                if (el) el.classList.add('hidden');
            });

            // report画面を表示
            const reportScreen = document.getElementById('report-screen');
            if (reportScreen) reportScreen.classList.remove('hidden');

            // 重要: shift-screen-bottom-menuを維持、global-menuは非表示のまま
            const shiftMenu = document.getElementById('shift-screen-bottom-menu');
            const globalMenu = document.getElementById('global-menu');
            if (shiftMenu) shiftMenu.classList.remove('hidden');
            if (globalMenu) globalMenu.classList.add('hidden');

            console.log('[報告] report画面を表示しました（シフトメニュー維持）');
        }

        // report用Firebaseデータ取得
        async function loadFirebaseDataForReport() {
            if (!auth.currentUser) {
                console.warn('[loadFirebaseDataForReport] ログインユーザーが存在しません');
                return;
            }

            try {
                console.log('[loadFirebaseDataForReport] データ取得開始');

                // 報告者名取得
                let reporterName = auth.currentUser.email;
                try {
                    const emailDoc = await db.collection('allowedEmails').doc(auth.currentUser.email).get();
                    if (emailDoc.exists && emailDoc.data().name) {
                        reporterName = emailDoc.data().name;
                    }
                } catch (e) {
                    console.warn('[loadFirebaseDataForReport] allowedEmails取得エラー:', e);
                }
                console.log('[loadFirebaseDataForReport] 報告者名:', reporterName);

                // 利用者リスト取得
                const riyousyaList = [];
                try {
                    const riyousyaSnapshot = await db.collection('riyousya').get();
                    riyousyaSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.name) riyousyaList.push({ id: doc.id, name: data.name, kana: data.kana || '' });
                    });
                } catch (e) {
                    console.warn('[loadFirebaseDataForReport] riyousya取得エラー:', e);
                }
                console.log('[loadFirebaseDataForReport] 利用者リスト:', riyousyaList.length, '件');

                // 従業員リスト取得 (usesコレクション)
                const employeeList = [];
                try {
                    const employeeSnapshot = await db.collection('uses').get();
                    employeeSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.name) employeeList.push({ id: doc.id, name: data.name });
                    });
                } catch (e) {
                    console.warn('[loadFirebaseDataForReport] uses取得エラー:', e);
                }
                console.log('[loadFirebaseDataForReport] 従業員リスト:', employeeList.length, '件');

                // グローバル変数とイベント発火
                window.firebaseData = { reporterName, riyousyaList, employeeList, isLoading: false };
                window.dispatchEvent(new CustomEvent('firebaseDataLoaded', { detail: window.firebaseData }));
                console.log('[loadFirebaseDataForReport] firebaseDataLoadedイベントを発火しました');
            } catch (error) {
                console.error('[loadFirebaseDataForReport] エラー:', error);
                window.dispatchEvent(new CustomEvent('firebaseDataError', { detail: { error: error.message } }));
            }
        }

        function initMenu() {
            // Placeholder for menu initialization
            const dockItems = document.querySelectorAll('.dock-item');
            dockItems.forEach(item => {
                if (!item.dataset.listenerAttached) {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const screenName = item.id.replace('dock-', '');
                        console.log('[initMenu] dock-item clicked:', screenName);
                        // 報告タブの場合はreport画面を開く
                        if (screenName === 'report') {
                            console.log('[initMenu] 報告タブがクリックされました - report画面を開きます');
                            openReportScreen();
                        } else {
                            showScreen(screenName === 'exec' ? 'service-exec' : screenName);
                        }
                    });
                    item.dataset.listenerAttached = 'true';
                }
            });

            // Accordion functionality for contract screen
            document.querySelectorAll('.accordion-header').forEach(header => {
                if (!header.dataset.listenerAttached) {
                    header.addEventListener('click', () => {
                        const targetId = header.dataset.target;
                        const targetContent = document.getElementById(targetId);
                        const isExpanded = header.getAttribute('aria-expanded') === 'true';

                        header.setAttribute('aria-expanded', !isExpanded);
                        if (targetContent) {
                            if (!isExpanded) {
                                targetContent.style.display = 'block'; // Ensure it's visible for height calculation
                                targetContent.style.maxHeight = targetContent.scrollHeight + 'px';
                            } else {
                                targetContent.style.maxHeight = '0';
                                targetContent.addEventListener('transitionend', function handler() {
                                    targetContent.style.display = 'none';
                                    targetContent.removeEventListener('transitionend', handler);
                                }, { once: true });
                            }
                        }
                    });
                    header.dataset.listenerAttached = 'true';
                }
            });
        }

        function initModals() {
            // Placeholder for modal initialization
            document.querySelectorAll('.modal .close').forEach(button => {
                if (!button.dataset.listenerAttached) {
                    button.addEventListener('click', () => {
                        const modal = button.closest('.modal');
                        if (modal) modal.classList.remove('is-open');
                    });
                    button.dataset.listenerAttached = 'true';
                }
            });
            document.querySelectorAll('[data-close-modal]').forEach(button => {
                if (!button.dataset.listenerAttached) {
                    button.addEventListener('click', () => {
                        const modalId = button.dataset.closeModal;
                        const modal = document.getElementById(modalId);
                        if (modal) modal.classList.remove('is-open');
                    });
                    button.dataset.listenerAttached = 'true';
                }
            });

            // Monthly Shift Modal specific close button
            const closeMonthlyShiftBtn = document.getElementById('close-monthly-shift');
            if (closeMonthlyShiftBtn && !closeMonthlyShiftBtn.dataset.listenerAttached) {
                closeMonthlyShiftBtn.addEventListener('click', () => {
                    const modal = document.getElementById('monthly-shift-modal');
                    if (modal) modal.classList.remove('is-open');
                });
                closeMonthlyShiftBtn.dataset.listenerAttached = 'true';
            }

            // 報告モーダルの閉じるボタン
            const closeReportBtn = document.getElementById('close-report-modal');
            if (closeReportBtn && !closeReportBtn.dataset.listenerAttached) {
                closeReportBtn.addEventListener('click', () => {
                    closeReportModal();
                });
                closeReportBtn.dataset.listenerAttached = 'true';
            }
        }

        function resetServiceScreen() {
            // Reset all selections and inputs in the service execution screen
            newRecordState.body.clear();
            newRecordState.housework.clear();
            newRecordState.required.clear();
            newRecordState.condition.clear();
            newRecordState.vital = { temperature: '', systolic: '', diastolic: '' };
            newRecordState.notes = '';

            document.querySelectorAll('.checkbox-item').forEach(item => item.classList.remove('checked'));
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            document.querySelectorAll('.vital-input').forEach(input => input.value = '');
            const specialNotesNew = document.getElementById('special-notes-new');
            if (specialNotesNew) specialNotesNew.value = '';

            // Reset tab active state
            document.querySelectorAll('.tab-btn').forEach((btn, index) => {
                if (index === 0) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach((content, index) => {
                if (index === 0) content.classList.add('active');
                else content.classList.remove('active');
            });

            setText('start-actual', '未実行');
            setText('end-actual', '未実行');
            logStamp('サービス画面リセット', new Date());
        }

        function buildNewConfirmation() {
            const confirmationBody = document.getElementById('confirmation-body');
            if (!confirmationBody) return;
            confirmationBody.innerHTML = ''; // Clear previous content

            // 選択されたチェック項目をまとめる
            const selectedItems = [];
            for (const category in newRecordState) {
                if (newRecordState[category] instanceof Set) {
                    newRecordState[category].forEach(item => selectedItems.push(item));
                }
            }

            // バイタル情報を追加
            const vitalEntries = [];
            if (newRecordState.vital.temperature) vitalEntries.push(`体温: ${newRecordState.vital.temperature}℃`);
            if (newRecordState.vital.systolic && newRecordState.vital.diastolic) vitalEntries.push(`血圧: ${newRecordState.vital.systolic}/${newRecordState.vital.diastolic}mmHg`);
            if (vitalEntries.length > 0) selectedItems.push(`バイタル: ${vitalEntries.join(', ')}`);

            // 特記事項を追加
            if (newRecordState.notes) {
                selectedItems.push(`特記事項: ${newRecordState.notes}`);
            }

            // 確認画面に表示
            if (selectedItems.length > 0) {
                const confirmSection = document.createElement('div');
                confirmSection.className = 'confirm-section';
                confirmSection.innerHTML = `<h3 class="confirm-title">実施項目</h3>`;
                const confirmItemsDiv = document.createElement('div');
                confirmItemsDiv.className = 'confirm-items';
                selectedItems.forEach(item => {
                    const span = document.createElement('span');
                    span.className = 'confirm-tag';
                    span.textContent = item;
                    confirmItemsDiv.appendChild(span);
                });
                confirmSection.appendChild(confirmItemsDiv);
                confirmationBody.appendChild(confirmSection);
            } else {
                confirmationBody.innerHTML = `<p style="text-align:center;color:var(--muted);">選択された項目はありません。</p>`;
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('is-open');
                // Optional: add logic specific to monthly-shift-modal when opened
                if (modalId === 'monthly-shift-modal') {
                    // Assuming you have a function to load monthly shifts
                    // loadMonthlyShifts(new Date().getFullYear(), new Date().getMonth() + 1);
                    document.getElementById('monthly-shift-loading').style.display = 'block';
                    document.getElementById('monthly-shift-content').style.display = 'none';
                    setTimeout(() => { // Simulate loading
                        document.getElementById('monthly-shift-loading').style.display = 'none';
                        document.getElementById('monthly-shift-content').style.display = 'block';
                        document.getElementById('monthly-shift-list').innerHTML = '<p style="padding:20px;text-align:center;">月間シフトデータはまだ実装されていません。</p>';
                    }, 1000);
                }
            }
        }

        async function saveServiceRecord() {
            if (!selectedShiftInfo || !auth.currentUser) {
                console.error('保存に必要な情報が不足しています。');
                alert('保存に必要な情報が不足しています。');
                throw new Error('保存情報不足');
            }

            const serviceRecord = {
                staffEmail: auth.currentUser.email,
                staffName: selectedShiftInfo.staff,
                customerName: selectedShiftInfo.name,
                date: selectedShiftInfo.date,
                serviceType: selectedShiftInfo.service,
                startPlan: selectedShiftInfo.time.split(' - ')[0],
                endPlan: selectedShiftInfo.time.split(' - ')[1],
                startActual: document.getElementById('start-actual').textContent,
                endActual: document.getElementById('end-actual').textContent,
                selectedDetails: Array.from(newRecordState.body)
                    .concat(Array.from(newRecordState.housework))
                    .concat(Array.from(newRecordState.required))
                    .concat(Array.from(newRecordState.condition)),
                vitalData: newRecordState.vital,
                specialNotes: newRecordState.notes,
                instructions: userInstructions, // サービス開始時の指示内容
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            console.log('保存するサービス記録:', serviceRecord);

            try {
                // Firestoreに保存
                const docRef = await db.collection('serviceRecords').add(serviceRecord);
                console.log('サービス記録をFirestoreに保存しました:', docRef.id);

                // Realtime Databaseにも保存（互換性のため）
                if (realtimeDB) {
                    const timestampKey = new Date().toISOString().replace(/[:.]/g, '-'); // ユニークなキーを生成
                    await realtimeDB.ref(`serviceRecords/${timestampKey}`).set(serviceRecord);
                    console.log('サービス記録をRealtime Databaseに保存しました:', timestampKey);
                }

                alert('サービス記録を保存しました！');
                return docRef.id;
            } catch (error) {
                console.error('サービス記録の保存エラー:', error);
                throw error;
            }
        }

        // --- Event Listeners for newRecordState updates ---
        document.addEventListener('change', (e) => {
            if (e.target.matches('.tab-content input[type="checkbox"]')) {
                const category = e.target.dataset.category;
                if (category && newRecordState[category]) {
                    if (e.target.checked) {
                        newRecordState[category].add(e.target.value);
                    } else {
                        newRecordState[category].delete(e.target.value);
                    }
                    console.log(`newRecordState.${category}:`, newRecordState[category]);
                }
            }
        });

        // Initial rendering of tabs (if any items are initially selected)
        renderAllTabs(); // Called on DOMContentLoaded via initService()

        // ===== 実績時間記録機能 =====
        // magnetIdの取得
        function getMagnetId() {
            const p = new URLSearchParams(location.search);
            return p.get('magnetId') || localStorage.getItem('currentMagnetId') || '';
        }

        // startAtを記録（未設定の場合のみ）
        async function recordActualTimeStart() {
            const magnetId = getMagnetId();
            if (!magnetId) {
                console.warn('magnetIdが取得できないため、開始時間を記録できません。');
                return;
            }
            try {
                const ref = db.collection('serviceActualTimes').doc(magnetId);
                const snap = await ref.get();
                const now = new Date().toISOString();
                if (!snap.exists || !(snap.data() || {}).startAt) {
                    await ref.set({ startAt: now, updatedAt: now }, { merge: true });
                    console.log('実績開始時間を記録しました:', magnetId, now);
                } else {
                    await ref.set({ updatedAt: now }, { merge: true });
                    console.log('実績開始時間は既に記録済みです:', magnetId);
                }
            } catch (e) {
                console.error('実績開始時間の記録エラー:', e);
            }
        }

        // endAtを記録
        async function recordActualTimeEnd() {
            const magnetId = getMagnetId();
            if (!magnetId) {
                console.warn('magnetIdが取得できないため、終了時間を記録できません。');
                return;
            }
            try {
                const ref = db.collection('serviceActualTimes').doc(magnetId);
                const now = new Date().toISOString();
                await ref.set({ endAt: now, updatedAt: now }, { merge: true });
                console.log('実績終了時間を記録しました:', magnetId, now);
            } catch (e) {
                console.error('実績終了時間の記録エラー:', e);
            }
        }

        // ボタンにイベントリスナーを追加（テキストで検出）
        function bindActualTimeRecording() {
            // 開始ボタン
            const btns = Array.from(document.querySelectorAll('button, input[type="button"], input[type="submit"]'));
            btns.forEach(btn => {
                const t = (btn.textContent || btn.value || '').trim();
                if (!btn.dataset.actualTimeListenerAttached) {
                    if (t.includes('開始') || btn.id === 'start-service-btn') {
                        btn.addEventListener('click', recordActualTimeStart);
                        btn.dataset.actualTimeListenerAttached = 'true';
                    }
                    if (t.includes('完了')) {
                        btn.addEventListener('click', recordActualTimeEnd);
                        btn.dataset.actualTimeListenerAttached = 'true';
                    }
                }
            });
        }

        // DOMContentLoaded後にバインド
        document.addEventListener('DOMContentLoaded', bindActualTimeRecording);
        // 動的にボタンが追加される場合のためにも再バインド
        setTimeout(bindActualTimeRecording, 1000);
        setTimeout(bindActualTimeRecording, 3000);
    </script>

    <!-- 報告モーダル（月間シフトと同じ方式） -->
    <div id="report-modal" class="modal">
        <div class="sheet"
            style="position:relative;width:95%;max-width:900px;background:#fff;border-radius:16px;padding:0;box-shadow:0 10px 40px rgba(0,0,0,.3);height:90vh;max-height:90vh;overflow:hidden;">
            <button class="close" id="close-report-modal"
                style="position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.6);border:none;font-size:24px;cursor:pointer;color:#fff;z-index:10001;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);">&times;</button>
            <iframe id="reportFrame" src="" title="業務報告"
                style="width:100%;height:100%;border:0;border-radius:16px;"></iframe>
        </div>
    </div>

    <!-- 報告React埋め込み (デモ版では除外) -->
    <!-- <script type="text/babel" src="./report-app.js"></script> -->
</body>

</html>